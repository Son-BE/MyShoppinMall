<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head></head>
<body>

<!-- AI 추천 성공 결과 -->
<div th:fragment="ai-results" class="ai-recommend-section">
  <div class="ai-result-header">
    <h3>
      <i class="fa-solid fa-wand-magic-sparkles"></i>
      AI 스타일 추천 결과
    </h3>
    <div class="ai-confidence-indicator">
      <div class="confidence-bar">
        <div class="confidence-fill"
             th:style="'width: ' + ${confidence * 100} + '%'"
             th:classappend="${confidence > 0.7} ? 'high-confidence' : (${confidence > 0.4} ? 'medium-confidence' : 'low-confidence')">
        </div>
      </div>
      <span class="confidence-text"
            th:text="'추천 정확도: ' + ${#numbers.formatDecimal(confidence * 100, 0, 0)} + '%'"></span>
    </div>
  </div>

  <div class="ai-explanation">
    <div class="query-analysis">
      <h4><i class="fa-solid fa-search"></i> 분석 결과</h4>
      <div class="analysis-content">
        <div class="original-query">
          <strong>요청:</strong> <span th:text="${query}"></span>
        </div>
        <div class="extracted-entities" th:if="${!entities.isEmpty()}">
          <strong>분석된 조건:</strong>
          <div class="entity-tags">
                        <span th:each="entity : ${entities}"
                              class="entity-tag"
                              th:classappend="${entity.key}"
                              th:text="${entity.value}"></span>
          </div>
        </div>
        <div class="explanation-text" th:text="${explanation}"></div>
      </div>
    </div>
  </div>

  <!-- 추천 상품 그리드 -->
  <div class="ai-products-grid" th:if="${!#lists.isEmpty(items)}">
    <div th:each="item : ${items}" class="ai-product-card">
      <div class="product-image">
        <a th:href="@{/items/detail/{id}(id=${item.id})}">
          <img th:src="${item.imagePath}"
               onerror="this.src='/images/default.png'"
               th:alt="${item.itemName} + ' 상품 이미지'"/>
          <div class="product-overlay">
            <div class="match-score"
                 th:text="'매치도 ' + ${#numbers.formatDecimal(item.matchScore * 100, 0, 0)} + '%'"></div>
          </div>
        </a>

        <div class="card-actions">
          <!-- 찜하기 버튼 -->
          <form th:action="@{/wishList/add}" method="post">
            <input type="hidden" name="itemId" th:value="${item.id}"/>
            <div th:if="${_csrf != null}">
              <input type="hidden"
                     th:name="${_csrf.parameterName}"
                     th:value="${_csrf.token}" />
            </div>
            <button type="submit" class="action-button wishlist" title="찜하기">
              <i class="fa-regular fa-heart"></i>
            </button>
          </form>

          <!-- 장바구니 버튼 -->
          <form th:action="@{/user/cart/add}" method="post">
            <input type="hidden" name="itemId" th:value="${item.id}"/>
            <input type="hidden" name="quantity" value="1"/>
            <div th:if="${_csrf != null}">
              <input type="hidden"
                     th:name="${_csrf.parameterName}"
                     th:value="${_csrf.token}" />
            </div>
            <button type="submit" class="action-button cart" title="장바구니">
              <i class="fa-solid fa-cart-shopping"></i>
            </button>
          </form>
        </div>
      </div>

      <div class="product-info">
        <p class="brand-name">SonStarMade</p>
        <h4 class="product-name" th:text="${item.itemName}"></h4>
        <p class="product-price"
           th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + '원'"></p>
        <div class="match-reason" th:if="${item.matchReason}">
          <i class="fa-solid fa-check-circle"></i>
          <span th:text="${item.matchReason}"></span>
        </div>
      </div>

      <!-- 피드백 버튼들 -->
      <div class="feedback-buttons">
        <button class="feedback-btn positive"
                th:onclick="'submitFeedback(\'' + ${query} + '\', ' + ${item.id} + ', \'positive\')'">
          <i class="fa-solid fa-thumbs-up"></i>
        </button>
        <button class="feedback-btn negative"
                th:onclick="'submitFeedback(\'' + ${query} + '\', ' + ${item.id} + ', \'negative\')'">
          <i class="fa-solid fa-thumbs-down"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- 추천 개선 팁 -->
  <div class="ai-tips" th:if="${confidence < 0.7}">
    <h4><i class="fa-solid fa-lightbulb"></i> 더 정확한 추천을 위한 팁</h4>
    <ul>
      <li>구체적인 상황을 알려주세요 (예: "20대 여성 캐주얼 데이트룩")</li>
      <li>선호하는 색상이나 스타일을 언급해보세요</li>
      <li>가격대를 명시하면 더 맞춤형 추천이 가능합니다</li>
      <li>계절이나 날씨를 고려한 요청도 도움이 됩니다</li>
    </ul>
  </div>

  <!-- 관련 검색어 제안 -->
  <div class="related-suggestions" th:if="${!#lists.isEmpty(entities)}">
    <h4><i class="fa-solid fa-tags"></i> 관련 검색어</h4>
    <div class="suggestion-tags">
            <span class="suggestion-tag"
                  th:each="entity : ${entities}"
                  th:onclick="'document.getElementById(\'ai-query\').value=\'' + ${entity.value} + ' 추천\'; requestAiRecommend();'">
                <span th:text="${entity.value}"></span>
                <i class="fa-solid fa-plus"></i>
            </span>
    </div>
  </div>
</div>

<!-- AI 추천 오류 결과 -->
<div th:fragment="ai-error" class="ai-recommend-section error">
  <div class="error-content">
    <i class="fa-solid fa-exclamation-triangle"></i>
    <h3>AI 추천 서비스 일시 중단</h3>
    <p th:text="${errorMessage}"></p>
    <div class="error-actions">
      <button onclick="requestAiRecommend()" class="retry-button">
        <i class="fa-solid fa-redo"></i>
        다시 시도
      </button>
      <button onclick="document.getElementById('ai-recommend-list').style.display='none'"
              class="close-button">
        닫기
      </button>
    </div>
  </div>
</div>

<style>
  .ai-recommend-section {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: var(--radius-xl);
    padding: 3rem;
    margin: 2rem 0;
    box-shadow: var(--shadow-xl);
    border: 1px solid rgba(255, 255, 255, 0.2);
    animation: slideInFromBottom 0.5s ease;
  }

  @keyframes slideInFromBottom {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .ai-result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .ai-result-header h3 {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
  }

  .ai-confidence-indicator {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .confidence-bar {
    width: 120px;
    height: 8px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    overflow: hidden;
  }

  .confidence-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.6s ease;
  }

  .confidence-fill.high-confidence {
    background: linear-gradient(90deg, #4CAF50, #66BB6A);
  }

  .confidence-fill.medium-confidence {
    background: linear-gradient(90deg, #FF9800, #FFB74D);
  }

  .confidence-fill.low-confidence {
    background: linear-gradient(90deg, #F44336, #EF5350);
  }

  .confidence-text {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-secondary);
  }

  .ai-explanation {
    background: rgba(0, 112, 243, 0.05);
    border-radius: var(--radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
  }

  .query-analysis h4 {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: var(--text-primary);
  }

  .analysis-content > div {
    margin-bottom: 1rem;
  }

  .original-query {
    font-size: 1rem;
    color: var(--text-primary);
  }

  .entity-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .entity-tag {
    background: var(--primary-color);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
  }

  .entity-tag.gender {
    background: #E91E63;
  }

  .entity-tag.style {
    background: #9C27B0;
  }

  .entity-tag.occasion {
    background: #FF9800;
  }

  .entity-tag.category {
    background: #4CAF50;
  }

  .explanation-text {
    font-size: 1.1rem;
    color: var(--text-primary);
    font-weight: 500;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.7);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--primary-color);
  }

  .ai-products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 2rem;
    margin: 2rem 0;
  }

  .ai-product-card {
    background: rgba(255, 255, 255, 0.9);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all 0.4s ease;
    position: relative;
    border: 2px solid transparent;
  }

  .ai-product-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: var(--shadow-xl);
    border-color: var(--primary-color);
  }

  .ai-product-card .product-image {
    position: relative;
    height: 300px;
    overflow: hidden;
  }

  .ai-product-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s ease;
  }

  .ai-product-card:hover img {
    transform: scale(1.05);
  }

  .product-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(0, 112, 243, 0.1), rgba(124, 58, 237, 0.1));
    opacity: 0;
    transition: opacity 0.3s ease;
    display: flex;
    align-items: flex-end;
    padding: 1rem;
  }

  .ai-product-card:hover .product-overlay {
    opacity: 1;
  }

  .match-score {
    background: rgba(255, 255, 255, 0.9);
    color: var(--primary-color);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 0.875rem;
    backdrop-filter: blur(10px);
  }

  .match-reason {
    background: rgba(76, 175, 80, 0.1);
    color: #4CAF50;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .feedback-buttons {
    display: flex;
    gap: 0.5rem;
    padding: 1rem;
    justify-content: center;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .feedback-btn {
    border: none;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 50%;
    width: 36px;
    height: 36px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .feedback-btn.positive:hover {
    background: #4CAF50;
    color: white;
  }

  .feedback-btn.negative:hover {
    background: #F44336;
    color: white;
  }

  .ai-tips {
    background: rgba(255, 193, 7, 0.1);
    border-radius: var(--radius-lg);
    padding: 2rem;
    margin-top: 2rem;
    border-left: 4px solid #FFC107;
  }

  .ai-tips h4 {
    color: #F57F17;
    margin-bottom: 1rem;
  }

  .ai-tips ul {
    list-style: none;
    padding: 0;
  }

  .ai-tips li {
    padding: 0.5rem 0;
    position: relative;
    padding-left: 1.5rem;
  }

  .ai-tips li:before {
    content: '💡';
    position: absolute;
    left: 0;
  }

  .related-suggestions {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .related-suggestions h4 {
    margin-bottom: 1rem;
    color: var(--text-primary);
  }

  .suggestion-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .suggestion-tag {
    background: rgba(124, 58, 237, 0.1);
    color: var(--accent-color);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border: 1px solid rgba(124, 58, 237, 0.2);
  }

  .suggestion-tag:hover {
    background: var(--accent-color);
    color: white;
    transform: translateY(-2px);
  }

  .ai-recommend-section.error {
    text-align: center;
    padding: 4rem;
  }

  .error-content i {
    font-size: 4rem;
    color: #FF9800;
    margin-bottom: 1rem;
  }

  .error-content h3 {
    color: var(--text-primary);
    margin-bottom: 1rem;
  }

  .error-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
  }

  .retry-button, .close-button {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .retry-button {
    background: var(--primary-color);
    color: white;
  }

  .retry-button:hover {
    background: var(--primary-hover);
    transform: translateY(-2px);
  }

  .close-button {
    background: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
  }

  .close-button:hover {
    background: rgba(0, 0, 0, 0.2);
  }

  @media (max-width: 768px) {
    .ai-products-grid {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }

    .ai-result-header {
      flex-direction: column;
      text-align: center;
    }

    .suggestion-tags, .entity-tags {
      justify-content: center;
    }
  }
</style>

</body>
</html>