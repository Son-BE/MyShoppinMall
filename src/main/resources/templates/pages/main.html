<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SonStarMall - 홈</title>

  <!-- Font Awesome & Google Font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        crossorigin="anonymous"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="/css/main.css">
</head>

<body>
<!-- 헤더 -->
<header class="header">
    <div class="header-content">
      <button class="mobile-menu-toggle" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
      </button>

    <!-- 로고 클릭 시 홈으로 이동 -->
    <h1 class="logo" th:onclick="|window.location.href='/'|" tabindex="0" role="button" aria-label="홈으로 이동">
      SonStarMall
    </h1>

    <div class="header-search">
      <div style="position: relative;">
        <i class="fa-solid fa-search search-icon"></i>
        <input type="text" class="search-input" placeholder="상품을 검색하세요..." onkeypress="if(event.key==='Enter') window.location.href='/items?search=' + encodeURIComponent(this.value)">
      </div>
    </div>

    <div class="header-actions">
      <!-- Authenticated User -->
      <div th:if="${#authorization.expression('isAuthenticated()')}" class="user-info">
        <a th:href="@{/user/cart}" class="auth-button" aria-label="장바구니">
          <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
          장바구니
        </a>

        <a th:href="@{/user/wishList}" class="auth-button" aria-label="찜 목록">
          <i class="fa-solid fa-heart" aria-hidden="true"></i>
          찜 목록
        </a>

        <a th:href="@{/members/profile}" class="auth-button" aria-label="프로필 페이지 이동">
          <i class="fa-solid fa-user" aria-hidden="true"></i>
          <span th:text="${#authentication.name}"></span>
        </a>

        <form th:action="@{/logout}" method="post" style="display:inline;">
          <div th:if="${_csrf != null}">
            <input type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}" />
          </div>
          <button type="submit" class="auth-button logout-button" aria-label="로그아웃">
            <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>
            로그아웃
          </button>
        </form>
      </div>

      <!-- Guest User -->
      <div th:if="${!#authorization.expression('isAuthenticated()')}" class="user-info">
        <a th:href="@{/login}" class="auth-button" aria-label="로그인">
          <i class="fa-solid fa-right-to-bracket" aria-hidden="true"></i>
          로그인
        </a>
        <a th:href="@{/signup}" class="auth-button" aria-label="회원가입">
          <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
          회원가입
        </a>
      </div>
    </div>
  </div>
</header>

<!-- 메인 레이아웃 -->
<div class="main-layout">
  <!-- 사이드바 -->
  <aside class="sidebar" id="sidebar">
    <!-- 네비게이션 -->
    <div class="sidebar-section">
      <h3 class="sidebar-title">
        <i class="fa-solid fa-compass"></i>
        메뉴
      </h3>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="/" class="nav-link active">
            <i class="fa-solid fa-house"></i>
            홈
          </a>
        </li>
        <li class="nav-item">
          <a href="/items" class="nav-link">
            <i class="fa-solid fa-box"></i>
            전체 상품
          </a>
        </li>
        <li class="nav-item">
          <a href="/orders/myOrder" class="nav-link">
            <i class="fa-solid fa-receipt"></i>
            주문 내역
          </a>
        </li>
        <li class="nav-item">
          <a href="/board?category=NOTICE" class="nav-link">
            <i class="fa-solid fa-comments"></i>
            게시판
          </a>
        </li>
      </ul>
    </div>

    <!-- 필터 섹션 - 기존 필터 폼 구조 유지 -->
    <div class="sidebar-section">
      <h3 class="sidebar-title">
        <i class="fa-solid fa-filter"></i>
        필터
      </h3>

      <form method="get" action="/" class="filter-form-sidebar">
        <div class="filter-group">
          <div class="filter-label">성별</div>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" name="gender" value="MALE" id="male" th:checked="${selectedGender == 'MALE'}"/>
              <label for="male">남성</label>
            </div>
            <div class="radio-option">
              <input type="radio" name="gender" value="FEMALE" id="female" th:checked="${selectedGender == 'FEMALE'}"/>
              <label for="female">여성</label>
            </div>
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-label">정렬</div>
          <select name="sort" class="select-box">
            <option value="latest" th:selected="${selectedSort == 'latest'}">최신 등록 상품</option>
            <option value="price low" th:selected="${selectedSort == 'price low'}">가격 낮은순</option>
            <option value="price high" th:selected="${selectedSort == 'price high'}">가격 높은순</option>
            <option value="score high" th:selected="${selectedSort == 'score high'}" disabled>평점 높은순</option>
            <option value="most reviews" th:selected="${selectedSort == 'most reviews'}" disabled>리뷰 많은순</option>
            <option value="popular" th:selected="${selectedSort == 'popular'}" disabled>인기순</option>
          </select>
        </div>

        <div class="filter-group">
          <div class="filter-label">카테고리</div>
          <select name="category" class="select-box">
            <option value="">전체 카테고리</option>
            <optgroup label="상의">
              <option value="hoodie" th:selected="${selectedCategory == 'hoodie'}">후드티</option>
              <option value="tshirt" th:selected="${selectedCategory == 'tshirt'}">티셔츠</option>
              <option value="sweatshirt" th:selected="${selectedCategory == 'sweatshirt'}">맨투맨</option>
            </optgroup>
            <optgroup label="아우터">
              <option value="windbreaker" th:selected="${selectedCategory == 'windbreaker'}">바람막이</option>
              <option value="coat" th:selected="${selectedCategory == 'coat'}">코트</option>
              <option value="padding" th:selected="${selectedCategory == 'padding'}">패딩</option>
            </optgroup>
            <optgroup label="하의">
              <option value="jogger_pants" th:selected="${selectedCategory == 'jogger_pants'}">조거팬츠</option>
              <option value="training_pants" th:selected="${selectedCategory == 'training_pants'}">트레이닝 바지</option>
              <option value="jeans" th:selected="${selectedCategory == 'jeans'}">청바지</option>
            </optgroup>
            <optgroup label="신발">
              <option value="sneakers" th:selected="${selectedCategory == 'sneakers'}">스니커즈</option>
              <option value="running_shoes" th:selected="${selectedCategory == 'running_shoes'}">운동화</option>
              <option value="boots" th:selected="${selectedCategory == 'boots'}">구두</option>
            </optgroup>
            <optgroup label="악세서리">
              <option value="watch" th:selected="${selectedCategory == 'watch'}">시계</option>
              <option value="ring" th:selected="${selectedCategory == 'ring'}">반지</option>
              <option value="necklace" th:selected="${selectedCategory == 'necklace'}">목걸이</option>
            </optgroup>
          </select>
        </div>

        <button type="submit" class="apply-button">
          <i class="fa-solid fa-search"></i>
          필터 적용
        </button>
      </form>
    </div>

    <!-- 최근 본 상품 -->
    <div class="sidebar-section">
      <h3 class="sidebar-title">
        <i class="fa-solid fa-clock-rotate-left"></i>
        최근 본 상품
      </h3>
      <div class="recent-items" id="recent-items-container">
        <!-- JavaScript로 동적 생성 -->
      </div>
    </div>
  </aside>

  <!-- 메인 콘텐츠 -->
  <main class="main-content main-page">
    <!-- Alert Messages -->
    <div th:if="${successMessage}">
      <script>
        alert('[[${successMessage}]]');
      </script>
    </div>
    <div th:if="${errorMessage}">
      <script>
        alert('[[${errorMessage}]]');
      </script>
    </div>
    <div th:if="${param.expired}" class="alert" role="alert">
      토큰이 만료되었습니다. 다시 로그인해주세요.
    </div>

    <!-- AI Search Section -->
    <section class="hero-compact animate-fade-in">
      <h2 class="ai-search-title">AI 스타일 어시스턴트</h2>
      <p class="ai-search-subtitle">원하는 스타일을 설명해주세요. AI가 완벽한 코디를 추천해드립니다.</p>
      <div class="ai-search-container">
        <input type="text" id="ai-query" class="ai-search-input"
               placeholder="예: 캐주얼한 데이트룩을 추천해주세요" />
        <button onclick="requestAiRecommend()" class="ai-search-button">
          <i class="fa-solid fa-wand-magic-sparkles"></i>
          AI 추천
        </button>
      </div>
    </section>

    <!-- AI Recommendations Display -->
    <div id="ai-recommend-list" class="ai-recommend-section" style="display: none;">
      <!-- AI recommendations will be displayed here -->
    </div>

    <!-- 개인화 추천 섹션 -->
    <section class="recommend-section"
             th:if="${personalizedItems != null and not #lists.isEmpty(personalizedItems)}">
      <h3><i class="fa-solid fa-user-check"></i> 당신만을 위한 맞춤 추천</h3>
      <div class="recommend-cards">
        <div th:each="item : ${personalizedItems}" class="card">
          <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
            <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                 alt="추천 상품 이미지"
                 onerror="this.src='/images/default.png'" />
          </a>
          <div class="item-name" th:text="${item.itemName != null ? item.itemName : item.name}"></div>
          <div class="price" th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}원|"></div>
          <div class="reason" th:text="${item.recommendationReason ?: '맞춤 추천'}"></div>
        </div>
      </div>
    </section>

    <!-- 실시간 추천 섹션 -->
    <section class="recommend-section"
             th:if="${realtimeItems != null and not #lists.isEmpty(realtimeItems)}">
      <h3><i class="fa-solid fa-bolt"></i> 실시간 인기 추천</h3>
      <div class="recommend-cards">
        <div th:each="item : ${realtimeItems}" class="card">
          <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
            <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                 alt="실시간 추천 상품 이미지"
                 onerror="this.src='/images/default.png'" />
          </a>
          <div class="item-name" th:text="${item.itemName != null ? item.itemName : item.name}"></div>
          <div class="price" th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}원|"></div>
          <div class="reason" th:text="${item.recommendationReason ?: '실시간 인기'}"></div>
        </div>
      </div>
    </section>

    <!--  인기 상품 섹션 -->
    <section class="recommend-section"
             th:if="${popularItems != null and not #lists.isEmpty(popularItems)}">
      <h3><i class="fa-solid fa-fire"></i> 지금 가장 인기 있는 상품</h3>
      <div class="recommend-cards">
        <div th:each="item : ${popularItems}" class="card">
          <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
            <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                 alt="인기 상품 이미지"
                 onerror="this.src='/images/default.png'" />
          </a>
          <div class="item-name" th:text="${item.itemName != null ? item.itemName : item.name}"></div>
          <div class="price" th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}원|"></div>
          <div class="reason" th:text="${item.recommendationReason ?: '인기 상품'}"></div>
        </div>
      </div>
    </section>

    <!-- Products Section (필터링된 결과) -->
    <section class="products-section" th:if="${items != null}">
      <div class="section-header">
        <h3><i class="fa-solid fa-grid-2"></i> 상품 목록</h3>
        <a href="/items" class="view-all-link">
          전체 보기 <i class="fa-solid fa-arrow-right"></i>
        </a>
      </div>

      <div th:if="${#lists.isEmpty(items)}" class="no-products">
        <i class="fa-solid fa-box-open"></i>
        <h3>해당 조건의 상품이 없습니다</h3>
        <p>다른 필터 조건을 선택해보세요.</p>
      </div>

      <div class="products-grid" th:unless="${#lists.isEmpty(items)}">
        <div th:each="item : ${items}" class="product-card">
          <div class="product-image">
            <a th:href="@{/items/detail/{id}(id=${item.id})}">
              <img th:src="${item.imagePath}" onerror="this.src='/images/default.png'"
                   th:alt="${item.itemName} + ' 상품 이미지'"/>
              <div class="product-overlay"></div>
            </a>

            <div class="card-actions">
              <!-- Wishlist Button -->
              <form th:action="@{/wishList/add}" method="post" onsubmit="return confirmAddToWishlist()">
                <input type="hidden" name="itemId" th:value="${item.id}"/>
                <div th:if="${_csrf != null}">
                  <input type="hidden"
                         th:name="${_csrf.parameterName}"
                         th:value="${_csrf.token}" />
                </div>

                <button type="submit" class="action-button wishlist"
                        th:disabled="${item.quantity == 0}" title="찜하기">
                  <i class="fa-heart" th:classappend="${item.isWish} ? 'fa-solid' : 'fa-regular'"></i>
                </button>
              </form>

              <!-- Cart Button -->
              <form th:action="@{/user/cart/add}" method="post" onsubmit="return confirmAddToCart()">
                <input type="hidden" name="itemId" th:value="${item.id}"/>
                <input type="hidden" name="quantity" value="1"/>
                <div th:if="${_csrf != null}">
                  <input type="hidden"
                         th:name="${_csrf.parameterName}"
                         th:value="${_csrf.token}" />
                </div>
                <button type="submit" class="action-button cart"
                        th:disabled="${item.quantity == 0}" title="장바구니 담기">
                  <i class="fa-solid fa-cart-shopping"></i>
                </button>
              </form>
            </div>
          </div>

          <div class="product-info">
            <p class="brand-name">SonStarMade</p>
            <h3 class="product-name" th:text="${item.itemName}">상품명</h3>
            <p class="product-price" th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + '원'">가격</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 페이지네이션 -->
    <div class="pagination" th:if="${items != null and totalPages > 1}">
      <a th:if="${hasPrevBlock}"
         th:href="@{/(page=${prevBlockPage}, gender=${selectedGender}, sort=${selectedSort}, category=${selectedCategory})}">
        &laquo;
      </a>

      <a th:each="pageNum : ${pageNumbers}"
         th:href="@{/(page=${pageNum - 1}, gender=${selectedGender}, sort=${selectedSort}, category=${selectedCategory})}"
         th:text="${pageNum}"
         th:classappend="${pageNum == currentPage} ? 'active' : ''">
      </a>

      <a th:if="${hasNextBlock}"
         th:href="@{/(page=${nextBlockPage}, gender=${selectedGender}, sort=${selectedSort}, category=${selectedCategory})}">
        &raquo;
      </a>
    </div>
  </main>
</div>

<!-- 상태 표시기 -->
<div class="recommendation-status">
  <div id="recommendation-health-indicator"
       title="추천 시스템 상태">
  </div>
</div>

<script th:src="@{/js/pages/main.js}"></script>
</body>
</html>