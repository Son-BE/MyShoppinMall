<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="SonStarMall - AI 기반 스타일 추천 쇼핑몰">
  <meta name="keywords" content="온라인쇼핑, AI추천, 패션">

  <meta th:if="${#authorization.expression('isAuthenticated()')}"
        name="user-id"
        th:content="${#authentication.name}">

  <title>SonStarMall - 당신만을 위한 스타일</title>

  <!-- Preconnect -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- External CSS -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet"/>

  <!-- App CSS -->
  <link rel="stylesheet" href="/css/main.css">
</head>

<body th:attr="data-authenticated=${#authorization.expression('isAuthenticated()')}">

<!-- Header -->
<header class="header" role="banner">
  <div class="header-content">
    <h1 class="logo"
        onclick="window.location.href='/'"
        tabindex="0"
        role="button"
        aria-label="SonStarMall 홈으로 이동"
        onkeypress="if(event.key==='Enter') window.location.href='/'">
      SonStarMall
    </h1>

    <nav class="header-nav" aria-label="주요 메뉴">
      <a href="/" class="header-nav-link disabled-link">
        <i class="fa-solid fa-box" aria-hidden="true"></i>
        <span>전체상품</span>
      </a>
      <a href="/orders/myOrder" class="header-nav-link">
        <i class="fa-solid fa-receipt" aria-hidden="true"></i>
        <span>주문내역</span>
      </a>
      <a href="/board?category=NOTICE" class="header-nav-link">
        <i class="fa-solid fa-comments" aria-hidden="true"></i>
        <span>게시판</span>
      </a>
    </nav>

    <div class="header-search">
      <form method="get" action="/search" role="search">
        <i class="fa-solid fa-search search-icon" aria-hidden="true"></i>
        <input type="text"
               name="query"
               class="search-input"
               placeholder="상품을 검색하세요..."
               aria-label="상품 검색"
               required>
      </form>
    </div>

    <nav class="header-actions" aria-label="사용자 메뉴">
      <!-- 로그인된 사용자 -->
      <div th:if="${#authorization.expression('isAuthenticated()')}" class="user-info">
        <a th:href="@{/user/cart}" class="auth-button" aria-label="장바구니">
          <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
          <span>장바구니</span>
        </a>
        <a th:href="@{/user/wishList}" class="auth-button" aria-label="찜 목록">
          <i class="fa-solid fa-heart" aria-hidden="true"></i>
          <span>찜 목록</span>
        </a>
        <a th:href="@{/members/profile}" class="auth-button" aria-label="프로필 페이지 이동">
          <i class="fa-solid fa-user" aria-hidden="true"></i>
          <span th:text="${#authentication.name}">사용자</span>
        </a>
        <form th:action="@{/logout}" method="post" style="display:inline;">
          <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <button type="submit" class="auth-button logout-button" aria-label="로그아웃">
            <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>
            <span>로그아웃</span>
          </button>
        </form>
      </div>

      <!-- 비로그인 사용자 -->
      <div th:unless="${#authorization.expression('isAuthenticated()')}" class="user-info">
        <a th:href="@{/login}" class="auth-button" aria-label="로그인">
          <i class="fa-solid fa-right-to-bracket" aria-hidden="true"></i>
          <span>로그인</span>
        </a>
        <a th:href="@{/signup}" class="auth-button" aria-label="회원가입">
          <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
          <span>회원가입</span>
        </a>
      </div>
    </nav>
  </div>
</header>

<!-- Main Content -->
<div class="main-layout">
  <main class="main-content" role="main">

    <!-- Alert Messages -->
    <div th:if="${successMessage}" class="alert alert-success" role="alert">
      <span th:text="${successMessage}"></span>
    </div>
    <div th:if="${errorMessage}" class="alert alert-error" role="alert">
      <span th:text="${errorMessage}"></span>
    </div>
    <div th:if="${param.expired}" class="alert" role="alert">
      토큰이 만료되었습니다. 다시 로그인해주세요.
    </div>

    <!-- Hero Section with Chatbot -->
    <section class="hero-section">
      <div class="hero-content">
        <h2 class="hero-title">당신만을 위한 스타일을 찾아드립니다</h2>
        <p class="hero-subtitle">AI가 분석한 맞춤 추천으로 완벽한 스타일을 완성하세요</p>

        <div class="hero-chatbot-container">
          <div class="hero-chat-messages" id="hero-chat-messages">
            <div class="bot-message">
              <i class="fa-solid fa-robot"></i>
              <span>안녕하세요! 어떤 스타일을 찾고 계신가요? 🛍️</span>
            </div>
          </div>
          <div class="hero-chat-input-wrapper">
            <input type="text"
                   id="hero-chat-input"
                   class="hero-chat-input"
                   placeholder="예: 여름에 입기 좋은 시원한 티셔츠 추천해줘" />
            <button class="hero-chat-button" aria-label="메시지 전송">
              <i class="fa-solid fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- AI Recommend Results -->
    <div id="ai-recommend-list"
         class="ai-recommend-section"
         style="display: none;"
         role="region"
         aria-label="AI 추천 결과"
         aria-live="polite">
    </div>

    <!-- Personalized Recommendations -->
    <section class="story-section compact animate-fade-in"
             th:if="${personalizedItems != null and not #lists.isEmpty(personalizedItems)}"
             aria-labelledby="personalized-title">
      <div class="section-header">
        <h3 id="personalized-title" class="section-title">
          <i class="fa-solid fa-sparkles" aria-hidden="true"></i>
          당신만을 위한 추천
        </h3>
        <p class="section-subtitle">당신의 스타일을 분석하여 선별한 특별한 아이템</p>
      </div>
      <div class="story-grid compact" role="list">
        <article th:each="item : ${personalizedItems}" class="product-card" role="listitem">
          <div class="product-image-wrapper">
            <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}"
               th:aria-label="${item.itemName != null ? item.itemName : item.name} + ' 상품 상세보기'">
              <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                   th:alt="${item.itemName != null ? item.itemName : item.name}"
                   onerror="this.src='/images/default.png'"
                   loading="lazy" />
              <div class="product-overlay" aria-hidden="true"></div>
            </a>
            <div class="product-actions">
              <form th:action="@{/wishList/add}" method="post">
                <input type="hidden" name="itemId" th:value="${item.itemId != null ? item.itemId : item.id}"/>
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="action-button wishlist" title="찜하기">
                  <i class="fa-regular fa-heart" aria-hidden="true"></i>
                </button>
              </form>
              <form th:action="@{/user/cart/add}" method="post">
                <input type="hidden" name="itemId" th:value="${item.itemId != null ? item.itemId : item.id}"/>
                <input type="hidden" name="quantity" value="1"/>
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="action-button cart" title="장바구니">
                  <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
                </button>
              </form>
            </div>
          </div>
          <div class="product-info">
            <p class="brand-name">SonStarMade</p>
            <h3 class="product-name" th:text="${item.itemName != null ? item.itemName : item.name}">상품명</h3>
            <p class="product-price" th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + '원'">가격</p>
            <p class="product-reason" th:if="${item.recommendationReason}" th:text="${item.recommendationReason}">추천 이유</p>
          </div>
        </article>
      </div>
    </section>

    <!-- Realtime Popular Items -->
    <section class="story-section compact"
             th:if="${realtimeItems != null and not #lists.isEmpty(realtimeItems)}"
             aria-labelledby="realtime-title">
      <div class="section-header">
        <h3 id="realtime-title" class="section-title">
          <i class="fa-solid fa-fire" aria-hidden="true"></i>
          지금 인기 있는 스타일
        </h3>
        <p class="section-subtitle">실시간으로 가장 많은 사랑을 받고 있는 아이템</p>
      </div>
      <div class="story-grid compact" role="list">
        <article th:each="item : ${realtimeItems}" class="product-card" role="listitem">
          <div class="product-image-wrapper">
            <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}"
               th:aria-label="${item.itemName != null ? item.itemName : item.name} + ' 상품 상세보기'">
              <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                   th:alt="${item.itemName != null ? item.itemName : item.name}"
                   onerror="this.src='/images/default.png'"
                   loading="lazy" />
              <div class="product-overlay" aria-hidden="true"></div>
            </a>
            <div class="product-actions">
              <form th:action="@{/wishList/add}" method="post">
                <input type="hidden" name="itemId" th:value="${item.itemId != null ? item.itemId : item.id}"/>
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="action-button wishlist" title="찜하기">
                  <i class="fa-regular fa-heart" aria-hidden="true"></i>
                </button>
              </form>
              <form th:action="@{/user/cart/add}" method="post">
                <input type="hidden" name="itemId" th:value="${item.itemId != null ? item.itemId : item.id}"/>
                <input type="hidden" name="quantity" value="1"/>
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="action-button cart" title="장바구니">
                  <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
                </button>
              </form>
            </div>
          </div>
          <div class="product-info">
            <p class="brand-name">SonStarMade</p>
            <h3 class="product-name" th:text="${item.itemName != null ? item.itemName : item.name}">상품명</h3>
            <p class="product-price" th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + '원'">가격</p>
          </div>
        </article>
      </div>
    </section>

    <!-- All Products with Filter -->
    <section class="story-section" th:if="${items != null}" aria-labelledby="products-title">
      <div class="section-header">
        <h3 id="products-title" class="section-title">
          <i class="fa-solid fa-grid-2" aria-hidden="true"></i>
          전체 컬렉션
        </h3>
        <p class="section-subtitle">원하는 조건으로 상품을 탐색해보세요</p>
      </div>

      <!-- Filter Bar -->
      <div class="filter-bar">
        <div class="filter-bar-header">
          <div class="filter-bar-title">
            <i class="fa-solid fa-sliders" aria-hidden="true"></i>
            필터
          </div>
          <button type="button" class="filter-toggle" onclick="document.querySelector('.filter-form').classList.toggle('show')" aria-label="필터 토글">
            <i class="fa-solid fa-filter" aria-hidden="true"></i>
            필터 열기
          </button>
        </div>

        <form method="get" action="/" class="filter-form">
          <div class="filter-group">
            <label class="filter-label">성별</label>
            <div class="radio-group" role="radiogroup" aria-label="성별 선택">
              <div class="radio-option">
                <input type="radio" name="gender" value="MALE" id="male" th:checked="${selectedGender == 'MALE'}"/>
                <label for="male">남성</label>
              </div>
              <div class="radio-option">
                <input type="radio" name="gender" value="FEMALE" id="female" th:checked="${selectedGender == 'FEMALE'}"/>
                <label for="female">여성</label>
              </div>
            </div>
          </div>

          <div class="filter-group">
            <label for="sort-select" class="filter-label">정렬</label>
            <select name="sort" id="sort-select" class="select-box">
              <option value="latest" th:selected="${selectedSort == 'latest'}">최신순</option>
              <option value="price low" th:selected="${selectedSort == 'price low'}">낮은 가격순</option>
              <option value="price high" th:selected="${selectedSort == 'price high'}">높은 가격순</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="category-select" class="filter-label">카테고리</label>
            <select name="category" id="category-select" class="select-box">
              <option value="">전체</option>
              <optgroup label="상의">
                <option value="hoodie" th:selected="${selectedCategory == 'hoodie'}">후드티</option>
                <option value="tshirt" th:selected="${selectedCategory == 'tshirt'}">티셔츠</option>
                <option value="sweatshirt" th:selected="${selectedCategory == 'sweatshirt'}">맨투맨</option>
              </optgroup>
              <optgroup label="아우터">
                <option value="windbreaker" th:selected="${selectedCategory == 'windbreaker'}">바람막이</option>
                <option value="coat" th:selected="${selectedCategory == 'coat'}">코트</option>
                <option value="padding" th:selected="${selectedCategory == 'padding'}">패딩</option>
              </optgroup>
              <optgroup label="하의">
                <option value="jogger_pants" th:selected="${selectedCategory == 'jogger_pants'}">조거팬츠</option>
                <option value="training_pants" th:selected="${selectedCategory == 'training_pants'}">트레이닝 바지</option>
                <option value="jeans" th:selected="${selectedCategory == 'jeans'}">청바지</option>
              </optgroup>
              <optgroup label="신발">
                <option value="sneakers" th:selected="${selectedCategory == 'sneakers'}">스니커즈</option>
                <option value="running_shoes" th:selected="${selectedCategory == 'running_shoes'}">운동화</option>
                <option value="boots" th:selected="${selectedCategory == 'boots'}">구두</option>
              </optgroup>
              <optgroup label="악세서리">
                <option value="watch" th:selected="${selectedCategory == 'watch'}">시계</option>
                <option value="ring" th:selected="${selectedCategory == 'ring'}">반지</option>
                <option value="necklace" th:selected="${selectedCategory == 'necklace'}">목걸이</option>
              </optgroup>
            </select>
          </div>

          <div class="filter-actions">
            <button type="submit" class="apply-button">
              <i class="fa-solid fa-check" aria-hidden="true"></i>
              적용하기
            </button>
            <button type="button" class="reset-button" onclick="window.location.href='/'">
              <i class="fa-solid fa-rotate-left" aria-hidden="true"></i>
              초기화
            </button>
          </div>
        </form>
      </div>

      <!-- No Products -->
      <div th:if="${#lists.isEmpty(items)}" class="no-products">
        <i class="fa-solid fa-box-open" aria-hidden="true"></i>
        <h3>해당 조건의 상품이 없습니다</h3>
        <p>다른 필터를 선택해보세요</p>
      </div>

      <!-- Product Grid -->
      <div class="story-grid" th:unless="${#lists.isEmpty(items)}" role="list">
        <article th:each="item : ${items}" class="product-card" role="listitem">
          <div class="product-image-wrapper">
            <a th:href="@{/items/detail/{id}(id=${item.id})}" th:aria-label="${item.itemName} + ' 상품 상세보기'">
              <img th:src="${item.imagePath}"
                   onerror="this.src='/images/default.png'"
                   th:alt="${item.itemName}"
                   loading="lazy" />
              <div class="product-overlay" aria-hidden="true"></div>
            </a>
            <div class="product-actions">
              <form th:action="@{/wishList/add}" method="post">
                <input type="hidden" name="itemId" th:value="${item.id}"/>
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="action-button wishlist" th:disabled="${item.quantity == 0}" title="찜하기">
                  <i class="fa-heart" th:classappend="${item.isWish} ? 'fa-solid' : 'fa-regular'" aria-hidden="true"></i>
                </button>
              </form>
              <form th:action="@{/user/cart/add}" method="post">
                <input type="hidden" name="itemId" th:value="${item.id}"/>
                <input type="hidden" name="quantity" value="1"/>
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="action-button cart" th:disabled="${item.quantity == 0}" title="장바구니">
                  <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
                </button>
              </form>
            </div>
          </div>
          <div class="product-info">
            <p class="brand-name">SonStarMade</p>
            <h3 class="product-name" th:text="${item.itemName}">상품명</h3>
            <p class="product-price" th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + '원'">가격</p>
          </div>
        </article>
      </div>
    </section>

    <!-- Pagination -->
    <nav class="pagination"
         th:if="${items != null and totalPages > 1}"
         role="navigation"
         aria-label="페이지 네비게이션">
      <a th:if="${hasPrevBlock}"
         th:href="@{/(page=${prevBlockPage}, gender=${selectedGender}, sort=${selectedSort}, category=${selectedCategory})}"
         aria-label="이전 페이지 블록">
        &laquo;
      </a>
      <a th:each="pageNum : ${pageNumbers}"
         th:href="@{/(page=${pageNum - 1}, gender=${selectedGender}, sort=${selectedSort}, category=${selectedCategory})}"
         th:text="${pageNum}"
         th:classappend="${pageNum == currentPage} ? 'active' : ''"
         th:aria-label="'페이지 ' + ${pageNum}"
         th:aria-current="${pageNum == currentPage} ? 'page' : null">
      </a>
      <a th:if="${hasNextBlock}"
         th:href="@{/(page=${nextBlockPage}, gender=${selectedGender}, sort=${selectedSort}, category=${selectedCategory})}"
         aria-label="다음 페이지 블록">
        &raquo;
      </a>
    </nav>
  </main>
</div>

<!-- Status Indicator -->
<div class="recommendation-status" aria-live="polite" aria-atomic="true">
  <div id="recommendation-health-indicator" role="status" aria-label="추천 시스템 상태"></div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script th:src="@{/js/pages/main.js}" defer></script>
<script th:src="@{/js/chatbot.js}" defer></script>

</body>
</html>