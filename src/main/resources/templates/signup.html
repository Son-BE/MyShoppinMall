<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 | SonStarMall</title>

    <!-- Font Awesome & Google Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          crossorigin="anonymous"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/sign_up.css">

</head>

<body>
<!-- Floating Particles -->
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>

<!-- Back Button -->
<a href="/login" class="back-button" title="로그인으로 돌아가기" aria-label="로그인으로 돌아가기">
    <i class="fa-solid fa-arrow-left"></i>
</a>

<!-- Signup Section -->
<section class="signup-section">
    <div class="signup-container">
        <!-- Header -->
        <div class="signup-header">
            <h1 class="brand-logo" onclick="location.href='/items'">SonStarMall</h1>
            <h2 class="signup-title">회원가입</h2>
            <p class="signup-subtitle">SonStarMall과 함께 특별한 쇼핑을 시작하세요!</p>
        </div>

        <!-- Signup Form -->
        <form th:action="@{/register-form}" method="POST" class="signup-form" id="signupForm">
            <!-- CSRF Token -->
<!--            <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />-->

            <div class="form-row">
                <!-- Nickname -->
                <div class="form-group">
                    <label class="form-label" for="nickName">
                        <i class="fa-solid fa-user"></i> 닉네임
                    </label>
                    <div class="input-group">
                        <div class="input-wrapper">
                            <input type="text" class="form-input" id="nickName" name="nickName"
                                   placeholder="닉네임을 입력하세요" required autocomplete="nickname" />
                            <i class="fa-solid fa-user input-icon"></i>
                        </div>
                        <button type="button" class="check-button" onclick="checkNickname()">
                            <i class="fa-solid fa-check"></i>
                            중복 확인
                        </button>
                    </div>
                    <div id="nicknameCheckMsg" class="form-message"></div>
                </div>

                <!-- Gender -->
                <div class="form-group">
                    <label class="form-label" for="gender">
                        <i class="fa-solid fa-venus-mars"></i> 성별
                    </label>
                    <div class="input-wrapper">
                        <select class="form-select" id="gender" name="gender" required>
                            <option value="">성별을 선택하세요</option>
                            <option value="MALE">남성</option>
                            <option value="FEMALE">여성</option>
                        </select>
                        <i class="fa-solid fa-venus-mars input-icon"></i>
                    </div>
                </div>
            </div>

            <!-- Email -->
            <div class="form-group full-width">
                <label class="form-label" for="email">
                    <i class="fa-solid fa-envelope"></i> 이메일
                </label>
                <div class="input-wrapper">
                    <input type="email" class="form-input" id="email" name="email"
                           placeholder="example@sonstar.com" required autocomplete="email" />
                    <i class="fa-solid fa-envelope input-icon"></i>
                </div>
            </div>

            <!-- Password -->
            <div class="form-group full-width">
                <label class="form-label" for="passwordInput">
                    <i class="fa-solid fa-lock"></i> 비밀번호
                </label>
                <div class="input-group">
                    <div class="input-wrapper">
                        <input id="passwordInput" type="password" class="form-input" name="password"
                               placeholder="안전한 비밀번호를 입력하세요" required
                               autocomplete="new-password" oninput="checkPasswordStrength(this.value)" />
                        <i class="fa-solid fa-lock input-icon"></i>
                    </div>
                    <button type="button" class="toggle-button" onclick="togglePassword()">
                        <i class="fa-solid fa-eye" id="passwordToggleIcon"></i>
                        보기
                    </button>
                </div>
                <div class="password-strength">
                    <div class="strength-bar">
                        <div class="strength-fill" id="strengthFill"></div>
                    </div>
                    <div class="strength-text" id="strengthText"></div>
                </div>
            </div>

            <!-- Confirm Password -->
            <div class="form-group full-width">
                <label class="form-label" for="confirmPasswordInput">
                    <i class="fa-solid fa-lock-open"></i> 비밀번호 확인
                </label>
                <div class="input-wrapper">
                    <input id="confirmPasswordInput" type="password" class="form-input"
                           placeholder="비밀번호를 다시 입력하세요" required
                           autocomplete="new-password" oninput="checkPasswordMatch()" />
                    <i class="fa-solid fa-lock-open input-icon"></i>
                </div>
                <div id="passwordMatchMsg" class="form-message"></div>
            </div>

            <!-- Phone Number -->
            <div class="form-group full-width">
                <label class="form-label" for="phone">
                    <i class="fa-solid fa-mobile-screen"></i> 휴대폰번호 (선택사항)
                </label>
                <div class="input-wrapper">
                    <input type="tel" class="form-input" id="phone" name="phoneNumber"
                           placeholder="010-1234-5678" autocomplete="tel" />
                    <i class="fa-solid fa-mobile-screen input-icon"></i>
                </div>
            </div>

            <button type="submit" class="btn btn-primary" id="signupBtn">
                <i class="fa-solid fa-user-plus"></i>
                회원가입
                <div class="loading" id="signupLoading">
                    <div class="spinner"></div>
                </div>
                <div class="success-checkmark" id="signupSuccess"></div>
            </button>
        </form>

        <!-- Login Link -->
        <a href="/login" class="btn btn-secondary">
            <i class="fa-solid fa-right-to-bracket"></i>
            이미 계정이 있으신가요? 로그인
        </a>
    </div>
</section>

<!-- JavaScript -->
<script>
    let isNicknameChecked = false;
    let isNicknameValid = false;

    // Nickname Check Function
    function checkNickname() {
        const nickname = document.querySelector('input[name="nickName"]').value;
        const msgElement = document.getElementById("nicknameCheckMsg");
        const checkBtn = document.querySelector('.check-button');
        const nicknameInput = document.getElementById('nickName');

        if (!nickname) {
            showMessage(msgElement, "닉네임을 입력해주세요.", "warning");
            return;
        }

        // Show loading state
        checkBtn.classList.add('checking');
        checkBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 확인 중...';

        fetch(`/api/members/check-nickname?nickName=${encodeURIComponent(nickname)}`)
            .then(response => response.json())
            .then(data => {
                checkBtn.classList.remove('checking');

                if (data.exists) {
                    checkBtn.classList.add('error');
                    checkBtn.innerHTML = '<i class="fa-solid fa-times"></i> 사용 불가';
                    nicknameInput.classList.add('error');
                    nicknameInput.classList.remove('success');
                    showMessage(msgElement, "이미 존재하는 닉네임입니다.", "error");
                    isNicknameValid = false;
                } else {
                    checkBtn.classList.add('success');
                    checkBtn.innerHTML = '<i class="fa-solid fa-check"></i> 사용 가능';
                    nicknameInput.classList.add('success');
                    nicknameInput.classList.remove('error');
                    showMessage(msgElement, "사용 가능한 닉네임입니다.", "success");
                    isNicknameValid = true;
                }
                isNicknameChecked = true;
                updateSubmitButton();
            })
            .catch(err => {
                console.error('Error:', err);
                checkBtn.classList.remove('checking');
                checkBtn.classList.add('error');
                checkBtn.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> 오류';
                showMessage(msgElement, "서버 오류가 발생했습니다.", "error");
                isNicknameValid = false;
                isNicknameChecked = false;
                updateSubmitButton();
            });
    }

    // Password Toggle Function
    function togglePassword() {
        const pwdInput = document.getElementById('passwordInput');
        const confirmPwdInput = document.getElementById('confirmPasswordInput');
        const toggleIcon = document.getElementById('passwordToggleIcon');
        const toggleBtn = event.currentTarget;

        const isPasswordVisible = pwdInput.type === 'text';

        if (isPasswordVisible) {
            pwdInput.type = 'password';
            confirmPwdInput.type = 'password';
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
            toggleBtn.innerHTML = '<i class="fa-solid fa-eye"></i> 보기';
        } else {
            pwdInput.type = 'text';
            confirmPwdInput.type = 'text';
            toggleIcon.classList.remove('fa-eye');
            toggleIcon.classList.add('fa-eye-slash');
            toggleBtn.innerHTML = '<i class="fa-solid fa-eye-slash"></i> 숨기기';
        }
    }

    // Password Strength Checker
    function checkPasswordStrength(password) {
        const strengthFill = document.getElementById('strengthFill');
        const strengthText = document.getElementById('strengthText');

        if (!password) {
            strengthFill.style.width = '0%';
            strengthText.textContent = '';
            return;
        }

        let strength = 0;
        let feedback = '';

        // Length check
        if (password.length >= 8) strength += 25;
        else feedback = '8자 이상 입력하세요';

        // Uppercase check
        if (/[A-Z]/.test(password)) strength += 25;
        else if (feedback === '') feedback = '대문자를 포함하세요';

        // Lowercase check
        if (/[a-z]/.test(password)) strength += 25;
        else if (feedback === '') feedback = '소문자를 포함하세요';

        // Number or special character check
        if (/[\d!@#$%^&*(),.?":{}|<>]/.test(password)) strength += 25;
        else if (feedback === '') feedback = '숫자나 특수문자를 포함하세요';

        // Update UI
        strengthFill.style.width = strength + '%';

        if (strength <= 25) {
            strengthFill.style.background = 'var(--error-color)';
            strengthText.textContent = '약함 - ' + feedback;
            strengthText.style.color = 'var(--error-color)';
        } else if (strength <= 50) {
            strengthFill.style.background = 'var(--warning-color)';
            strengthText.textContent = '보통 - ' + (feedback || '더 안전하게 만들어보세요');
            strengthText.style.color = 'var(--warning-color)';
        } else if (strength <= 75) {
            strengthFill.style.background = 'var(--primary-color)';
            strengthText.textContent = '좋음 - 안전한 비밀번호입니다';
            strengthText.style.color = 'var(--primary-color)';
        } else {
            strengthFill.style.background = 'var(--success-color)';
            strengthText.textContent = '매우 강함 - 완벽한 비밀번호입니다!';
            strengthText.style.color = 'var(--success-color)';
        }

        updateSubmitButton();
    }

    // Password Match Checker
    function checkPasswordMatch() {
        const password = document.getElementById('passwordInput').value;
        const confirmPassword = document.getElementById('confirmPasswordInput').value;
        const msg = document.getElementById('passwordMatchMsg');
        const confirmInput = document.getElementById('confirmPasswordInput');

        if (!confirmPassword) {
            msg.classList.remove('show');
            confirmInput.classList.remove('success', 'error');
            updateSubmitButton();
            return;
        }

        if (password === confirmPassword) {
            confirmInput.classList.add('success');
            confirmInput.classList.remove('error');
            showMessage(msg, "비밀번호가 일치합니다.", "success");
        } else {
            confirmInput.classList.add('error');
            confirmInput.classList.remove('success');
            showMessage(msg, "비밀번호가 일치하지 않습니다.", "error");
        }

        updateSubmitButton();
    }

    // Show Message Helper
    function showMessage(element, text, type) {
        element.innerHTML = `<i class="fa-solid ${getIconForType(type)}"></i> ${text}`;
        element.className = `form-message ${type} show`;
    }

    // Get Icon for Message Type
    function getIconForType(type) {
        switch (type) {
            case 'success': return 'fa-check-circle';
            case 'error': return 'fa-exclamation-circle';
            case 'warning': return 'fa-exclamation-triangle';
            default: return 'fa-info-circle';
        }
    }

    // Update Submit Button State
    function updateSubmitButton() {
        const submitBtn = document.getElementById('signupBtn');
        const password = document.getElementById('passwordInput').value;
        const confirmPassword = document.getElementById('confirmPasswordInput').value;
        const email = document.getElementById('email').value;
        const gender = document.getElementById('gender').value;
        const nickname = document.getElementById('nickName').value;

        const isPasswordStrong = password.length >= 8 && /[A-Z]/.test(password) && /[a-z]/.test(password) && /[\d!@#$%^&*(),.?":{}|<>]/.test(password);
        const isPasswordMatch = password === confirmPassword && confirmPassword.length > 0;
        const isFormValid = email && gender && nickname && isNicknameChecked && isNicknameValid && isPasswordStrong && isPasswordMatch;

        submitBtn.disabled = !isFormValid;

        if (isFormValid) {
            submitBtn.style.opacity = '1';
            submitBtn.style.cursor = 'pointer';
        } else {
            submitBtn.style.opacity = '0.6';
            submitBtn.style.cursor = 'not-allowed';
        }
    }

    // Reset nickname check when nickname changes
    document.getElementById('nickName').addEventListener('input', function() {
        isNicknameChecked = false;
        isNicknameValid = false;
        const checkBtn = document.querySelector('.check-button');
        const msgElement = document.getElementById("nicknameCheckMsg");

        checkBtn.classList.remove('success', 'error', 'checking');
        checkBtn.innerHTML = '<i class="fa-solid fa-check"></i> 중복 확인';
        this.classList.remove('success', 'error');
        msgElement.classList.remove('show');
        updateSubmitButton();
    });

    // Form Submission Handler
    document.getElementById('signupForm').addEventListener('submit', function(e) {
        const password = document.getElementById('passwordInput').value;
        const confirmPassword = document.getElementById('confirmPasswordInput').value;
        const submitBtn = document.getElementById('signupBtn');
        const loading = document.getElementById('signupLoading');

        // Final validation
        if (!isNicknameChecked || !isNicknameValid) {
            e.preventDefault();
            alert("닉네임 중복 확인을 해주세요.");
            return;
        }

        if (password !== confirmPassword) {
            e.preventDefault();
            alert("비밀번호가 일치하지 않습니다.");
            return;
        }

        // Show loading state
        submitBtn.style.position = 'relative';
        loading.style.display = 'block';
        submitBtn.disabled = true;

        // Add success animation
        submitBtn.classList.add('success-animation');
    });

    // Input Enhancement
    document.querySelectorAll('.form-input, .form-select').forEach(input => {
        input.addEventListener('focus', function() {
            this.parentElement.classList.add('focused');
        });

        input.addEventListener('blur', function() {
            this.parentElement.classList.remove('focused');
        });

        input.addEventListener('input', function() {
            updateSubmitButton();
        });

        input.addEventListener('change', function() {
            updateSubmitButton();
        });
    });

    // Phone Number Formatting
    document.getElementById('phone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');

        if (value.length >= 6) {
            if (value.length <= 10) {
                value = value.replace(/(\d{3})(\d{3})(\d{1,4})/, '$1-$2-$3');
            } else {
                value = value.replace(/(\d{3})(\d{4})(\d{1,4})/, '$1-$2-$3');
            }
        } else if (value.length >= 3) {
            value = value.replace(/(\d{3})(\d{1,3})/, '$1-$2');
        }

        e.target.value = value;
    });

    // Auto-focus first input
    document.addEventListener('DOMContentLoaded', function() {
        const firstInput = document.getElementById('nickName');
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
        }
        updateSubmitButton();
    });

    // Keyboard Navigation Enhancement
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const focusedElement = document.activeElement;

            if (focusedElement.classList.contains('form-input') || focusedElement.classList.contains('form-select')) {
                const nextInput = getNextInput(focusedElement);
                if (nextInput) {
                    e.preventDefault();
                    nextInput.focus();
                }
            }
        }
    });

    // Get Next Input Helper
    function getNextInput(currentInput) {
        const inputs = Array.from(document.querySelectorAll('.form-input, .form-select'));
        const currentIndex = inputs.indexOf(currentInput);
        return inputs[currentIndex + 1] || null;
    }

    // Add ripple effect to buttons
    document.querySelectorAll('.btn, .check-button, .toggle-button').forEach(btn => {
        btn.addEventListener('click', function(e) {
            if (this.disabled) return;

            const ripple = document.createElement('div');
            ripple.style.cssText = `
                    position: absolute;
                    border-radius: 50%;
                    background: rgba(255,255,255,0.6);
                    transform: scale(0);
                    animation: ripple 0.6s linear;
                    pointer-events: none;
                `;

            const rect = this.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
            ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';

            this.appendChild(ripple);

            setTimeout(() => {
                ripple.remove();
            }, 600);
        });
    });

    // Add ripple animation styles
    const rippleStyle = document.createElement('style');
    rippleStyle.textContent = `
            @keyframes ripple {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }
            .success-animation {
                animation: successPulse 0.6s ease;
            }
            @keyframes successPulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
        `;
    document.head.appendChild(rippleStyle);

    // Email validation
    document.getElementById('email').addEventListener('blur', function() {
        const email = this.value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (email && !emailRegex.test(email)) {
            this.classList.add('error');
            this.classList.remove('success');
        } else if (email) {
            this.classList.add('success');
            this.classList.remove('error');
        } else {
            this.classList.remove('success', 'error');
        }
    });

    // Gender selection enhancement
    document.getElementById('gender').addEventListener('change', function() {
        if (this.value) {
            this.classList.add('success');
            this.classList.remove('error');
        } else {
            this.classList.remove('success', 'error');
        }
    });
</script>
</body>
</html>