<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SonStarMall - 홈</title>

    <!-- Font Awesome & Google Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          crossorigin="anonymous"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/main.css">

</head>

<body>
<!-- Scroll Progress -->
<div class="scroll-progress">
    <div class="scroll-progress-bar" id="scrollProgress"></div>
</div>

<!-- Header -->
<header>
    <div class="header-container">
        <div class="top-bar">
            <!-- 로고 클릭 시 홈으로 이동 -->
            <h1 class="logo" th:onclick="|window.location.href='/'|" tabindex="0" role="button" aria-label="홈으로 이동">
                SonStarMall
            </h1>

            <div class="user-info">
                <!-- Authenticated User -->
                <div th:if="${#authorization.expression('isAuthenticated()')}" class="user-info">
                    <span class="user-name" th:text="${#authentication.name} + '님'"></span>

                    <a th:href="@{/members/profile}" class="auth-button logout-button" aria-label="프로필 페이지 이동">
                        <i class="fa-solid fa-user" aria-hidden="true"></i>
                        내 정보
                    </a>

                    <form th:action="@{/logout}" method="post" style="display:inline;">
                        <div th:if="${_csrf != null}">
                            <input type="hidden"
                                   th:name="${_csrf.parameterName}"
                                   th:value="${_csrf.token}" />
                        </div>
                        <button type="submit" class="auth-button logout-button" aria-label="로그아웃">
                            <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>
                            로그아웃
                        </button>
                    </form>
                </div>

                <!-- Guest User -->
                <div th:if="${!#authorization.expression('isAuthenticated()')}" class="user-info">
                    <a th:href="@{/login}" class="auth-button login-button" aria-label="로그인">
                        <i class="fa-solid fa-right-to-bracket" aria-hidden="true"></i>
                        로그인
                    </a>
                    <a th:href="@{/signup}" class="auth-button login-button" aria-label="회원가입">
                        <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
                        회원가입
                    </a>
                </div>
            </div>
        </div>

        <!-- Navigation 링크 -->
        <nav class="main-nav">
            <a href="/" class="nav-link">
                <i class="fa-solid fa-house" aria-hidden="true"></i>
                Home
            </a>
            <a href="/items" class="nav-link">
                <i class="fa-solid fa-box" aria-hidden="true"></i>
                상품 목록
            </a>
            <a href="/user/cart" class="nav-link">
                <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
                장바구니
            </a>
            <a href="/user/wishList" class="nav-link">
                <i class="fa-solid fa-heart" aria-hidden="true"></i>
                찜 목록
            </a>
            <a href="/orders/myOrder" class="nav-link">
                <i class="fa-solid fa-book" aria-hidden="true"></i>
                주문 내역
            </a>
            <a href="/board?category=NOTICE" class="nav-link">
                <i class="fa-solid fa-comments" aria-hidden="true"></i>
                게시판
            </a>
        </nav>
    </div>
</header>

<!-- Main Content -->
<main class="main-content main-page">
    <!-- Alert Messages -->
    <div th:if="${successMessage}">
        <script>
            alert('[[${successMessage}]]');
        </script>
    </div>
    <div th:if="${errorMessage}">
        <script>
            alert('[[${errorMessage}]]');
        </script>
    </div>
    <div th:if="${param.expired}" class="alert" role="alert">
        토큰이 만료되었습니다. 다시 로그인해주세요.
    </div>

    <!-- Hero Section (메인 페이지만의 특별한 섹션) -->
    <section class="hero-section">
        <div class="hero-content">
            <h2 class="hero-title">트렌디한 패션을 찾고 계신가요?</h2>
            <p class="hero-subtitle">SonStar에서 당신만의 스타일을 완성하세요</p>
            <div class="hero-actions">
                <a href="/items" class="hero-button primary">
                    <i class="fa-solid fa-arrow-right"></i>
                    전체 상품 보기
                </a>
                <a href="#personalized-section" class="hero-button secondary">
                    <i class="fa-solid fa-sparkles"></i>
                    맞춤 추천 보기
                </a>
            </div>
        </div>
    </section>

    <!-- AI Search Section -->
    <section class="ai-search-section">
        <h2 class="ai-search-title">AI 스타일 어시스턴트</h2>
        <p class="ai-search-subtitle">원하는 스타일을 설명해주세요. AI가 완벽한 코디를 추천해드립니다.</p>
        <div class="ai-search-container">
            <input type="text" id="ai-query" class="ai-search-input"
                   placeholder="예: 캐주얼한 데이트룩을 추천해주세요" />
            <button onclick="requestAiRecommend()" class="ai-search-button">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                AI 추천
            </button>
        </div>
    </section>

    <!-- 개인화 추천 섹션 -->
    <section id="personalized-section" class="recommend-section"
             th:if="${personalizedItems != null and not #lists.isEmpty(personalizedItems)}">
        <h3><i class="fa-solid fa-user-check"></i> 당신만을 위한 맞춤 추천</h3>
        <div class="recommend-cards">
            <div th:each="item : ${personalizedItems}" class="card">
                <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                    <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                         alt="추천 상품 이미지"
                         onerror="this.src='/images/default.png'" />
                </a>
                <div class="item-name" th:text="${item.itemName != null ? item.itemName : item.name}"></div>
                <div class="price" th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}원|"></div>
                <div class="reason" th:text="${item.recommendationReason ?: '맞춤 추천'}"></div>
            </div>
        </div>
    </section>

    <!-- 실시간 추천 섹션 -->
    <section class="recommend-section"
             th:if="${realtimeItems != null and not #lists.isEmpty(realtimeItems)}">
        <h3><i class="fa-solid fa-bolt"></i> 실시간 인기 추천</h3>
        <div class="recommend-cards">
            <div th:each="item : ${realtimeItems}" class="card">
                <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                    <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                         alt="실시간 추천 상품 이미지"
                         onerror="this.src='/images/default.png'" />
                </a>
                <div class="item-name" th:text="${item.itemName != null ? item.itemName : item.name}"></div>
                <div class="price" th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}원|"></div>
                <div class="reason" th:text="${item.recommendationReason ?: '실시간 인기'}"></div>
            </div>
        </div>
    </section>

    <!--  인기 상품 섹션 -->
    <section class="recommend-section"
             th:if="${popularItems != null and not #lists.isEmpty(popularItems)}">
        <h3><i class="fa-solid fa-fire"></i> 지금 가장 인기 있는 상품</h3>
        <div class="recommend-cards">
            <div th:each="item : ${popularItems}" class="card">
                <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                    <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                         alt="인기 상품 이미지"
                         onerror="this.src='/images/default.png'" />
                </a>
                <div class="item-name" th:text="${item.itemName != null ? item.itemName : item.name}"></div>
                <div class="price" th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}원|"></div>
                <div class="reason" th:text="${item.recommendationReason ?: '인기 상품'}"></div>
            </div>
        </div>
    </section>

    <!-- AI Recommendations Display -->
    <div id="ai-recommend-list" class="ai-recommend-section" style="display: none;">
        <!-- AI recommendations will be displayed here -->
    </div>

    <!-- 카테고리별 추천 섹션 -->
    <section class="category-sections">
        <!-- 상의 -->
        <div class="category-section" th:if="${상의Items != null and not #lists.isEmpty(상의Items)}">
            <h3><i class="fa-solid fa-tshirt"></i> 상의 베스트</h3>
            <div class="category-grid">
                <div th:each="item : ${상의Items}" class="category-card">
                    <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                        <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                             alt="상의 추천"
                             onerror="this.src='/images/default.png'" />
                        <div class="category-info">
                            <h5 th:text="${item.itemName != null ? item.itemName : item.name}"></h5>
                            <p th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}원|"></p>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- 하의 -->
        <div class="category-section" th:if="${하의Items != null and not #lists.isEmpty(하의Items)}">
            <h3><i class="fa-solid fa-user-tie"></i> 하의 베스트</h3>
            <div class="category-grid">
                <div th:each="item : ${하의Items}" class="category-card">
                    <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                        <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                             alt="하의 추천"
                             onerror="this.src='/images/default.png'" />
                        <div class="category-info">
                            <h5 th:text="${item.itemName != null ? item.itemName : item.name}"></h5>
                            <p th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}원|"></p>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- 아우터 -->
        <div class="category-section" th:if="${아우터Items != null and not #lists.isEmpty(아우터Items)}">
            <h3><i class="fa-solid fa-vest"></i> 아우터 베스트</h3>
            <div class="category-grid">
                <div th:each="item : ${아우터Items}" class="category-card">
                    <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                        <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                             alt="아우터 추천"
                             onerror="this.src='/images/default.png'" />
                        <div class="category-info">
                            <h5 th:text="${item.itemName != null ? item.itemName : item.name}"></h5>
                            <p th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}원|"></p>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- 신발 -->
        <div class="category-section" th:if="${신발Items != null and not #lists.isEmpty(신발Items)}">
            <h3><i class="fa-solid fa-shoe-prints"></i> 신발 베스트</h3>
            <div class="category-grid">
                <div th:each="item : ${신발Items}" class="category-card">
                    <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                        <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                             alt="신발 추천"
                             onerror="this.src='/images/default.png'" />
                        <div class="category-info">
                            <h5 th:text="${item.itemName != null ? item.itemName : item.name}"></h5>
                            <p th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}원|"></p>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- 액세서리 -->
        <div class="category-section" th:if="${액세서리Items != null and not #lists.isEmpty(액세서리Items)}">
            <h3><i class="fa-solid fa-gem"></i> 액세서리 베스트</h3>
            <div class="category-grid">
                <div th:each="item : ${액세서리Items}" class="category-card">
                    <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                        <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                             alt="액세서리 추천"
                             onerror="this.src='/images/default.png'" />
                        <div class="category-info">
                            <h5 th:text="${item.itemName != null ? item.itemName : item.name}"></h5>
                            <p th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}원|"></p>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Filter Section (메인 페이지용) -->
    <section class="filter-section">
        <h3><i class="fa-solid fa-filter"></i> 원하는 상품을 찾아보세요</h3>
        <form method="get" action="/" class="filter-form">
            <div class="filter-group">
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" name="gender" value="MALE" id="male" th:checked="${selectedGender == 'MALE'}"/>
                        <label for="male">남성</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="gender" value="FEMALE" id="female" th:checked="${selectedGender == 'FEMALE'}"/>
                        <label for="female">여성</label>
                    </div>
                </div>
            </div>

            <div class="filter-controls">
                <select name="sort" class="select-box">
                    <option value="latest" th:selected="${selectedSort == 'latest'}">최신 등록 상품</option>
                    <option value="price low" th:selected="${selectedSort == 'price low'}">가격 낮은순</option>
                    <option value="price high" th:selected="${selectedSort == 'price high'}">가격 높은순</option>
                    <option value="score high" th:selected="${selectedSort == 'score high'}" disabled>평점 높은순</option>
                    <option value="most reviews" th:selected="${selectedSort == 'most reviews'}" disabled>리뷰 많은순</option>
                    <option value="popular" th:selected="${selectedSort == 'popular'}" disabled>인기순</option>
                </select>

                <select name="category" class="select-box">
                    <option value="">전체 카테고리</option>
                    <optgroup label="상의">
                        <option value="hoodie" th:selected="${selectedCategory == 'hoodie'}">후드티</option>
                        <option value="tshirt" th:selected="${selectedCategory == 'tshirt'}">티셔츠</option>
                        <option value="sweatshirt" th:selected="${selectedCategory == 'sweatshirt'}">맨투맨</option>
                    </optgroup>
                    <optgroup label="아우터">
                        <option value="windbreaker" th:selected="${selectedCategory == 'windbreaker'}">바람막이</option>
                        <option value="coat" th:selected="${selectedCategory == 'coat'}">코트</option>
                        <option value="padding" th:selected="${selectedCategory == 'padding'}">패딩</option>
                    </optgroup>
                    <optgroup label="하의">
                        <option value="jogger_pants" th:selected="${selectedCategory == 'jogger_pants'}">조거팬츠</option>
                        <option value="training_pants" th:selected="${selectedCategory == 'training_pants'}">트레이닝 바지</option>
                        <option value="jeans" th:selected="${selectedCategory == 'jeans'}">청바지</option>
                    </optgroup>
                    <optgroup label="신발">
                        <option value="sneakers" th:selected="${selectedCategory == 'sneakers'}">스니커즈</option>
                        <option value="running_shoes" th:selected="${selectedCategory == 'running_shoes'}">운동화</option>
                        <option value="boots" th:selected="${selectedCategory == 'boots'}">구두</option>
                    </optgroup>
                    <optgroup label="악세서리">
                        <option value="watch" th:selected="${selectedCategory == 'watch'}">시계</option>
                        <option value="ring" th:selected="${selectedCategory == 'ring'}">반지</option>
                        <option value="necklace" th:selected="${selectedCategory == 'necklace'}">목걸이</option>
                    </optgroup>
                </select>

                <button type="submit" class="apply-button">
                    <i class="fa-solid fa-search"></i>
                    필터 적용
                </button>
            </div>
        </form>
    </section>

    <!-- Products Section (필터링된 결과) -->
    <section class="products-section" th:if="${items != null}">
        <div class="section-header">
            <h3><i class="fa-solid fa-grid-2"></i> 상품 목록</h3>
            <a href="/items" class="view-all-link">
                전체 보기 <i class="fa-solid fa-arrow-right"></i>
            </a>
        </div>

        <div th:if="${#lists.isEmpty(items)}" class="no-products">
            <div style="text-align: center; padding: 4rem; color: var(--text-secondary);">
                <i class="fa-solid fa-box-open" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <h3>해당 조건의 상품이 없습니다</h3>
                <p>다른 필터 조건을 선택해보세요.</p>
            </div>
        </div>

        <div class="products-grid" th:unless="${#lists.isEmpty(items)}">
            <div th:each="item : ${items}" class="product-card">
                <div class="product-image">
                    <a th:href="@{/items/detail/{id}(id=${item.id})}">
                        <img th:src="${item.imagePath}" onerror="this.src='/images/default.png'"
                             th:alt="${item.itemName} + ' 상품 이미지'"/>
                        <div class="product-overlay"></div>
                    </a>

                    <div class="card-actions">
                        <!-- Wishlist Button -->
                        <form th:action="@{/wishList/add}" method="post" onsubmit="return confirmAddToWishlist()">
                            <input type="hidden" name="itemId" th:value="${item.id}"/>
                            <div th:if="${_csrf != null}">
                                <input type="hidden"
                                       th:name="${_csrf.parameterName}"
                                       th:value="${_csrf.token}" />
                            </div>

                            <button type="submit" class="action-button wishlist"
                                    th:disabled="${item.quantity == 0}" title="찜하기">
                                <i class="fa-heart" th:classappend="${item.isWish} ? 'fa-solid' : 'fa-regular'"></i>
                            </button>
                        </form>

                        <!-- Cart Button -->
                        <form th:action="@{/user/cart/add}" method="post" onsubmit="return confirmAddToCart()">
                            <input type="hidden" name="itemId" th:value="${item.id}"/>
                            <input type="hidden" name="quantity" value="1"/>
                            <div th:if="${_csrf != null}">
                                <input type="hidden"
                                       th:name="${_csrf.parameterName}"
                                       th:value="${_csrf.token}" />
                            </div>
                            <button type="submit" class="action-button cart"
                                    th:disabled="${item.quantity == 0}" title="장바구니 담기">
                                <i class="fa-solid fa-cart-shopping"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <div class="product-info">
                    <p class="brand-name">SonStarMade</p>
                    <h3 class="product-name" th:text="${item.itemName}">상품명</h3>
                    <p class="product-price" th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + '원'">가격</p>
                </div>
            </div>
        </div>
    </section>

    <div class="recommendation-status" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <div id="recommendation-health-indicator"
             style="width: 12px; height: 12px; border-radius: 50%; background: #ccc;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer;"
             title="추천 시스템 상태">
        </div>
    </div>

    <!-- 메인 페이지 pagination URL을 "/" 로 변경 -->
    <div class="pagination" th:if="${items != null and totalPages > 1}">
        <a th:if="${hasPrevBlock}"
           th:href="@{/(page=${prevBlockPage}, gender=${selectedGender}, sort=${selectedSort}, category=${selectedCategory})}">
            &laquo;
        </a>

        <a th:each="pageNum : ${pageNumbers}"
           th:href="@{/(page=${pageNum - 1}, gender=${selectedGender}, sort=${selectedSort}, category=${selectedCategory})}"
           th:text="${pageNum}"
           th:classappend="${pageNum == currentPage} ? 'active' : ''">
        </a>

        <a th:if="${hasNextBlock}"
           th:href="@{/(page=${nextBlockPage}, gender=${selectedGender}, sort=${selectedSort}, category=${selectedCategory})}">
            &raquo;
        </a>
    </div>
</main>

<!-- Floating Recent Items -->
<div class="floating-recent">
    <h4><i class="fa-solid fa-clock-rotate-left"></i> 최근 본 상품</h4>
    <div id="recent-items-container">
        <!-- Recent items will be populated by JavaScript -->
    </div>
</div>

<!-- Floating Recommendations -->
<div class="floating-recommend" id="recommend-banner">
    <button id="toggle-recommend" class="recommend-toggle">
        <i class="fa-solid fa-sparkles"></i>
        추천 상품
    </button>
    <div id="recommend-products" class="recommend-panel">
        <h4 style="margin-bottom: 1rem; color: var(--text-primary);">
            <i class="fa-solid fa-sparkles"></i> 맞춤 추천
        </h4>
        <div th:each="item : ${personalizedItems}" class="recommend-card" th:if="${personalizedItems != null}">
            <a th:href="@{/items/detail/{id}(id=${item.itemId})}">
                <img th:src="${item.imageUrl}" onerror="this.src='/images/default.png'"
                     alt="맞춤형 추천 상품" />
            </a>
            <div class="recommend-info">
                <h5 th:text="${item.itemName}">상품명</h5>
                <p th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + '원'">가격</p>
            </div>
        </div>
        <div th:if="${personalizedItems == null or #lists.isEmpty(personalizedItems)}"
             style="padding: 2rem; text-align: center; color: var(--text-secondary);">
            <i class="fa-solid fa-heart" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
            <p>추천 상품이 없습니다</p>
        </div>
    </div>
</div>

<script>
    // 추천 시스템 상태 확인
    function checkRecommendationHealth() {
        fetch('/api/recommendations/health')
            .then(res => res.json())
            .then(data => {
                const indicator = document.getElementById('recommendation-health-indicator');
                if (data.recommendation_service === true) {
                    indicator.style.background = '#4CAF50'; // 녹색 - 정상
                    indicator.title = '추천 시스템 정상 작동 중';
                } else {
                    indicator.style.background = '#FF9800'; // 주황색 - 문제
                    indicator.title = '추천 시스템 일시 중단 (기본 추천 사용 중)';
                }
            })
            .catch(error => {
                const indicator = document.getElementById('recommendation-health-indicator');
                indicator.style.background = '#F44336'; // 빨간색 - 오류
                indicator.title = '추천 시스템 연결 실패';
            });
    }

    // 페이지 로드 시 상태 확인
    document.addEventListener('DOMContentLoaded', function() {
        checkRecommendationHealth();

        // 30초마다 상태 확인
        setInterval(checkRecommendationHealth, 30000);
    });

    // 상품 상호작용 기록 함수
    function recordInteraction(itemId, action) {
        // 로그인 사용자인지 확인 (Thymeleaf에서 변수로 전달받거나 세션에서 확인)
        const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;

        if (!isAuthenticated) {
            return; // 비로그인 사용자는 기록하지 않음
        }

        // 사용자 ID 가져오기 (세션이나 메타 태그에서)
        const userId = getUserIdFromSession();

        if (userId) {
            fetch(`/api/recommendations/interactions?userId=${userId}&itemId=${itemId}&action=${action}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    if (response.ok) {
                        console.log(`상호작용 기록됨: ${action} on item ${itemId}`);
                    }
                })
                .catch(error => {
                    console.warn('상호작용 기록 실패:', error);
                });
        }
    }

    // 사용자 ID 가져오기 헬퍼 함수
    function getUserIdFromSession() {
        // 메타 태그에서 사용자 ID 가져오기 (MainController에서 설정)
        const userIdMeta = document.querySelector('meta[name="user-id"]');
        return userIdMeta ? userIdMeta.getAttribute('content') : null;
    }

    // 상품 카드 클릭 시 view 이벤트 기록
    document.querySelectorAll('.card a, .category-card a, .product-card a').forEach(link => {
        link.addEventListener('click', function() {
            const href = this.getAttribute('href');
            const itemIdMatch = href.match(/\/items\/detail\/(\d+)/);
            if (itemIdMatch) {
                const itemId = itemIdMatch[1];
                recordInteraction(itemId, 'view');
            }
        });
    });

    // 장바구니 버튼 클릭 시 cart 이벤트 기록
    document.querySelectorAll('form[action*="/user/cart/add"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            const itemIdInput = this.querySelector('input[name="itemId"]');
            if (itemIdInput) {
                recordInteraction(itemIdInput.value, 'cart');
            }
        });
    });

    // 찜하기 버튼 클릭 시 like 이벤트 기록
    document.querySelectorAll('form[action*="/wishList/add"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            const itemIdInput = this.querySelector('input[name="itemId"]');
            if (itemIdInput) {
                recordInteraction(itemIdInput.value, 'like');
            }
        });
    });

    // Scroll Progress Bar
    window.addEventListener('scroll', () => {
        const scrollTop = window.pageYOffset;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = (scrollTop / docHeight) * 100;
        document.getElementById('scrollProgress').style.width = scrollPercent + '%';
    });

    // AI Recommendation Function
    function requestAiRecommend() {
        const query = document.getElementById("ai-query").value;
        const recommendSection = document.getElementById("ai-recommend-list");

        if (!query.trim()) {
            alert('검색어를 입력해주세요.');
            return;
        }

        // Show loading state
        recommendSection.style.display = 'block';
        recommendSection.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div class="loading">
                        <i class="fa-solid fa-wand-magic-sparkles fa-spin" style="font-size: 3rem; color: var(--primary-color);"></i>
                        <h3 style="margin-top: 1rem; color: var(--text-primary);">AI가 추천 상품을 찾고 있습니다...</h3>
                        <p style="color: var(--text-secondary); margin-top: 0.5rem;">잠시만 기다려주세요</p>
                    </div>
                </div>
            `;

        fetch(`/recommend/nlp?query=${encodeURIComponent(query)}`)
            .then(res => res.text())
            .then(html => {
                recommendSection.innerHTML = html;
                recommendSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            })
            .catch(error => {
                console.error('AI 추천 오류:', error);
                recommendSection.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <i class="fa-solid fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3>AI 추천 서비스가 일시적으로 중단되었습니다</h3>
                            <p>잠시 후 다시 시도해주세요.</p>
                            <button onclick="this.parentElement.parentElement.style.display='none'"
                                    style="margin-top: 1rem; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">
                                닫기
                            </button>
                        </div>
                    `;
            });
    }

    // Enter key support for AI search
    document.getElementById('ai-query')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            requestAiRecommend();
        }
    });

    // Confirmation Functions
    function confirmAddToCart() {
        return confirm("장바구니에 상품을 추가하시겠습니까?");
    }

    function confirmAddToWishlist() {
        return confirm("찜 목록에 상품을 추가하시겠습니까?");
    }

    // Recent Items Functionality
    function loadRecentItems() {
        const recentItemsContainer = document.getElementById('recent-items-container');
        const recentItems = JSON.parse(localStorage.getItem('recentItems') || '[]');

        if (recentItems.length === 0) {
            recentItemsContainer.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                        최근 본 상품이 없습니다
                    </div>
                `;
            return;
        }

        const displayItems = recentItems.slice(0, 5);
        recentItemsContainer.innerHTML = displayItems.map(item => `
                <div class="recent-item">
                    <a href="/items/detail/${item.id}">
                        <img src="${item.imagePath}" onerror="this.src='/images/default.png'" alt="${item.itemName}">
                        <div class="recent-item-info">
                            <h5>${item.itemName}</h5>
                            <p>${item.price.toLocaleString()}원</p>
                        </div>
                    </a>
                </div>
            `).join('');
    }

    // Floating Recommend Panel Toggle
    document.getElementById('toggle-recommend')?.addEventListener('click', function () {
        const panel = document.getElementById('recommend-products');
        const isVisible = panel.style.display === 'block';

        if (!isVisible) {
            panel.style.display = 'block';
            this.innerHTML = '<i class="fa-solid fa-times"></i> 추천 닫기';
            panel.style.animation = 'slideInLeft 0.3s ease';
        } else {
            panel.style.animation = 'slideOutLeft 0.3s ease';
            setTimeout(() => {
                panel.style.display = 'none';
                this.innerHTML = '<i class="fa-solid fa-sparkles"></i> 추천 상품';
            }, 300);
        }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadRecentItems();

        // Add active class to current nav item
        const currentPath = window.location.pathname;
        document.querySelectorAll('.nav-link').forEach(link => {
            if (link.getAttribute('href') === currentPath ||
                (currentPath === '/' && link.getAttribute('href') === '/')) {
                link.classList.add('active');
            }
        });

        // Hero section animations
        const heroElements = document.querySelectorAll('.hero-content > *');
        heroElements.forEach((el, index) => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(30px)';
            setTimeout(() => {
                el.style.transition = 'all 0.6s ease';
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            }, index * 200);
        });
    });

    // Smooth scrolling for hero buttons
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Add slide animations for CSS
    const style = document.createElement('style');
    style.textContent = `
            @keyframes slideInLeft {
                from { transform: translateX(-100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutLeft {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(-100%); opacity: 0; }
            }
            .hero-section {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 4rem 2rem;
                margin-bottom: 2rem;
                border-radius: 1rem;
                text-align: center;
                color: white;
            }
            .hero-title {
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: 1rem;
            }
            .hero-subtitle {
                font-size: 1.2rem;
                margin-bottom: 2rem;
                opacity: 0.9;
            }
            .hero-actions {
                display: flex;
                gap: 1rem;
                justify-content: center;
                flex-wrap: wrap;
            }
            .hero-button {
                padding: 1rem 2rem;
                text-decoration: none;
                border-radius: 0.5rem;
                font-weight: 600;
                transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }
            .hero-button.primary {
                background: white;
                color: #667eea;
            }
            .hero-button.secondary {
                background: rgba(255,255,255,0.2);
                color: white;
                border: 2px solid rgba(255,255,255,0.3);
            }
            .hero-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            }
            .section-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
            }
            .view-all-link {
                color: var(--primary-color);
                text-decoration: none;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                transition: all 0.3s ease;
            }
            .view-all-link:hover {
                transform: translateX(4px);
            }
            .category-sections {
                margin: 3rem 0;
            }
            .category-section {
                margin-bottom: 3rem;
            }
            .category-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
            }
            .category-card {
                background: white;
                border-radius: 0.5rem;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                overflow: hidden;
                transition: all 0.3s ease;
            }
            .category-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            }
            .category-card img {
                width: 100%;
                height: 200px;
                object-fit: cover;
            }
            .category-info {
                padding: 1rem;
            }
            .category-info h5 {
                margin: 0 0 0.5rem 0;
                font-weight: 600;
            }
            .category-info p {
                margin: 0;
                color: var(--primary-color);
                font-weight: 700;
            }
        `;
    document.head.appendChild(style);
</script>
</body>
</html>