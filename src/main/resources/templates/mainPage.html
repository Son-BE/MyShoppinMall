<!--MainPage-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SonStarMall - í™ˆ</title>

    <!-- Font Awesome & Google Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          crossorigin="anonymous"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/main.css">

</head>

<body>
<!-- Scroll Progress -->
<div class="scroll-progress">
    <div class="scroll-progress-bar" id="scrollProgress"></div>
</div>

<!-- Header -->
<header>
    <div class="header-container">
        <div class="top-bar">
            <!-- ğŸ”§ ìˆ˜ì •: ë¡œê³  í´ë¦­ ì‹œ í™ˆìœ¼ë¡œ ì´ë™ -->
            <h1 class="logo" th:onclick="|window.location.href='/'|" tabindex="0" role="button" aria-label="í™ˆìœ¼ë¡œ ì´ë™">
                SonStarMall
            </h1>

            <div class="user-info">
                <!-- Authenticated User -->
                <div th:if="${#authorization.expression('isAuthenticated()')}" class="user-info">
                    <span class="user-name" th:text="${#authentication.name} + 'ë‹˜'"></span>

                    <a th:href="@{/members/profile}" class="auth-button logout-button" aria-label="í”„ë¡œí•„ í˜ì´ì§€ ì´ë™">
                        <i class="fa-solid fa-user" aria-hidden="true"></i>
                        ë‚´ ì •ë³´
                    </a>

                    <form th:action="@{/logout}" method="post" style="display:inline;">
                        <div th:if="${_csrf != null}">
                            <input type="hidden"
                                   th:name="${_csrf.parameterName}"
                                   th:value="${_csrf.token}" />
                        </div>
                        <button type="submit" class="auth-button logout-button" aria-label="ë¡œê·¸ì•„ì›ƒ">
                            <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>
                            ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </form>
                </div>

                <!-- Guest User -->
                <div th:if="${!#authorization.expression('isAuthenticated()')}" class="user-info">
                    <a th:href="@{/login}" class="auth-button login-button" aria-label="ë¡œê·¸ì¸">
                        <i class="fa-solid fa-right-to-bracket" aria-hidden="true"></i>
                        ë¡œê·¸ì¸
                    </a>
                    <a th:href="@{/signup.html}" class="auth-button login-button" aria-label="íšŒì›ê°€ì…">
                        <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
                        íšŒì›ê°€ì…
                    </a>
                </div>
            </div>
        </div>

        <!-- ğŸ”§ ìˆ˜ì •: Navigation ë§í¬ ìˆ˜ì • -->
        <nav class="main-nav">
            <a href="/" class="nav-link">
                <i class="fa-solid fa-house" aria-hidden="true"></i>
                Home
            </a>
            <a href="/items" class="nav-link">
                <i class="fa-solid fa-box" aria-hidden="true"></i>
                ìƒí’ˆ ëª©ë¡
            </a>
            <a href="/user/cart" class="nav-link">
                <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
                ì¥ë°”êµ¬ë‹ˆ
            </a>
            <a href="/user/wishList" class="nav-link">
                <i class="fa-solid fa-heart" aria-hidden="true"></i>
                ì°œ ëª©ë¡
            </a>
            <a href="/orders/myOrder" class="nav-link">
                <i class="fa-solid fa-book" aria-hidden="true"></i>
                ì£¼ë¬¸ ë‚´ì—­
            </a>
            <a href="/board?category=NOTICE" class="nav-link">
                <i class="fa-solid fa-comments" aria-hidden="true"></i>
                ê²Œì‹œíŒ
            </a>
        </nav>
    </div>
</header>

<!-- Main Content -->
<main class="main-content main-page">
    <!-- Alert Messages -->
    <div th:if="${successMessage}">
        <script>
            alert('[[${successMessage}]]');
        </script>
    </div>
    <div th:if="${errorMessage}">
        <script>
            alert('[[${errorMessage}]]');
        </script>
    </div>
    <div th:if="${param.expired}" class="alert" role="alert">
        í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.
    </div>

    <!-- ğŸŒŸ Hero Section (ë©”ì¸ í˜ì´ì§€ë§Œì˜ íŠ¹ë³„í•œ ì„¹ì…˜) -->
    <section class="hero-section">
        <div class="hero-content">
            <h2 class="hero-title">íŠ¸ë Œë””í•œ íŒ¨ì…˜ì„ ì°¾ê³  ê³„ì‹ ê°€ìš”?</h2>
            <p class="hero-subtitle">SonStarì—ì„œ ë‹¹ì‹ ë§Œì˜ ìŠ¤íƒ€ì¼ì„ ì™„ì„±í•˜ì„¸ìš”</p>
            <div class="hero-actions">
                <a href="/items" class="hero-button primary">
                    <i class="fa-solid fa-arrow-right"></i>
                    ì „ì²´ ìƒí’ˆ ë³´ê¸°
                </a>
                <a href="#personalized-section" class="hero-button secondary">
                    <i class="fa-solid fa-sparkles"></i>
                    ë§ì¶¤ ì¶”ì²œ ë³´ê¸°
                </a>
            </div>
        </div>
    </section>

    <!-- AI Search Section -->
    <section class="ai-search-section">
        <h2 class="ai-search-title">AI ìŠ¤íƒ€ì¼ ì–´ì‹œìŠ¤í„´íŠ¸</h2>
        <p class="ai-search-subtitle">ì›í•˜ëŠ” ìŠ¤íƒ€ì¼ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”. AIê°€ ì™„ë²½í•œ ì½”ë””ë¥¼ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.</p>
        <div class="ai-search-container">
            <input type="text" id="ai-query" class="ai-search-input"
                   placeholder="ì˜ˆ: ìºì£¼ì–¼í•œ ë°ì´íŠ¸ë£©ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”" />
            <button onclick="requestAiRecommend()" class="ai-search-button">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                AI ì¶”ì²œ
            </button>
        </div>
    </section>

    <!-- ğŸ¯ ê°œì¸í™” ì¶”ì²œ ì„¹ì…˜ -->
    <section id="personalized-section" class="recommend-section"
             th:if="${personalizedItems != null and not #lists.isEmpty(personalizedItems)}">
        <h3><i class="fa-solid fa-user-check"></i> ë‹¹ì‹ ë§Œì„ ìœ„í•œ ë§ì¶¤ ì¶”ì²œ</h3>
        <div class="recommend-cards">
            <div th:each="item : ${personalizedItems}" class="card">
                <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                    <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                         alt="ì¶”ì²œ ìƒí’ˆ ì´ë¯¸ì§€"
                         onerror="this.src='/images/default.png'" />
                </a>
                <div class="item-name" th:text="${item.itemName != null ? item.itemName : item.name}"></div>
                <div class="price" th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}ì›|"></div>
                <div class="reason" th:text="${item.recommendationReason ?: 'ë§ì¶¤ ì¶”ì²œ'}"></div>
            </div>
        </div>
    </section>

    <!-- ğŸ”¥ ì‹¤ì‹œê°„ ì¶”ì²œ ì„¹ì…˜ -->
    <section class="recommend-section"
             th:if="${realtimeItems != null and not #lists.isEmpty(realtimeItems)}">
        <h3><i class="fa-solid fa-bolt"></i> ì‹¤ì‹œê°„ ì¸ê¸° ì¶”ì²œ</h3>
        <div class="recommend-cards">
            <div th:each="item : ${realtimeItems}" class="card">
                <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                    <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                         alt="ì‹¤ì‹œê°„ ì¶”ì²œ ìƒí’ˆ ì´ë¯¸ì§€"
                         onerror="this.src='/images/default.png'" />
                </a>
                <div class="item-name" th:text="${item.itemName != null ? item.itemName : item.name}"></div>
                <div class="price" th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}ì›|"></div>
                <div class="reason" th:text="${item.recommendationReason ?: 'ì‹¤ì‹œê°„ ì¸ê¸°'}"></div>
            </div>
        </div>
    </section>

    <!--  ì¸ê¸° ìƒí’ˆ ì„¹ì…˜ -->
    <section class="recommend-section"
             th:if="${popularItems != null and not #lists.isEmpty(popularItems)}">
        <h3><i class="fa-solid fa-fire"></i> ì§€ê¸ˆ ê°€ì¥ ì¸ê¸° ìˆëŠ” ìƒí’ˆ</h3>
        <div class="recommend-cards">
            <div th:each="item : ${popularItems}" class="card">
                <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                    <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                         alt="ì¸ê¸° ìƒí’ˆ ì´ë¯¸ì§€"
                         onerror="this.src='/images/default.png'" />
                </a>
                <div class="item-name" th:text="${item.itemName != null ? item.itemName : item.name}"></div>
                <div class="price" th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}ì›|"></div>
                <div class="reason" th:text="${item.recommendationReason ?: 'ì¸ê¸° ìƒí’ˆ'}"></div>
            </div>
        </div>
    </section>

    <!-- AI Recommendations Display -->
    <div id="ai-recommend-list" class="ai-recommend-section" style="display: none;">
        <!-- AI recommendations will be displayed here -->
    </div>

    <!-- ğŸ—‚ï¸ ì¹´í…Œê³ ë¦¬ë³„ ì¶”ì²œ ì„¹ì…˜ -->
    <section class="category-sections">
        <!-- ìƒì˜ -->
        <div class="category-section" th:if="${ìƒì˜Items != null and not #lists.isEmpty(ìƒì˜Items)}">
            <h3><i class="fa-solid fa-tshirt"></i> ìƒì˜ ë² ìŠ¤íŠ¸</h3>
            <div class="category-grid">
                <div th:each="item : ${ìƒì˜Items}" class="category-card">
                    <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                        <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                             alt="ìƒì˜ ì¶”ì²œ"
                             onerror="this.src='/images/default.png'" />
                        <div class="category-info">
                            <h5 th:text="${item.itemName != null ? item.itemName : item.name}"></h5>
                            <p th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}ì›|"></p>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- í•˜ì˜ -->
        <div class="category-section" th:if="${í•˜ì˜Items != null and not #lists.isEmpty(í•˜ì˜Items)}">
            <h3><i class="fa-solid fa-user-tie"></i> í•˜ì˜ ë² ìŠ¤íŠ¸</h3>
            <div class="category-grid">
                <div th:each="item : ${í•˜ì˜Items}" class="category-card">
                    <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                        <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                             alt="í•˜ì˜ ì¶”ì²œ"
                             onerror="this.src='/images/default.png'" />
                        <div class="category-info">
                            <h5 th:text="${item.itemName != null ? item.itemName : item.name}"></h5>
                            <p th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}ì›|"></p>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- ì•„ìš°í„° -->
        <div class="category-section" th:if="${ì•„ìš°í„°Items != null and not #lists.isEmpty(ì•„ìš°í„°Items)}">
            <h3><i class="fa-solid fa-vest"></i> ì•„ìš°í„° ë² ìŠ¤íŠ¸</h3>
            <div class="category-grid">
                <div th:each="item : ${ì•„ìš°í„°Items}" class="category-card">
                    <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                        <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                             alt="ì•„ìš°í„° ì¶”ì²œ"
                             onerror="this.src='/images/default.png'" />
                        <div class="category-info">
                            <h5 th:text="${item.itemName != null ? item.itemName : item.name}"></h5>
                            <p th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}ì›|"></p>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- ì‹ ë°œ -->
        <div class="category-section" th:if="${ì‹ ë°œItems != null and not #lists.isEmpty(ì‹ ë°œItems)}">
            <h3><i class="fa-solid fa-shoe-prints"></i> ì‹ ë°œ ë² ìŠ¤íŠ¸</h3>
            <div class="category-grid">
                <div th:each="item : ${ì‹ ë°œItems}" class="category-card">
                    <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                        <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                             alt="ì‹ ë°œ ì¶”ì²œ"
                             onerror="this.src='/images/default.png'" />
                        <div class="category-info">
                            <h5 th:text="${item.itemName != null ? item.itemName : item.name}"></h5>
                            <p th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}ì›|"></p>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- ì•¡ì„¸ì„œë¦¬ -->
        <div class="category-section" th:if="${ì•¡ì„¸ì„œë¦¬Items != null and not #lists.isEmpty(ì•¡ì„¸ì„œë¦¬Items)}">
            <h3><i class="fa-solid fa-gem"></i> ì•¡ì„¸ì„œë¦¬ ë² ìŠ¤íŠ¸</h3>
            <div class="category-grid">
                <div th:each="item : ${ì•¡ì„¸ì„œë¦¬Items}" class="category-card">
                    <a th:href="@{/items/detail/{id}(id=${item.itemId != null ? item.itemId : item.id})}">
                        <img th:src="${item.imageUrl != null ? item.imageUrl : item.imagePath}"
                             alt="ì•¡ì„¸ì„œë¦¬ ì¶”ì²œ"
                             onerror="this.src='/images/default.png'" />
                        <div class="category-info">
                            <h5 th:text="${item.itemName != null ? item.itemName : item.name}"></h5>
                            <p th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}ì›|"></p>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- ğŸ” Filter Section (ë©”ì¸ í˜ì´ì§€ìš©) -->
    <section class="filter-section">
        <h3><i class="fa-solid fa-filter"></i> ì›í•˜ëŠ” ìƒí’ˆì„ ì°¾ì•„ë³´ì„¸ìš”</h3>
        <form method="get" action="/" class="filter-form">
            <div class="filter-group">
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" name="gender" value="MALE" id="male" th:checked="${selectedGender == 'MALE'}"/>
                        <label for="male">ë‚¨ì„±</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="gender" value="FEMALE" id="female" th:checked="${selectedGender == 'FEMALE'}"/>
                        <label for="female">ì—¬ì„±</label>
                    </div>
                </div>
            </div>

            <div class="filter-controls">
                <select name="sort" class="select-box">
                    <option value="latest" th:selected="${selectedSort == 'latest'}">ìµœì‹  ë“±ë¡ ìƒí’ˆ</option>
                    <option value="price low" th:selected="${selectedSort == 'price low'}">ê°€ê²© ë‚®ì€ìˆœ</option>
                    <option value="price high" th:selected="${selectedSort == 'price high'}">ê°€ê²© ë†’ì€ìˆœ</option>
                    <option value="score high" th:selected="${selectedSort == 'score high'}" disabled>í‰ì  ë†’ì€ìˆœ</option>
                    <option value="most reviews" th:selected="${selectedSort == 'most reviews'}" disabled>ë¦¬ë·° ë§ì€ìˆœ</option>
                    <option value="popular" th:selected="${selectedSort == 'popular'}" disabled>ì¸ê¸°ìˆœ</option>
                </select>

                <select name="category" class="select-box">
                    <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                    <optgroup label="ìƒì˜">
                        <option value="hoodie" th:selected="${selectedCategory == 'hoodie'}">í›„ë“œí‹°</option>
                        <option value="tshirt" th:selected="${selectedCategory == 'tshirt'}">í‹°ì…”ì¸ </option>
                        <option value="sweatshirt" th:selected="${selectedCategory == 'sweatshirt'}">ë§¨íˆ¬ë§¨</option>
                    </optgroup>
                    <optgroup label="ì•„ìš°í„°">
                        <option value="windbreaker" th:selected="${selectedCategory == 'windbreaker'}">ë°”ëŒë§‰ì´</option>
                        <option value="coat" th:selected="${selectedCategory == 'coat'}">ì½”íŠ¸</option>
                        <option value="padding" th:selected="${selectedCategory == 'padding'}">íŒ¨ë”©</option>
                    </optgroup>
                    <optgroup label="í•˜ì˜">
                        <option value="jogger_pants" th:selected="${selectedCategory == 'jogger_pants'}">ì¡°ê±°íŒ¬ì¸ </option>
                        <option value="training_pants" th:selected="${selectedCategory == 'training_pants'}">íŠ¸ë ˆì´ë‹ ë°”ì§€</option>
                        <option value="jeans" th:selected="${selectedCategory == 'jeans'}">ì²­ë°”ì§€</option>
                    </optgroup>
                    <optgroup label="ì‹ ë°œ">
                        <option value="sneakers" th:selected="${selectedCategory == 'sneakers'}">ìŠ¤ë‹ˆì»¤ì¦ˆ</option>
                        <option value="running_shoes" th:selected="${selectedCategory == 'running_shoes'}">ìš´ë™í™”</option>
                        <option value="boots" th:selected="${selectedCategory == 'boots'}">êµ¬ë‘</option>
                    </optgroup>
                    <optgroup label="ì•…ì„¸ì„œë¦¬">
                        <option value="watch" th:selected="${selectedCategory == 'watch'}">ì‹œê³„</option>
                        <option value="ring" th:selected="${selectedCategory == 'ring'}">ë°˜ì§€</option>
                        <option value="necklace" th:selected="${selectedCategory == 'necklace'}">ëª©ê±¸ì´</option>
                    </optgroup>
                </select>

                <button type="submit" class="apply-button">
                    <i class="fa-solid fa-search"></i>
                    í•„í„° ì ìš©
                </button>
            </div>
        </form>
    </section>

    <!-- Products Section (í•„í„°ë§ëœ ê²°ê³¼) -->
    <section class="products-section" th:if="${items != null}">
        <div class="section-header">
            <h3><i class="fa-solid fa-grid-2"></i> ìƒí’ˆ ëª©ë¡</h3>
            <a href="/items" class="view-all-link">
                ì „ì²´ ë³´ê¸° <i class="fa-solid fa-arrow-right"></i>
            </a>
        </div>

        <div th:if="${#lists.isEmpty(items)}" class="no-products">
            <div style="text-align: center; padding: 4rem; color: var(--text-secondary);">
                <i class="fa-solid fa-box-open" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <h3>í•´ë‹¹ ì¡°ê±´ì˜ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>ë‹¤ë¥¸ í•„í„° ì¡°ê±´ì„ ì„ íƒí•´ë³´ì„¸ìš”.</p>
            </div>
        </div>

        <div class="products-grid" th:unless="${#lists.isEmpty(items)}">
            <div th:each="item : ${items}" class="product-card">
                <div class="product-image">
                    <a th:href="@{/items/detail/{id}(id=${item.id})}">
                        <img th:src="${item.imagePath}" onerror="this.src='/images/default.png'"
                             th:alt="${item.itemName} + ' ìƒí’ˆ ì´ë¯¸ì§€'"/>
                        <div class="product-overlay"></div>
                    </a>

                    <div class="card-actions">
                        <!-- Wishlist Button -->
                        <form th:action="@{/wishList/add}" method="post" onsubmit="return confirmAddToWishlist()">
                            <input type="hidden" name="itemId" th:value="${item.id}"/>
                            <div th:if="${_csrf != null}">
                                <input type="hidden"
                                       th:name="${_csrf.parameterName}"
                                       th:value="${_csrf.token}" />
                            </div>

                            <button type="submit" class="action-button wishlist"
                                    th:disabled="${item.quantity == 0}" title="ì°œí•˜ê¸°">
                                <i class="fa-heart" th:classappend="${item.isWish} ? 'fa-solid' : 'fa-regular'"></i>
                            </button>
                        </form>

                        <!-- Cart Button -->
                        <form th:action="@{/user/cart/add}" method="post" onsubmit="return confirmAddToCart()">
                            <input type="hidden" name="itemId" th:value="${item.id}"/>
                            <input type="hidden" name="quantity" value="1"/>
                            <div th:if="${_csrf != null}">
                                <input type="hidden"
                                       th:name="${_csrf.parameterName}"
                                       th:value="${_csrf.token}" />
                            </div>
                            <button type="submit" class="action-button cart"
                                    th:disabled="${item.quantity == 0}" title="ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°">
                                <i class="fa-solid fa-cart-shopping"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <div class="product-info">
                    <p class="brand-name">SonStarMade</p>
                    <h3 class="product-name" th:text="${item.itemName}">ìƒí’ˆëª…</h3>
                    <p class="product-price" th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + 'ì›'">ê°€ê²©</p>
                </div>
            </div>
        </div>
    </section>

    <div class="recommendation-status" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <div id="recommendation-health-indicator"
             style="width: 12px; height: 12px; border-radius: 50%; background: #ccc;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer;"
             title="ì¶”ì²œ ì‹œìŠ¤í…œ ìƒíƒœ">
        </div>
    </div>


    <!-- ğŸ”§ ìˆ˜ì •: ë©”ì¸ í˜ì´ì§€ pagination URLì„ "/" ë¡œ ë³€ê²½ -->
    <div class="pagination" th:if="${items != null and totalPages > 1}">
        <a th:if="${hasPrevBlock}"
           th:href="@{/(page=${prevBlockPage}, gender=${selectedGender}, sort=${selectedSort}, category=${selectedCategory})}">
            &laquo;
        </a>

        <a th:each="pageNum : ${pageNumbers}"
           th:href="@{/(page=${pageNum - 1}, gender=${selectedGender}, sort=${selectedSort}, category=${selectedCategory})}"
           th:text="${pageNum}"
           th:classappend="${pageNum == currentPage} ? 'active' : ''">
        </a>

        <a th:if="${hasNextBlock}"
           th:href="@{/(page=${nextBlockPage}, gender=${selectedGender}, sort=${selectedSort}, category=${selectedCategory})}">
            &raquo;
        </a>
    </div>
</main>

<!-- Floating Recent Items -->
<div class="floating-recent">
    <h4><i class="fa-solid fa-clock-rotate-left"></i> ìµœê·¼ ë³¸ ìƒí’ˆ</h4>
    <div id="recent-items-container">
        <!-- Recent items will be populated by JavaScript -->
    </div>
</div>

<!-- Floating Recommendations -->
<div class="floating-recommend" id="recommend-banner">
    <button id="toggle-recommend" class="recommend-toggle">
        <i class="fa-solid fa-sparkles"></i>
        ì¶”ì²œ ìƒí’ˆ
    </button>
    <div id="recommend-products" class="recommend-panel">
        <h4 style="margin-bottom: 1rem; color: var(--text-primary);">
            <i class="fa-solid fa-sparkles"></i> ë§ì¶¤ ì¶”ì²œ
        </h4>
        <div th:each="item : ${personalizedItems}" class="recommend-card" th:if="${personalizedItems != null}">
            <a th:href="@{/items/detail/{id}(id=${item.itemId})}">
                <img th:src="${item.imageUrl}" onerror="this.src='/images/default.png'"
                     alt="ë§ì¶¤í˜• ì¶”ì²œ ìƒí’ˆ" />
            </a>
            <div class="recommend-info">
                <h5 th:text="${item.itemName}">ìƒí’ˆëª…</h5>
                <p th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + 'ì›'">ê°€ê²©</p>
            </div>
        </div>
        <div th:if="${personalizedItems == null or #lists.isEmpty(personalizedItems)}"
             style="padding: 2rem; text-align: center; color: var(--text-secondary);">
            <i class="fa-solid fa-heart" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
            <p>ì¶”ì²œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
    </div>
</div>

<script>
    // ì¶”ì²œ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
    function checkRecommendationHealth() {
        fetch('/api/recommendations/health')
            .then(res => res.json())
            .then(data => {
                const indicator = document.getElementById('recommendation-health-indicator');
                if (data.recommendation_service === true) {
                    indicator.style.background = '#4CAF50'; // ë…¹ìƒ‰ - ì •ìƒ
                    indicator.title = 'ì¶”ì²œ ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™ ì¤‘';
                } else {
                    indicator.style.background = '#FF9800'; // ì£¼í™©ìƒ‰ - ë¬¸ì œ
                    indicator.title = 'ì¶”ì²œ ì‹œìŠ¤í…œ ì¼ì‹œ ì¤‘ë‹¨ (ê¸°ë³¸ ì¶”ì²œ ì‚¬ìš© ì¤‘)';
                }
            })
            .catch(error => {
                const indicator = document.getElementById('recommendation-health-indicator');
                indicator.style.background = '#F44336'; // ë¹¨ê°„ìƒ‰ - ì˜¤ë¥˜
                indicator.title = 'ì¶”ì²œ ì‹œìŠ¤í…œ ì—°ê²° ì‹¤íŒ¨';
            });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒíƒœ í™•ì¸
    document.addEventListener('DOMContentLoaded', function() {
        checkRecommendationHealth();

        // 30ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
        setInterval(checkRecommendationHealth, 30000);
    });

    // ğŸ”§ ìˆ˜ì •: ìƒí’ˆ ìƒí˜¸ì‘ìš© ê¸°ë¡ í•¨ìˆ˜ ì¶”ê°€
    function recordInteraction(itemId, action) {
        // ë¡œê·¸ì¸ ì‚¬ìš©ìì¸ì§€ í™•ì¸ (Thymeleafì—ì„œ ë³€ìˆ˜ë¡œ ì „ë‹¬ë°›ê±°ë‚˜ ì„¸ì…˜ì—ì„œ í™•ì¸)
        const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;

        if (!isAuthenticated) {
            return; // ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìëŠ” ê¸°ë¡í•˜ì§€ ì•ŠìŒ
        }

        // ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸° (ì„¸ì…˜ì´ë‚˜ ë©”íƒ€ íƒœê·¸ì—ì„œ)
        const userId = getUserIdFromSession();

        if (userId) {
            fetch(`/api/recommendations/interactions?userId=${userId}&itemId=${itemId}&action=${action}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    if (response.ok) {
                        console.log(`ìƒí˜¸ì‘ìš© ê¸°ë¡ë¨: ${action} on item ${itemId}`);
                    }
                })
                .catch(error => {
                    console.warn('ìƒí˜¸ì‘ìš© ê¸°ë¡ ì‹¤íŒ¨:', error);
                });
        }
    }

    // ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸° í—¬í¼ í•¨ìˆ˜
    function getUserIdFromSession() {
        // ë©”íƒ€ íƒœê·¸ì—ì„œ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸° (MainControllerì—ì„œ ì„¤ì •)
        const userIdMeta = document.querySelector('meta[name="user-id"]');
        return userIdMeta ? userIdMeta.getAttribute('content') : null;
    }

    // ìƒí’ˆ ì¹´ë“œ í´ë¦­ ì‹œ view ì´ë²¤íŠ¸ ê¸°ë¡
    document.querySelectorAll('.card a, .category-card a, .product-card a').forEach(link => {
        link.addEventListener('click', function() {
            const href = this.getAttribute('href');
            const itemIdMatch = href.match(/\/items\/detail\/(\d+)/);
            if (itemIdMatch) {
                const itemId = itemIdMatch[1];
                recordInteraction(itemId, 'view');
            }
        });
    });

    // ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ í´ë¦­ ì‹œ cart ì´ë²¤íŠ¸ ê¸°ë¡
    document.querySelectorAll('form[action*="/user/cart/add"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            const itemIdInput = this.querySelector('input[name="itemId"]');
            if (itemIdInput) {
                recordInteraction(itemIdInput.value, 'cart');
            }
        });
    });

    // ì°œí•˜ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ like ì´ë²¤íŠ¸ ê¸°ë¡
    document.querySelectorAll('form[action*="/wishList/add"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            const itemIdInput = this.querySelector('input[name="itemId"]');
            if (itemIdInput) {
                recordInteraction(itemIdInput.value, 'like');
            }
        });
    });

    // Scroll Progress Bar
    window.addEventListener('scroll', () => {
        const scrollTop = window.pageYOffset;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = (scrollTop / docHeight) * 100;
        document.getElementById('scrollProgress').style.width = scrollPercent + '%';
    });

    // AI Recommendation Function
    function requestAiRecommend() {
        const query = document.getElementById("ai-query").value;
        const recommendSection = document.getElementById("ai-recommend-list");

        if (!query.trim()) {
            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // Show loading state
        recommendSection.style.display = 'block';
        recommendSection.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div class="loading">
                        <i class="fa-solid fa-wand-magic-sparkles fa-spin" style="font-size: 3rem; color: var(--primary-color);"></i>
                        <h3 style="margin-top: 1rem; color: var(--text-primary);">AIê°€ ì¶”ì²œ ìƒí’ˆì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</h3>
                        <p style="color: var(--text-secondary); margin-top: 0.5rem;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                    </div>
                </div>
            `;

        fetch(`/recommend/nlp?query=${encodeURIComponent(query)}`)
            .then(res => res.text())
            .then(html => {
                recommendSection.innerHTML = html;
                recommendSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            })
            .catch(error => {
                console.error('AI ì¶”ì²œ ì˜¤ë¥˜:', error);
                recommendSection.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <i class="fa-solid fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3>AI ì¶”ì²œ ì„œë¹„ìŠ¤ê°€ ì¼ì‹œì ìœ¼ë¡œ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤</h3>
                            <p>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                            <button onclick="this.parentElement.parentElement.style.display='none'"
                                    style="margin-top: 1rem; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">
                                ë‹«ê¸°
                            </button>
                        </div>
                    `;
            });
    }

    // Enter key support for AI search
    document.getElementById('ai-query')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            requestAiRecommend();
        }
    });

    // Confirmation Functions
    function confirmAddToCart() {
        return confirm("ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
    }

    function confirmAddToWishlist() {
        return confirm("ì°œ ëª©ë¡ì— ìƒí’ˆì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
    }

    // Recent Items Functionality
    function loadRecentItems() {
        const recentItemsContainer = document.getElementById('recent-items-container');
        const recentItems = JSON.parse(localStorage.getItem('recentItems') || '[]');

        if (recentItems.length === 0) {
            recentItemsContainer.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                        ìµœê·¼ ë³¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤
                    </div>
                `;
            return;
        }

        const displayItems = recentItems.slice(0, 5);
        recentItemsContainer.innerHTML = displayItems.map(item => `
                <div class="recent-item">
                    <a href="/items/detail/${item.id}">
                        <img src="${item.imagePath}" onerror="this.src='/images/default.png'" alt="${item.itemName}">
                        <div class="recent-item-info">
                            <h5>${item.itemName}</h5>
                            <p>${item.price.toLocaleString()}ì›</p>
                        </div>
                    </a>
                </div>
            `).join('');
    }

    // Floating Recommend Panel Toggle
    document.getElementById('toggle-recommend')?.addEventListener('click', function () {
        const panel = document.getElementById('recommend-products');
        const isVisible = panel.style.display === 'block';

        if (!isVisible) {
            panel.style.display = 'block';
            this.innerHTML = '<i class="fa-solid fa-times"></i> ì¶”ì²œ ë‹«ê¸°';
            panel.style.animation = 'slideInLeft 0.3s ease';
        } else {
            panel.style.animation = 'slideOutLeft 0.3s ease';
            setTimeout(() => {
                panel.style.display = 'none';
                this.innerHTML = '<i class="fa-solid fa-sparkles"></i> ì¶”ì²œ ìƒí’ˆ';
            }, 300);
        }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadRecentItems();

        // Add active class to current nav item
        const currentPath = window.location.pathname;
        document.querySelectorAll('.nav-link').forEach(link => {
            if (link.getAttribute('href') === currentPath ||
                (currentPath === '/' && link.getAttribute('href') === '/')) {
                link.classList.add('active');
            }
        });

        // Hero section animations
        const heroElements = document.querySelectorAll('.hero-content > *');
        heroElements.forEach((el, index) => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(30px)';
            setTimeout(() => {
                el.style.transition = 'all 0.6s ease';
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            }, index * 200);
        });
    });

    // Smooth scrolling for hero buttons
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Add slide animations for CSS
    const style = document.createElement('style');
    style.textContent = `
            @keyframes slideInLeft {
                from { transform: translateX(-100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutLeft {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(-100%); opacity: 0; }
            }
            .hero-section {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 4rem 2rem;
                margin-bottom: 2rem;
                border-radius: 1rem;
                text-align: center;
                color: white;
            }
            .hero-title {
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: 1rem;
            }
            .hero-subtitle {
                font-size: 1.2rem;
                margin-bottom: 2rem;
                opacity: 0.9;
            }
            .hero-actions {
                display: flex;
                gap: 1rem;
                justify-content: center;
                flex-wrap: wrap;
            }
            .hero-button {
                padding: 1rem 2rem;
                text-decoration: none;
                border-radius: 0.5rem;
                font-weight: 600;
                transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }
            .hero-button.primary {
                background: white;
                color: #667eea;
            }
            .hero-button.secondary {
                background: rgba(255,255,255,0.2);
                color: white;
                border: 2px solid rgba(255,255,255,0.3);
            }
            .hero-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            }
            .section-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
            }
            .view-all-link {
                color: var(--primary-color);
                text-decoration: none;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                transition: all 0.3s ease;
            }
            .view-all-link:hover {
                transform: translateX(4px);
            }
            .category-sections {
                margin: 3rem 0;
            }
            .category-section {
                margin-bottom: 3rem;
            }
            .category-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
            }
            .category-card {
                background: white;
                border-radius: 0.5rem;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                overflow: hidden;
                transition: all 0.3s ease;
            }
            .category-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            }
            .category-card img {
                width: 100%;
                height: 200px;
                object-fit: cover;
            }
            .category-info {
                padding: 1rem;
            }
            .category-info h5 {
                margin: 0 0 0.5rem 0;
                font-weight: 600;
            }
            .category-info p {
                margin: 0;
                color: var(--primary-color);
                font-weight: 700;
            }
        `;
    document.head.appendChild(style);
</script>
</body>
</html>