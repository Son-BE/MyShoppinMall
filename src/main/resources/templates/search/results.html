<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="SonStarMall 검색 결과">
  <title th:text="'검색: ' + ${searchQuery} + ' - SonStarMall'">검색 결과 - SonStarMall</title>

  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet"/>
  <link rel="stylesheet" href="/css/main.css">
</head>

<body>

<!-- ========== HEADER ========== -->
<header class="header" role="banner">
  <div class="header-content">
    <h1 class="logo"
        onclick="window.location.href='/'"
        tabindex="0"
        role="button"
        aria-label="SonStarMall 홈으로 이동"
        onkeypress="if(event.key==='Enter') window.location.href='/'">
      SonStarMall
    </h1>

    <nav class="header-nav" aria-label="주요 메뉴">
      <a href="/" class="header-nav-link">
        <i class="fa-solid fa-box" aria-hidden="true"></i>
        <span>전체상품</span>
      </a>
      <a href="/orders/myOrder" class="header-nav-link">
        <i class="fa-solid fa-receipt" aria-hidden="true"></i>
        <span>주문내역</span>
      </a>
      <a href="/board?category=NOTICE" class="header-nav-link">
        <i class="fa-solid fa-comments" aria-hidden="true"></i>
        <span>게시판</span>
      </a>
    </nav>

    <div class="header-search">
      <form method="get" action="/search" role="search">
        <i class="fa-solid fa-search search-icon" aria-hidden="true"></i>
        <input type="text"
               name="query"
               class="search-input"
               th:value="${searchQuery}"
               placeholder="상품을 검색하세요..."
               aria-label="상품 검색"
               required>
      </form>
    </div>

    <nav class="header-actions" aria-label="사용자 메뉴">
      <div th:if="${#authorization.expression('isAuthenticated()')}" class="user-info">
        <a th:href="@{/user/cart}" class="auth-button" aria-label="장바구니">
          <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
          <span>장바구니</span>
        </a>

        <a th:href="@{/user/wishList}" class="auth-button" aria-label="찜 목록">
          <i class="fa-solid fa-heart" aria-hidden="true"></i>
          <span>찜 목록</span>
        </a>

        <a th:href="@{/members/profile}" class="auth-button" aria-label="프로필 페이지 이동">
          <i class="fa-solid fa-user" aria-hidden="true"></i>
          <span th:text="${#authentication.name}">사용자</span>
        </a>

        <form th:action="@{/logout}" method="post" style="display:inline;">
          <input type="hidden"
                 th:if="${_csrf != null}"
                 th:name="${_csrf.parameterName}"
                 th:value="${_csrf.token}" />
          <button type="submit" class="auth-button logout-button" aria-label="로그아웃">
            <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>
            <span>로그아웃</span>
          </button>
        </form>
      </div>

      <div th:unless="${#authorization.expression('isAuthenticated()')}" class="user-info">
        <a th:href="@{/login}" class="auth-button" aria-label="로그인">
          <i class="fa-solid fa-right-to-bracket" aria-hidden="true"></i>
          <span>로그인</span>
        </a>
        <a th:href="@{/signup}" class="auth-button" aria-label="회원가입">
          <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
          <span>회원가입</span>
        </a>
      </div>
    </nav>
  </div>
</header>

<!-- ========== MAIN LAYOUT ========== -->
<div class="main-layout">
  <main class="main-content" role="main">

    <!-- ========== SEARCH HERO SECTION ========== -->
    <section class="hero-section">
      <div class="hero-content">
        <h2 class="hero-title">
          '<span th:text="${searchQuery}">검색어</span>' 검색 결과
        </h2>
        <p class="hero-subtitle" th:text="'총 ' + ${totalResults != null ? totalResults : 0} + '개의 상품을 찾았습니다'">
          검색 결과
        </p>
      </div>
    </section>

    <!-- ========== SEARCH RESULTS SECTION ========== -->
    <section class="story-section" aria-labelledby="search-results-title">

      <!-- 결과 헤더 -->
      <div class="section-header" style="margin-bottom: 1.5rem;">
        <h3 id="search-results-title" class="section-title">
          <i class="fa-solid fa-search" aria-hidden="true"></i>
          검색 결과
        </h3>

        <!-- 정렬 옵션 -->
        <div th:if="${searchResults != null and not #lists.isEmpty(searchResults)}" style="display: flex; gap: 1rem; align-items: center;">
          <form method="get" action="/search" style="margin: 0;">
            <input type="hidden" name="query" th:value="${searchQuery}"/>
            <select name="sort"
                    class="select-box"
                    onchange="this.form.submit()"
                    style="width: auto; padding: 0.5rem 1rem;">
              <option value="latest" th:selected="${selectedSort == 'latest'}">최신순</option>
              <option value="priceAsc" th:selected="${selectedSort == 'priceAsc'}">낮은 가격순</option>
              <option value="priceDesc" th:selected="${selectedSort == 'priceDesc'}">높은 가격순</option>
              <option value="popular" th:selected="${selectedSort == 'popular'}">인기순</option>
            </select>
          </form>
        </div>
      </div>

      <!-- 검색 결과 없음 -->
      <div th:if="${searchQuery == null or searchQuery.trim() == ''}" class="no-products">
        <i class="fa-solid fa-search" aria-hidden="true"></i>
        <h3>검색어를 입력해주세요</h3>
        <p>원하시는 상품을 검색해보세요</p>

        <div th:if="${popularSearches != null}" style="margin-top: 2rem;">
          <h4 style="margin-bottom: 1rem;">인기 검색어</h4>
          <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
            <a th:each="keyword : ${popularSearches}"
               th:href="@{/search(query=${keyword})}"
               th:text="${keyword}"
               style="padding: 0.5rem 1rem; background: var(--color-bg-secondary);
                      border-radius: 20px; text-decoration: none; color: var(--color-text-primary);
                      transition: var(--transition-base);">
            </a>
          </div>
        </div>
      </div>

      <!-- 검색 결과 있음 -->
      <div th:if="${searchQuery != null and searchQuery.trim() != '' and searchResults != null and not #lists.isEmpty(searchResults)}"
           class="story-grid"
           role="list">
        <article th:each="item : ${searchResults}"
                 class="product-card"
                 role="listitem">
          <div class="product-image-wrapper">
            <a th:href="@{/items/detail/{id}(id=${item.id})}"
               th:aria-label="${item.itemName} + ' 상품 상세보기'">
              <img th:src="${item.imagePath}"
                   onerror="this.src='/images/default.png'"
                   th:alt="${item.itemName}"
                   loading="lazy" />
              <div class="product-overlay" aria-hidden="true"></div>
            </a>

            <div class="product-actions">
              <form th:action="@{/wishList/add}" method="post" onsubmit="return confirmAddToWishlist()">
                <input type="hidden" name="itemId" th:value="${item.id}"/>
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit"
                        class="action-button wishlist"
                        th:disabled="${item.quantity == 0}"
                        title="찜하기">
                  <i class="fa-heart"
                     th:classappend="${item.isWish} ? 'fa-solid' : 'fa-regular'"
                     aria-hidden="true"></i>
                </button>
              </form>

              <form th:action="@{/user/cart/add}" method="post" onsubmit="return confirmAddToCart()">
                <input type="hidden" name="itemId" th:value="${item.id}"/>
                <input type="hidden" name="quantity" value="1"/>
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit"
                        class="action-button cart"
                        th:disabled="${item.quantity == 0}"
                        title="장바구니">
                  <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
                </button>
              </form>
            </div>
          </div>

          <div class="product-info">
            <p class="brand-name">SonStarMade</p>
            <h3 class="product-name" th:text="${item.itemName}">상품명</h3>
            <p class="product-price" th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + '원'">가격</p>
          </div>
        </article>
      </div>

      <!-- 검색 결과 없음 (검색어는 있지만 결과 없음) -->
      <div th:if="${searchQuery != null and searchQuery.trim() != '' and (searchResults == null or #lists.isEmpty(searchResults))}"
           class="no-products">
        <i class="fa-solid fa-search-minus" aria-hidden="true"></i>
        <h3>'<span th:text="${searchQuery}"></span>'에 대한 검색 결과가 없습니다</h3>
        <p>다른 검색어를 시도해보세요</p>

        <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
          <a href="/"
             style="display: inline-flex; align-items: center; gap: 0.5rem;
                    padding: 0.75rem 1.5rem; background: var(--color-primary); color: white;
                    text-decoration: none; border-radius: var(--radius-md); font-weight: 600;">
            <i class="fa-solid fa-box" aria-hidden="true"></i>
            전체 상품 보기
          </a>
          <a href="/"
             style="display: inline-flex; align-items: center; gap: 0.5rem;
                    padding: 0.75rem 1.5rem; background: white; color: var(--color-text-primary);
                    text-decoration: none; border-radius: var(--radius-md); font-weight: 600;
                    border: 1px solid var(--color-border-light);">
            <i class="fa-solid fa-house" aria-hidden="true"></i>
            홈으로
          </a>
        </div>
      </div>
    </section>

    <!-- ========== PAGINATION ========== -->
    <nav class="pagination"
         th:if="${searchResults != null and not #lists.isEmpty(searchResults) and totalPages > 1}"
         role="navigation"
         aria-label="페이지 네비게이션">
      <a th:if="${hasPrevBlock}"
         th:href="@{/search(query=${searchQuery}, page=${prevBlockPage}, sort=${selectedSort})}"
         aria-label="이전 페이지 블록">
        &laquo;
      </a>

      <a th:each="pageNum : ${pageNumbers}"
         th:href="@{/search(query=${searchQuery}, page=${pageNum - 1}, sort=${selectedSort})}"
         th:text="${pageNum}"
         th:classappend="${pageNum == currentPage} ? 'active' : ''"
         th:aria-label="'페이지 ' + ${pageNum}"
         th:aria-current="${pageNum == currentPage} ? 'page' : null">
      </a>

      <a th:if="${hasNextBlock}"
         th:href="@{/search(query=${searchQuery}, page=${nextBlockPage}, sort=${selectedSort})}"
         aria-label="다음 페이지 블록">
        &raquo;
      </a>
    </nav>

    <!-- ========== RELATED SEARCHES ========== -->
    <section class="story-section"
             th:if="${relatedQueries != null and not #lists.isEmpty(relatedQueries)}"
             style="padding-top: 2rem;">
      <div class="section-header">
        <h3 class="section-title">
          <i class="fa-solid fa-tags" aria-hidden="true"></i>
          관련 검색어
        </h3>
      </div>
      <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem;">
        <a th:each="query : ${relatedQueries}"
           th:href="@{/search(query=${query})}"
           th:text="${query}"
           style="padding: 0.75rem 1.25rem; background: var(--color-bg-secondary);
                  border-radius: var(--radius-full); text-decoration: none;
                  color: var(--color-text-primary); transition: var(--transition-base);
                  font-weight: 500;">
        </a>
      </div>
    </section>

  </main>
</div>

<script>
  function confirmAddToCart() {
    return confirm("장바구니에 상품을 추가하시겠습니까?");
  }

  function confirmAddToWishlist() {
    return confirm("찜 목록에 상품을 추가하시겠습니까?");
  }

  // 검색 결과 애니메이션
  document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.product-card');
    cards.forEach((card, index) => {
      card.style.opacity = '0';
      card.style.transform = 'translateY(20px)';
      setTimeout(() => {
        card.style.transition = 'all 0.5s ease';
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, index * 50);
    });
  });

  // 인기 검색어 호버 효과
  const searchTags = document.querySelectorAll('a[href*="search"]');
  searchTags.forEach(tag => {
    tag.addEventListener('mouseenter', function() {
      this.style.background = 'var(--color-primary)';
      this.style.color = 'white';
      this.style.transform = 'translateY(-2px)';
    });
    tag.addEventListener('mouseleave', function() {
      this.style.background = 'var(--color-bg-secondary)';
      this.style.color = 'var(--color-text-primary)';
      this.style.transform = 'translateY(0)';
    });
  });
</script>

</body>
</html>