<!--items/stats.html-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒí’ˆ í†µê³„ - SonStarMall</title>

    <!-- Font Awesome & Google Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          crossorigin="anonymous"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/stats.css">

</head>

<body>
<!-- Header -->
<header>
    <div class="header-container">
        <div class="top-bar">
            <h1 class="logo" th:onclick="|window.location.href='/'|" tabindex="0" role="button" aria-label="í™ˆìœ¼ë¡œ ì´ë™">
                SonStarMall
            </h1>

            <div class="user-info">
                <!-- Authenticated User -->
                <div th:if="${#authorization.expression('isAuthenticated()')}" class="user-info">
                    <span class="user-name" th:text="${#authentication.name} + 'ë‹˜'"></span>

                    <a th:href="@{/members/profile}" class="auth-button logout-button" aria-label="í”„ë¡œí•„ í˜ì´ì§€ ì´ë™">
                        <i class="fa-solid fa-user" aria-hidden="true"></i>
                        ë‚´ ì •ë³´
                    </a>

                    <form th:action="@{/logout}" method="post" style="display:inline;">
                        <div th:if="${_csrf != null}">
                            <input type="hidden"
                                   th:name="${_csrf.parameterName}"
                                   th:value="${_csrf.token}" />
                        </div>
                        <button type="submit" class="auth-button logout-button" aria-label="ë¡œê·¸ì•„ì›ƒ">
                            <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>
                            ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </form>
                </div>

                <!-- Guest User -->
                <div th:if="${!#authorization.expression('isAuthenticated()')}" class="user-info">
                    <a th:href="@{/login}" class="auth-button login-button" aria-label="ë¡œê·¸ì¸">
                        <i class="fa-solid fa-right-to-bracket" aria-hidden="true"></i>
                        ë¡œê·¸ì¸
                    </a>
                    <a th:href="@{/signup.html}" class="auth-button login-button" aria-label="íšŒì›ê°€ì…">
                        <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
                        íšŒì›ê°€ì…
                    </a>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="main-nav">
            <a href="/" class="nav-link">
                <i class="fa-solid fa-house" aria-hidden="true"></i>
                Home
            </a>
            <a href="/" class="nav-link">
                <i class="fa-solid fa-box" aria-hidden="true"></i>
                ìƒí’ˆ ëª©ë¡
            </a>
            <a href="/user/cart" class="nav-link">
                <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
                ì¥ë°”êµ¬ë‹ˆ
            </a>
            <a href="/user/wishList" class="nav-link">
                <i class="fa-solid fa-heart" aria-hidden="true"></i>
                ì°œ ëª©ë¡
            </a>
            <a href="/orders/myOrder" class="nav-link">
                <i class="fa-solid fa-book" aria-hidden="true"></i>
                ì£¼ë¬¸ ë‚´ì—­
            </a>
            <a href="/board?category=NOTICE" class="nav-link">
                <i class="fa-solid fa-comments" aria-hidden="true"></i>
                ê²Œì‹œíŒ
            </a>
        </nav>
    </div>
</header>

<!-- Main Content -->
<main class="main-content stats-page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1><i class="fa-solid fa-chart-bar"></i> ìƒí’ˆ í†µê³„</h1>
            <p class="header-subtitle">ì‹¤ì‹œê°„ ìƒí’ˆ í˜„í™©ê³¼ íŠ¸ë Œë“œë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
        </div>
        <div class="header-actions">
            <button onclick="refreshStats()" class="refresh-btn">
                <i class="fa-solid fa-refresh"></i>
                ìƒˆë¡œê³ ì¹¨
            </button>
            <div class="last-updated">
                ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdated">ë°©ê¸ˆ ì „</span>
            </div>
        </div>
    </div>

    <!-- ì „ì²´ í†µê³„ ëŒ€ì‹œë³´ë“œ -->
    <section class="stats-dashboard">
        <div class="stats-grid">
            <!-- ì´ ìƒí’ˆ ìˆ˜ -->
            <div class="stat-card primary">
                <div class="stat-icon">
                    <i class="fa-solid fa-cube"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number" th:text="${overallStats?.totalItems ?: 0}">0</h3>
                    <p class="stat-label">ì´ ìƒí’ˆ ìˆ˜</p>
                    <div class="stat-change positive" th:if="${overallStats?.itemsGrowth}">
                        <i class="fa-solid fa-arrow-up"></i>
                        <span th:text="${overallStats.itemsGrowth}">+5.2%</span>
                    </div>
                </div>
            </div>

            <!-- ì´ ì¡°íšŒìˆ˜ -->
            <div class="stat-card secondary">
                <div class="stat-icon">
                    <i class="fa-solid fa-eye"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number" th:text="${#numbers.formatInteger(overallStats?.totalViews ?: 0, 3, 'COMMA')}">0</h3>
                    <p class="stat-label">ì´ ì¡°íšŒìˆ˜</p>
                    <div class="stat-change positive" th:if="${overallStats?.viewsGrowth}">
                        <i class="fa-solid fa-arrow-up"></i>
                        <span th:text="${overallStats.viewsGrowth}">+12.8%</span>
                    </div>
                </div>
            </div>

            <!-- í‰ê·  ê°€ê²© -->
            <div class="stat-card success">
                <div class="stat-icon">
                    <i class="fa-solid fa-won-sign"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number" th:text="${#numbers.formatInteger(overallStats?.averagePrice ?: 0, 3, 'COMMA')} + 'ì›'">0ì›</h3>
                    <p class="stat-label">í‰ê·  ê°€ê²©</p>
                    <div class="stat-change negative" th:if="${overallStats?.priceGrowth}">
                        <i class="fa-solid fa-arrow-down"></i>
                        <span th:text="${overallStats.priceGrowth}">-2.1%</span>
                    </div>
                </div>
            </div>

            <!-- ì¬ê³  ë¶€ì¡± ìƒí’ˆ -->
            <div class="stat-card warning">
                <div class="stat-icon">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number" th:text="${overallStats?.lowStockItems ?: 0}">0</h3>
                    <p class="stat-label">ì¬ê³  ë¶€ì¡± ìƒí’ˆ</p>
                    <div class="stat-change" th:classappend="${overallStats?.lowStockGrowth > 0} ? 'negative' : 'positive'"
                         th:if="${overallStats?.lowStockGrowth}">
                        <i class="fa-solid" th:classappend="${overallStats?.lowStockGrowth > 0} ? 'fa-arrow-up' : 'fa-arrow-down'"></i>
                        <span th:text="${overallStats.lowStockGrowth}">+3</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ì‹¤ì‹œê°„ í†µê³„ -->
    <section class="realtime-section" th:if="${realtimeStats}">
        <h2><i class="fa-solid fa-bolt"></i> ì‹¤ì‹œê°„ í˜„í™©</h2>
        <div class="realtime-grid">
            <div class="realtime-card">
                <h4>ì˜¤ëŠ˜ ì¡°íšŒëœ ìƒí’ˆ</h4>
                <div class="realtime-number" th:text="${realtimeStats.todayViews ?: 0}">0</div>
                <p>ì§€ë‚œ 24ì‹œê°„</p>
            </div>
            <div class="realtime-card">
                <h4>í˜„ì¬ í™œì„± ì‚¬ìš©ì</h4>
                <div class="realtime-number" th:text="${realtimeStats.activeUsers ?: 0}">0</div>
                <p>ì‹¤ì‹œê°„</p>
            </div>
            <div class="realtime-card">
                <h4>ì‹œê°„ë‹¹ í‰ê·  ì¡°íšŒ</h4>
                <div class="realtime-number" th:text="${realtimeStats.hourlyAverage ?: 0}">0</div>
                <p>ìµœê·¼ 1ì‹œê°„</p>
            </div>
            <div class="realtime-card">
                <h4>ì¸ê¸° ê²€ìƒ‰ì–´</h4>
                <div class="realtime-keyword" th:text="${realtimeStats.topKeyword ?: 'ì—†ìŒ'}">í›„ë“œí‹°</div>
                <p>í˜„ì¬ 1ìœ„</p>
            </div>
        </div>
    </section>

    <!-- ì¹´í…Œê³ ë¦¬ë³„ í†µê³„ -->
    <section class="category-section" th:if="${categoryStats}">
        <h2><i class="fa-solid fa-chart-pie"></i> ì¹´í…Œê³ ë¦¬ë³„ í˜„í™©</h2>
        <div class="category-stats-container">
            <!-- ì¹´í…Œê³ ë¦¬ ì°¨íŠ¸ -->
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>

            <!-- ì¹´í…Œê³ ë¦¬ í…Œì´ë¸” -->
            <div class="category-table">
                <table>
                    <thead>
                    <tr>
                        <th>ì¹´í…Œê³ ë¦¬</th>
                        <th>ìƒí’ˆ ìˆ˜</th>
                        <th>ì¡°íšŒìˆ˜</th>
                        <th>ë¹„ìœ¨</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="category : ${categoryStats.categories}">
                        <td>
                            <div class="category-name">
                                <i class="fa-solid fa-tag" th:style="'color: ' + ${category.color}"></i>
                                <span th:text="${category.name}">ì¹´í…Œê³ ë¦¬ëª…</span>
                            </div>
                        </td>
                        <td th:text="${category.itemCount}">0</td>
                        <td th:text="${#numbers.formatInteger(category.viewCount, 3, 'COMMA')}">0</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" th:style="'width: ' + ${category.percentage} + '%; background: ' + ${category.color}"></div>
                                <span th:text="${category.percentage} + '%'">0%</span>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- ê°€ê²©ëŒ€ë³„ ë¶„í¬ -->
    <section class="price-section" th:if="${priceRangeStats}">
        <h2><i class="fa-solid fa-chart-column"></i> ê°€ê²©ëŒ€ë³„ ë¶„í¬</h2>
        <div class="price-chart-container">
            <canvas id="priceChart"></canvas>
        </div>
        <div class="price-summary">
            <div class="price-stat">
                <span class="label">ìµœì €ê°€:</span>
                <span class="value" th:text="${#numbers.formatInteger(priceRangeStats.minPrice, 3, 'COMMA')} + 'ì›'">0ì›</span>
            </div>
            <div class="price-stat">
                <span class="label">ìµœê³ ê°€:</span>
                <span class="value" th:text="${#numbers.formatInteger(priceRangeStats.maxPrice, 3, 'COMMA')} + 'ì›'">0ì›</span>
            </div>
            <div class="price-stat">
                <span class="label">ì¤‘ê°„ê°€:</span>
                <span class="value" th:text="${#numbers.formatInteger(priceRangeStats.medianPrice, 3, 'COMMA')} + 'ì›'">0ì›</span>
            </div>
        </div>
    </section>

    <!-- ì¸ê¸° ìƒí’ˆ ìˆœìœ„ -->
    <section class="popular-section" th:if="${popularItems}">
        <h2><i class="fa-solid fa-fire"></i> ì¸ê¸° ìƒí’ˆ TOP 10</h2>
        <div class="popular-list">
            <div th:each="item, iterStat : ${popularItems}" class="popular-item">
                <div class="rank" th:text="${iterStat.count}" th:classappend="'rank-' + ${iterStat.count}">1</div>
                <div class="item-image">
                    <a th:href="@{/items/detail/{id}(id=${item.id})}">
                        <img th:src="${item.imagePath}" th:alt="${item.itemName}" onerror="this.src='/images/default.png'"/>
                    </a>
                </div>
                <div class="item-info">
                    <h4><a th:href="@{/items/detail/{id}(id=${item.id})}" th:text="${item.itemName}">ìƒí’ˆëª…</a></h4>
                    <p class="price" th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + 'ì›'">ê°€ê²©</p>
                    <div class="stats">
            <span class="views">
              <i class="fa-solid fa-eye"></i>
              <span th:text="${#numbers.formatInteger(item.viewCount ?: 0, 3, 'COMMA')}">0</span>
            </span>
                        <span class="rating" th:if="${item.rating}">
              <i class="fa-solid fa-star"></i>
              <span th:text="${item.rating}">0.0</span>
            </span>
                    </div>
                </div>
                <div class="growth-indicator" th:if="${item.growthRate}">
                    <i class="fa-solid fa-arrow-up" th:if="${item.growthRate > 0}"></i>
                    <i class="fa-solid fa-arrow-down" th:if="${item.growthRate < 0}"></i>
                    <i class="fa-solid fa-minus" th:if="${item.growthRate == 0}"></i>
                    <span th:text="${item.growthRate} + '%'">+5.2%</span>
                </div>
            </div>
        </div>
    </section>

    <!-- ìµœì‹  ìƒí’ˆ -->
    <section class="latest-section" th:if="${latestItems}">
        <h2><i class="fa-solid fa-sparkles"></i> ìµœì‹  ë“±ë¡ ìƒí’ˆ</h2>
        <div class="latest-grid">
            <div th:each="item : ${latestItems}" class="latest-card">
                <a th:href="@{/items/detail/{id}(id=${item.id})}">
                    <img th:src="${item.imagePath}" th:alt="${item.itemName}" onerror="this.src='/images/default.png'"/>
                    <div class="latest-info">
                        <h5 th:text="${item.itemName}">ìƒí’ˆëª…</h5>
                        <p th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + 'ì›'">ê°€ê²©</p>
                        <div class="latest-meta">
                            <span class="date" th:text="${#temporals.format(item.createdAt, 'MM-dd')}">ë‚ ì§œ</span>
                            <span class="new-badge">NEW</span>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </section>

    <!-- ì‚¬ìš©ìë³„ í†µê³„ (ë¡œê·¸ì¸ ì‹œ) -->
    <section class="user-section" th:if="${userStats}">
        <h2><i class="fa-solid fa-user-chart"></i> ë‚´ í™œë™ í†µê³„</h2>
        <div class="user-stats-grid">
            <div class="user-stat-card">
                <h4>ì¡°íšŒí•œ ìƒí’ˆ</h4>
                <div class="user-number" th:text="${userStats.viewedItems}">0</div>
                <p>ì´ ì¡°íšŒìˆ˜</p>
            </div>
            <div class="user-stat-card">
                <h4>ì°œí•œ ìƒí’ˆ</h4>
                <div class="user-number" th:text="${userStats.wishlistItems}">0</div>
                <p>ì°œ ëª©ë¡</p>
            </div>
            <div class="user-stat-card">
                <h4>ì£¼ë¬¸í•œ ìƒí’ˆ</h4>
                <div class="user-number" th:text="${userStats.orderedItems}">0</div>
                <p>ì´ ì£¼ë¬¸</p>
            </div>
            <div class="user-stat-card">
                <h4>ì„ í˜¸ ì¹´í…Œê³ ë¦¬</h4>
                <div class="user-category" th:text="${userStats.favoriteCategory}">ì¹´í…Œê³ ë¦¬</div>
                <p>ê°€ì¥ ë§ì´ ë³¸</p>
            </div>
        </div>

        <!-- ì‚¬ìš©ì ì¡°íšŒ íˆìŠ¤í† ë¦¬ ì°¨íŠ¸ -->
        <div class="user-chart-container" th:if="${viewStats}">
            <h3>ìµœê·¼ ì¡°íšŒ íŒ¨í„´</h3>
            <canvas id="userViewChart"></canvas>
        </div>
    </section>
</main>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        startRealtimeUpdates();
    });

    // ì°¨íŠ¸ ì´ˆê¸°í™” (ì•ˆì „í•˜ê²Œ ìˆ˜ì •)
    function initializeCharts() {
        // ì¹´í…Œê³ ë¦¬ íŒŒì´ ì°¨íŠ¸ - ì•ˆì „í•œ ì²˜ë¦¬
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
            // ğŸ”§ ìˆ˜ì •: ì•ˆì „í•œ ë°ì´í„° ì²˜ë¦¬
            const categoryDataRaw = /*[[${categoryStats?.chartData}]]*/ null;
            let categoryData = null;

            try {
                if (categoryDataRaw && categoryDataRaw !== '{}') {
                    categoryData = typeof categoryDataRaw === 'string' ?
                        JSON.parse(categoryDataRaw) : categoryDataRaw;
                }
            } catch (e) {
                console.warn('ì¹´í…Œê³ ë¦¬ ì°¨íŠ¸ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', e);
            }

            if (categoryData && categoryData.labels && categoryData.data) {
                new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: categoryData.labels,
                        datasets: [{
                            data: categoryData.data,
                            backgroundColor: categoryData.colors || generateColors(categoryData.data.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
            } else {
                // ë°ì´í„°ê°€ ì—†ì„ ë•Œ ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ
                categoryCtx.getContext('2d').fillText('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 150, 150);
            }
        }

        // ê°€ê²©ëŒ€ íˆìŠ¤í† ê·¸ë¨ - ì•ˆì „í•œ ì²˜ë¦¬
        const priceCtx = document.getElementById('priceChart');
        if (priceCtx) {
            const priceDataRaw = /*[[${priceRangeStats?.chartData}]]*/ null;
            let priceData = null;

            try {
                if (priceDataRaw && priceDataRaw !== '{}') {
                    priceData = typeof priceDataRaw === 'string' ?
                        JSON.parse(priceDataRaw) : priceDataRaw;
                }
            } catch (e) {
                console.warn('ê°€ê²© ì°¨íŠ¸ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', e);
            }

            if (priceData && priceData.labels && priceData.data) {
                new Chart(priceCtx, {
                    type: 'bar',
                    data: {
                        labels: priceData.labels,
                        datasets: [{
                            label: 'ìƒí’ˆ ìˆ˜',
                            data: priceData.data,
                            backgroundColor: 'rgba(79, 70, 229, 0.8)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            } else {
                priceCtx.getContext('2d').fillText('ê°€ê²© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 200, 200);
            }
        }

        // ì‚¬ìš©ì ì¡°íšŒ íŒ¨í„´ ì°¨íŠ¸ - ì•ˆì „í•œ ì²˜ë¦¬
        const userViewCtx = document.getElementById('userViewChart');
        if (userViewCtx) {
            const viewDataRaw = /*[[${viewStats?.chartData}]]*/ null;
            let viewData = null;

            try {
                if (viewDataRaw && viewDataRaw !== '{}') {
                    viewData = typeof viewDataRaw === 'string' ?
                        JSON.parse(viewDataRaw) : viewDataRaw;
                }
            } catch (e) {
                console.warn('ì‚¬ìš©ì ì°¨íŠ¸ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', e);
            }

            if (viewData && viewData.labels && viewData.data) {
                new Chart(userViewCtx, {
                    type: 'line',
                    data: {
                        labels: viewData.labels,
                        datasets: [{
                            label: 'ì¼ì¼ ì¡°íšŒìˆ˜',
                            data: viewData.data,
                            borderColor: 'rgba(79, 70, 229, 1)',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } else {
                userViewCtx.getContext('2d').fillText('ì¡°íšŒ íŒ¨í„´ì„ ë¶„ì„í•˜ëŠ” ì¤‘...', 200, 150);
            }
        }
    }

    // ìƒ‰ìƒ ìƒì„± í•¨ìˆ˜
    function generateColors(count) {
        const colors = [
            '#4f46e5', '#7c3aed', '#10b981', '#f59e0b',
            '#ef4444', '#06b6d4', '#84cc16', '#f97316'
        ];
        const result = [];
        for (let i = 0; i < count; i++) {
            result.push(colors[i % colors.length]);
        }
        return result;
    }

    // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
    function startRealtimeUpdates() {
        setInterval(() => {
            updateLastUpdatedTime();
        }, 30000); // 30ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    }

    function updateLastUpdatedTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('ko-KR');
        const lastUpdatedElement = document.getElementById('lastUpdated');
        if (lastUpdatedElement) {
            lastUpdatedElement.textContent = timeString;
        }
    }

    // í†µê³„ ìƒˆë¡œê³ ì¹¨
    function refreshStats() {
        const refreshBtn = document.querySelector('.refresh-btn');
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ì—…ë°ì´íŠ¸ ì¤‘...';
            refreshBtn.disabled = true;

            setTimeout(() => {
                location.reload();
            }, 1000);
        }
    }

    // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ (ì•ˆì „í•˜ê²Œ ìˆ˜ì •)
    function animateNumbers() {
        document.querySelectorAll('.stat-number, .realtime-number, .user-number').forEach(el => {
            const textContent = el.textContent || '0';
            const target = parseInt(textContent.replace(/,/g, '')) || 0;

            if (target > 0) {
                const duration = 2000;
                const start = Date.now();
                const startValue = 0;

                function update() {
                    const now = Date.now();
                    const progress = Math.min((now - start) / duration, 1);
                    const current = Math.floor(startValue + (target - startValue) * progress);
                    el.textContent = current.toLocaleString();

                    if (progress < 1) {
                        requestAnimationFrame(update);
                    }
                }
                update();
            }
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
    setTimeout(animateNumbers, 500);

    // ì¹´ë“œ í˜¸ë²„ íš¨ê³¼ (ì•ˆì „í•˜ê²Œ ìˆ˜ì •)
    document.querySelectorAll('.stat-card, .popular-item, .latest-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
        });

        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });

    // ì—ëŸ¬ ì²˜ë¦¬ í•¨ìˆ˜
    function handleChartError(chartId, error) {
        console.error(`ì°¨íŠ¸ ${chartId} ë¡œë“œ ì‹¤íŒ¨:`, error);
        const canvas = document.getElementById(chartId);
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.font = '16px Arial';
            ctx.fillStyle = '#6b7280';
            ctx.textAlign = 'center';
            ctx.fillText('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', canvas.width / 2, canvas.height / 2);
        }
    }
</script>

<!-- Stats-specific styles -->
<style>
    .stats-page {
        background: #f8fafc;
    }

    .page-header {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        padding: 3rem 2rem;
        margin-bottom: 2rem;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .header-content h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .header-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .refresh-btn {
        padding: 0.75rem 1.5rem;
        background: rgba(255,255,255,0.2);
        color: white;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .refresh-btn:hover:not(:disabled) {
        background: rgba(255,255,255,0.3);
        border-color: rgba(255,255,255,0.5);
    }

    .last-updated {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    /* Stats Dashboard */
    .stats-dashboard {
        margin-bottom: 3rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 4px solid;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        opacity: 0.1;
        background: currentColor;
        border-radius: 50%;
        transform: translate(30%, -30%);
    }

    .stat-card.primary {
        border-left-color: #4f46e5;
        color: #4f46e5;
    }

    .stat-card.secondary {
        border-left-color: #7c3aed;
        color: #7c3aed;
    }

    .stat-card.success {
        border-left-color: #10b981;
        color: #10b981;
    }

    .stat-card.warning {
        border-left-color: #f59e0b;
        color: #f59e0b;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .stat-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
        opacity: 0.8;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        line-height: 1;
    }

    .stat-label {
        color: #6b7280;
        font-size: 0.9rem;
        margin: 0.5rem 0;
    }

    .stat-change {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .stat-change.positive {
        color: #10b981;
    }

    .stat-change.negative {
        color: #ef4444;
    }

    /* Realtime Section */
    .realtime-section {
        margin-bottom: 3rem;
    }

    .realtime-section h2 {
        margin-bottom: 2rem;
        color: #374151;
    }

    .realtime-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
    }

    .realtime-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .realtime-card:hover {
        border-color: #4f46e5;
        transform: translateY(-2px);
    }

    .realtime-card h4 {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .realtime-number {
        font-size: 2rem;
        font-weight: 700;
        color: #4f46e5;
        margin-bottom: 0.5rem;
    }

    .realtime-keyword {
        font-size: 1.2rem;
        font-weight: 600;
        color: #ef4444;
        margin-bottom: 0.5rem;
    }

    .realtime-card p {
        color: #9ca3af;
        font-size: 0.8rem;
        margin: 0;
    }

    /* Category Section */
    .category-section {
        margin-bottom: 3rem;
    }

    .category-stats-container {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 2rem;
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .chart-container {
        position: relative;
        height: 300px;
    }

    .category-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .category-table th,
    .category-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #f3f4f6;
    }

    .category-table th {
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
    }

    .category-name {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .progress-bar {
        position: relative;
        background: #f3f4f6;
        border-radius: 1rem;
        height: 1.5rem;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        border-radius: 1rem;
        transition: width 0.5s ease;
    }

    .progress-bar span {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.8rem;
        font-weight: 600;
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    /* Price Section */
    .price-section {
        margin-bottom: 3rem;
    }

    .price-chart-container {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
        height: 400px;
        position: relative;
    }

    .price-summary {
        display: flex;
        justify-content: center;
        gap: 3rem;
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .price-stat {
        text-align: center;
    }

    .price-stat .label {
        color: #6b7280;
        font-size: 0.9rem;
        display: block;
        margin-bottom: 0.5rem;
    }

    .price-stat .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #4f46e5;
    }

    /* Popular Section */
    .popular-section {
        margin-bottom: 3rem;
    }

    .popular-list {
        background: white;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .popular-item {
        display: flex;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #f3f4f6;
        transition: all 0.3s ease;
    }

    .popular-item:last-child {
        border-bottom: none;
    }

    .popular-item:hover {
        background: #f9fafb;
    }

    .rank {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.2rem;
        margin-right: 1rem;
    }

    .rank-1, .rank-2, .rank-3 {
        color: white;
    }

    .rank-1 { background: linear-gradient(45deg, #ffd700, #ffed4e); }
    .rank-2 { background: linear-gradient(45deg, #c0c0c0, #e5e7eb); }
    .rank-3 { background: linear-gradient(45deg, #cd7f32, #d97706); }

    .rank:not(.rank-1):not(.rank-2):not(.rank-3) {
        background: #f3f4f6;
        color: #6b7280;
    }

    .item-image {
        width: 60px;
        height: 60px;
        border-radius: 0.5rem;
        overflow: hidden;
        margin-right: 1rem;
    }

    .item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .item-info {
        flex: 1;
    }

    .item-info h4 {
        margin: 0 0 0.25rem 0;
        font-size: 1rem;
    }

    .item-info h4 a {
        text-decoration: none;
        color: #374151;
        transition: color 0.3s ease;
    }

    .item-info h4 a:hover {
        color: #4f46e5;
    }

    .price {
        color: #4f46e5;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
    }

    .stats {
        display: flex;
        gap: 1rem;
        font-size: 0.875rem;
        color: #6b7280;
    }

    .stats span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .growth-indicator {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.875rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        background: #f3f4f6;
    }

    /* Latest Section */
    .latest-section {
        margin-bottom: 3rem;
    }

    .latest-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
    }

    .latest-card {
        background: white;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }

    .latest-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .latest-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }

    .latest-info {
        padding: 1rem;
    }

    .latest-info h5 {
        margin: 0 0 0.5rem 0;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .latest-info p {
        color: #4f46e5;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
    }

    .latest-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .date {
        color: #6b7280;
        font-size: 0.8rem;
    }

    .new-badge {
        background: #10b981;
        color: white;
        font-size: 0.7rem;
        font-weight: 700;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
    }

    /* User Section */
    .user-section {
        margin-bottom: 3rem;
    }

    .user-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .user-stat-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border-top: 4px solid #4f46e5;
    }

    .user-stat-card h4 {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .user-number {
        font-size: 2rem;
        font-weight: 700;
        color: #4f46e5;
        margin-bottom: 0.5rem;
    }

    .user-category {
        font-size: 1.2rem;
        font-weight: 600;
        color: #10b981;
        margin-bottom: 0.5rem;
    }

    .user-chart-container {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        height: 300px;
        position: relative;
    }

    .user-chart-container h3 {
        margin-bottom: 1rem;
        color: #374151;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .category-stats-container {
            grid-template-columns: 1fr;
        }

        .price-summary {
            gap: 1.5rem;
        }
    }

    @media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            text-align: center;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .realtime-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .popular-item {
            flex-wrap: wrap;
            gap: 1rem;
        }

        .item-info {
            min-width: 200px;
        }

        .price-summary {
            flex-direction: column;
            gap: 1rem;
        }
    }
</style>
</body>
</html>