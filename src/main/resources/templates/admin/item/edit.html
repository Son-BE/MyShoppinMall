<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}"/>
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>상품 수정 | SonStarMall 관리자</title>

    <!-- Font Awesome & Google Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          crossorigin="anonymous"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/item_edit.css">

    <style>
        /* 색상 선택 관련 스타일 */
        .color-selection {
            margin: 20px 0;
        }

        .color-picker-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .color-option-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
            margin-top: 10px;
            max-width: 400px;
        }

        .color-item {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-item:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .color-item.selected {
            border: 3px solid #007bff;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .color-item.selected::after {
            content: '✓';
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }

        .color-label {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }

        .color-preview {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .color-preview-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-preview-swatch {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .color-preview-text {
            font-size: 14px;
            color: #666;
        }

        .form-section {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-grid-full {
            grid-column: 1 / -1;
        }

        .form-label.required::after {
            content: ' *';
            color: #e74c3c;
        }
    </style>
</head>

<body>
<!-- Admin Header -->
<header class="admin-header">
    <div class="header-content">
        <a href="/dashboard" class="admin-brand">
            <i class="fa-solid fa-chart-line"></i>
            SonStarMall 관리자
        </a>
        <div class="header-actions">
            <div class="admin-user">
                <i class="fa-solid fa-user-shield"></i>
                <span th:text="${#authentication.name}">관리자</span>
            </div>
            <form th:action="@{/logout}" method="post" style="margin: 0;">
                <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}"
                       th:value="${_csrf.token}"/>
                <button type="submit" class="logout-btn">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    로그아웃
                </button>
            </form>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="main-content">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fa-solid fa-edit"></i>
            상품 수정
        </h1>
        <div class="header-actions-buttons">
            <a href="/admin/items" class="btn btn-secondary">
                <i class="fa-solid fa-list"></i>
                상품 목록
            </a>
            <a href="/dashboard" class="btn btn-secondary">
                <i class="fa-solid fa-arrow-left"></i>
                대시보드
            </a>
        </div>
    </div>

    <div class="form-container">
        <div class="form-header">
            <h2 class="form-title">
                <i class="fa-solid fa-box"></i>
                상품 정보 수정
            </h2>
        </div>

        <div class="form-content">
            <form id="editForm"
                  th:action="@{/admin/items/{id}(id=${item.id})}"
                  method="post"
                  enctype="multipart/form-data">
                <input type="hidden" name="_method" value="put"/>
                <input type="hidden" id="itemId" th:value="${item.id}"/>

                <!-- 기본 정보 섹션 -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fa-solid fa-info-circle"></i>
                        기본 정보
                    </h3>

                    <div class="form-group form-grid-full">
                        <label for="itemName" class="form-label required">상품명</label>
                        <input type="text" name="itemName" class="form-control" id="itemName" th:value="${item.itemName}"
                               required placeholder="상품명을 입력하세요"/>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="price" class="form-label required">가격 (₩)</label>
                            <input type="number" name="price" class="form-control" id="price" th:value="${item.price}"
                                   min="0" step="1" required placeholder="0"/>
                        </div>

                        <div class="form-group">
                            <label for="quantity" class="form-label required">재고 수량</label>
                            <input type="number" name="quantity" class="form-control" id="quantity"
                                   th:value="${item.quantity}" min="0" step="1" required placeholder="0"/>
                        </div>
                    </div>

                    <div class="form-group form-grid-full">
                        <label for="itemComment" class="form-label required">상품 설명</label>
                        <textarea name="itemComment" class="form-control" id="itemComment" rows="4"
                                  required placeholder="상품에 대한 설명을 입력하세요" th:text="${item.itemComment}"></textarea>
                    </div>
                </div>

                <!-- 색상 선택 섹션 -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fa-solid fa-palette"></i>
                        색상 정보
                    </h3>

                    <div class="color-selection">
                        <div class="color-picker-container">
                            <!-- 주 색상 선택 -->
                            <div class="color-option-group">
                                <label class="color-label required">주 색상 (Primary Color)</label>
                                <div class="color-palette" id="primaryColorPalette">
                                    <div class="color-item" data-color="BLACK" style="background-color: #000000;" title="블랙"></div>
                                    <div class="color-item" data-color="WHITE" style="background-color: #FFFFFF; border-color: #ccc;" title="화이트"></div>
                                    <div class="color-item" data-color="GRAY" style="background-color: #808080;" title="그레이"></div>
                                    <div class="color-item" data-color="RED" style="background-color: #FF0000;" title="레드"></div>
                                    <div class="color-item" data-color="BLUE" style="background-color: #0000FF;" title="블루"></div>
                                    <div class="color-item" data-color="GREEN" style="background-color: #00FF00;" title="그린"></div>
                                    <div class="color-item" data-color="YELLOW" style="background-color: #FFFF00;" title="옐로우"></div>
                                    <div class="color-item" data-color="ORANGE" style="background-color: #FFA500;" title="오렌지"></div>
                                    <div class="color-item" data-color="PURPLE" style="background-color: #800080;" title="퍼플"></div>
                                    <div class="color-item" data-color="PINK" style="background-color: #FFC0CB;" title="핑크"></div>
                                    <div class="color-item" data-color="BROWN" style="background-color: #A52A2A;" title="브라운"></div>
                                    <div class="color-item" data-color="NAVY" style="background-color: #000080;" title="네이비"></div>
                                    <div class="color-item" data-color="BEIGE" style="background-color: #FFE4B5;" title="베이지"></div>
                                    <div class="color-item" data-color="SILVER" style="background-color: #C0C0C0;" title="실버"></div>
                                </div>
                                <input type="hidden" name="primaryColor" id="primaryColorValue" th:value="${item.primaryColor}">
                            </div>

                            <!-- 보조 색상 선택 -->
                            <div class="color-option-group">
                                <label class="color-label">보조 색상 (Secondary Color)</label>
                                <div class="color-palette" id="secondaryColorPalette">
                                    <div class="color-item" data-color="BLACK" style="background-color: #000000;" title="블랙"></div>
                                    <div class="color-item" data-color="WHITE" style="background-color: #FFFFFF; border-color: #ccc;" title="화이트"></div>
                                    <div class="color-item" data-color="GRAY" style="background-color: #808080;" title="그레이"></div>
                                    <div class="color-item" data-color="RED" style="background-color: #FF0000;" title="레드"></div>
                                    <div class="color-item" data-color="BLUE" style="background-color: #0000FF;" title="블루"></div>
                                    <div class="color-item" data-color="GREEN" style="background-color: #00FF00;" title="그린"></div>
                                    <div class="color-item" data-color="YELLOW" style="background-color: #FFFF00;" title="옐로우"></div>
                                    <div class="color-item" data-color="ORANGE" style="background-color: #FFA500;" title="오렌지"></div>
                                    <div class="color-item" data-color="PURPLE" style="background-color: #800080;" title="퍼플"></div>
                                    <div class="color-item" data-color="PINK" style="background-color: #FFC0CB;" title="핑크"></div>
                                    <div class="color-item" data-color="BROWN" style="background-color: #A52A2A;" title="브라운"></div>
                                    <div class="color-item" data-color="NAVY" style="background-color: #000080;" title="네이비"></div>
                                    <div class="color-item" data-color="BEIGE" style="background-color: #FFE4B5;" title="베이지"></div>
                                    <div class="color-item" data-color="SILVER" style="background-color: #C0C0C0;" title="실버"></div>
                                </div>
                                <input type="hidden" name="secondaryColor" id="secondaryColorValue" th:value="${item.secondaryColor}">
                            </div>

                            <!-- 색상 미리보기 -->
                            <div class="color-preview">
                                <div class="color-preview-item">
                                    <span class="color-preview-text">주 색상:</span>
                                    <div class="color-preview-swatch" id="primaryColorPreview"></div>
                                    <span id="primaryColorName">미선택</span>
                                </div>
                                <div class="color-preview-item">
                                    <span class="color-preview-text">보조 색상:</span>
                                    <div class="color-preview-swatch" id="secondaryColorPreview" style="border: 2px dashed #ccc;"></div>
                                    <span id="secondaryColorName">미선택</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 이미지 업로드 섹션 -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fa-solid fa-images"></i>
                        상품 이미지
                    </h3>

                    <!-- 현재 이미지 표시 -->
                    <div class="current-image" th:if="${item.imageUrl != null and item.imageUrl != ''}">
                        <div class="current-image-label">현재 이미지</div>
                        <img th:src="${item.imageUrl}" alt="현재 상품 이미지"/>
                    </div>

                    <!-- 이미지 업로드 영역 -->
                    <div class="image-upload-section" id="dropZone" ondrop="handleDrop(event)"
                         ondragover="handleDragOver(event)" onclick="document.getElementById('imageFile').click()">
                        <input type="file" name="imageFile" id="imageFile" accept="image/*"
                               onchange="handleFileSelect(event)"/>
                        <div class="upload-icon">
                            <i class="fa-solid fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">새 이미지를 선택하거나</div>
                        <div class="upload-hint">여기에 드래그 앤 드롭하세요</div>
                    </div>

                    <!-- 이미지 미리보기 -->
                    <div id="imagePreviewContainer" class="image-preview-container"></div>
                </div>

                <!-- 분류 정보 섹션 -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fa-solid fa-tags"></i>
                        분류 정보
                    </h3>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="gender" class="form-label required">성별</label>
                            <select name="gender" class="form-select" id="gender" required>
                                <option value="">성별 선택</option>
                                <option value="MALE" th:selected="${item.gender == 'MALE'}">남성</option>
                                <option value="FEMALE" th:selected="${item.gender == 'FEMALE'}">여성</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="ageGroup" class="form-label required">연령대</label>
                            <select name="ageGroup" class="form-select" id="ageGroup" required>
                                <option value="">연령대 선택</option>
                                <option value="TEEN" th:selected="${item.ageGroup == 'TEEN'}">10대</option>
                                <option value="TWENTY" th:selected="${item.ageGroup == 'TWENTY'}">20대</option>
                                <option value="THIRTY" th:selected="${item.ageGroup == 'THIRTY'}">30대</option>
                                <option value="FORTY" th:selected="${item.ageGroup == 'FORTY'}">40대</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="styles" class="form-label required">스타일</label>
                            <select name="style" class="form-select" id="styles" required>
                                <option value="">스타일 선택</option>
                                <option value="CASUAL" th:selected="${item.style == 'CASUAL'}">캐주얼</option>
                                <option value="DANDY" th:selected="${item.style == 'DANDY'}">댄디</option>
                                <option value="MINIMAL" th:selected="${item.style == 'MINIMAL'}">미니멀</option>
                                <option value="RETRO" th:selected="${item.style == 'RETRO'}">레트로</option>
                                <option value="LOVELY" th:selected="${item.style == 'LOVELY'}">러블리</option>
                                <option value="FORMAL" th:selected="${item.style == 'FORMAL'}">포멀</option>
                                <option value="SPORTY" th:selected="${item.style == 'SPORTY'}">스포티</option>
                                <option value="UNIQUE" th:selected="${item.style == 'UNIQUE'}">개성있는</option>
                                <option value="CUTE" th:selected="${item.style == 'CUTE'}">귀여운</option>
                                <option value="CHIC" th:selected="${item.style == 'CHIC'}">시크</option>
                                <option value="CLEAN" th:selected="${item.style == 'CLEAN'}">깔끔한</option>
                                <option value="SOFT" th:selected="${item.style == 'SOFT'}">부드러운</option>
                                <option value="FRESH" th:selected="${item.style == 'FRESH'}">산뜻한</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="season" class="form-label required">시즌</label>
                            <select name="season" class="form-select" id="season" required>
                                <option value="">시즌 선택</option>
                                <option value="SPRING" th:selected="${item.season == 'SPRING'}">봄</option>
                                <option value="SUMMER" th:selected="${item.season == 'SUMMER'}">여름</option>
                                <option value="AUTUMN" th:selected="${item.season == 'AUTUMN'}">가을</option>
                                <option value="WINTER" th:selected="${item.season == 'WINTER'}">겨울</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="category" class="form-label required">카테고리</label>
                            <select name="category" class="form-select" id="category" required>
                                <option value="">카테고리를 선택하세요</option>
                                <option th:each="cat : ${categories}" th:value="${cat.name()}"
                                        th:text="${cat.displayName}"
                                        th:selected="${cat.name() == item.category}"></option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="subCategory" class="form-label required">서브 카테고리</label>
                            <select name="subCategory" class="form-select" id="subCategory" required>
                                <option value="">먼저 카테고리를 선택하세요</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 폼 액션 버튼 -->
                <div class="form-actions">
                    <a href="javascript:history.back()" class="btn btn-back">
                        <i class="fa-solid fa-arrow-left"></i>
                        뒤로가기
                    </a>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fa-solid fa-save"></i>
                        수정 완료
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<script>
    // 색상 관련 변수
    let selectedPrimaryColor = null;
    let selectedSecondaryColor = null;

    // 색상 enum과 hex 코드 매핑
    const colorMapping = {
        'BLACK': '#000000',
        'WHITE': '#FFFFFF',
        'GRAY': '#808080',
        'RED': '#FF0000',
        'BLUE': '#0000FF',
        'GREEN': '#00FF00',
        'YELLOW': '#FFFF00',
        'ORANGE': '#FFA500',
        'PURPLE': '#800080',
        'PINK': '#FFC0CB',
        'BROWN': '#A52A2A',
        'NAVY': '#000080',
        'BEIGE': '#FFE4B5',
        'SILVER': '#C0C0C0'
    };

    // 색상 선택 이벤트 리스너 추가
    function initializeColorSelection() {
        // 주 색상 팔레트
        document.querySelectorAll('#primaryColorPalette .color-item').forEach(item => {
            item.addEventListener('click', function() {
                selectPrimaryColor(this.dataset.color, this.title || this.dataset.color);
            });
        });

        // 보조 색상 팔레트
        document.querySelectorAll('#secondaryColorPalette .color-item').forEach(item => {
            item.addEventListener('click', function() {
                selectSecondaryColor(this.dataset.color, this.title || this.dataset.color);
            });
        });
    }

    // 주 색상 선택
    function selectPrimaryColor(colorEnum, name) {
        // 이전 선택 해제
        document.querySelectorAll('#primaryColorPalette .color-item').forEach(item => {
            item.classList.remove('selected');
        });

        // 현재 선택 표시
        document.querySelector(`#primaryColorPalette .color-item[data-color="${colorEnum}"]`).classList.add('selected');

        selectedPrimaryColor = colorEnum;
        document.getElementById('primaryColorValue').value = colorEnum;
        document.getElementById('primaryColorPreview').style.backgroundColor = colorMapping[colorEnum];
        document.getElementById('primaryColorName').textContent = name;
    }

    // 보조 색상 선택
    function selectSecondaryColor(colorEnum, name) {
        // 이전 선택 해제
        document.querySelectorAll('#secondaryColorPalette .color-item').forEach(item => {
            item.classList.remove('selected');
        });

        // 현재 선택 표시
        document.querySelector(`#secondaryColorPalette .color-item[data-color="${colorEnum}"]`).classList.add('selected');

        selectedSecondaryColor = colorEnum;
        document.getElementById('secondaryColorValue').value = colorEnum;
        document.getElementById('secondaryColorPreview').style.backgroundColor = colorMapping[colorEnum];
        document.getElementById('secondaryColorName').textContent = name;
    }

    // 기존 색상 값 로드
    function loadExistingColors() {
        const primaryColorValue = document.getElementById('primaryColorValue').value;
        const secondaryColorValue = document.getElementById('secondaryColorValue').value;

        if (primaryColorValue && colorMapping[primaryColorValue]) {
            selectPrimaryColor(primaryColorValue, primaryColorValue);
        }

        if (secondaryColorValue && colorMapping[secondaryColorValue]) {
            selectSecondaryColor(secondaryColorValue, secondaryColorValue);
        }
    }

    // 카테고리 변경 시 서브 카테고리 업데이트
    function updateSubCategories() {
        const category = document.getElementById('category').value;
        const subCategorySelect = document.getElementById('subCategory');
        const currentSubCategory = subCategorySelect.dataset.currentValue;

        if (category) {
            subCategorySelect.innerHTML = '<option value="">로딩 중...</option>';

            fetch(`/admin/items/get-subcategories?category=${category}`)
                .then(response => response.json())
                .then(data => {
                    subCategorySelect.innerHTML = '<option value="">서브 카테고리를 선택하세요</option>';

                    Object.values(data).forEach(subCategory => {
                        subCategory.forEach(sub => {
                            const option = document.createElement('option');
                            option.value = sub;
                            option.textContent = sub;
                            if (sub === currentSubCategory) {
                                option.selected = true;
                            }
                            subCategorySelect.appendChild(option);
                        });
                    });
                })
                .catch(error => {
                    console.error('서브 카테고리 불러오기 오류:', error);
                    subCategorySelect.innerHTML = '<option value="">오류가 발생했습니다</option>';
                });
        } else {
            subCategorySelect.innerHTML = '<option value="">먼저 카테고리를 선택하세요</option>';
        }
    }

    function validateForm() {
        return true;
    }

    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            z-index: 3000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            max-width: 300px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        `;

        if (type === 'success') {
            toast.style.background = '#10b981';
        } else {
            toast.style.background = '#ef4444';
        }
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateX(0)';
        }, 100);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
    }

    // 드래그 앤 드롭 핸들러
    function handleDragOver(event) {
        event.preventDefault();
        document.getElementById('dropZone').classList.add('dragover');
    }

    function handleDrop(event) {
        event.preventDefault();
        document.getElementById('dropZone').classList.remove('dragover');

        const files = event.dataTransfer.files;
        if (files.length > 0) {
            const imageFile = document.getElementById('imageFile');
            imageFile.files = files;
            handleFileSelect({target: imageFile});
        }
    }

    // 파일 선택 핸들러
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file || !file.type.startsWith('image/')) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = `
                <div class="preview-item">
                  <img src="${e.target.result}" alt="미리보기" class="preview-thumb" />
                  <button type="button" class="preview-remove" onclick="removePreview()">
                    <i class="fa-solid fa-times"></i>
                  </button>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    }

    function removePreview() {
        document.getElementById('imagePreviewContainer').innerHTML = '';
        document.getElementById('imageFile').value = '';
    }

    function updateItem(e) {
        e.preventDefault();

        if (!validateForm()) {
            return;
        }

        // 주 색상 필수 검증
        if (!selectedPrimaryColor) {
            showToast('주 색상을 선택해주세요.', 'error');
            return;
        }

        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;

        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 수정 중...';
        submitBtn.classList.add('loading');

        const itemId = document.getElementById('itemId').value;
        const formData = new FormData();

        formData.append('itemName', document.getElementById('itemName').value.trim());
        formData.append('itemComment', document.getElementById('itemComment').value.trim());
        formData.append('price', document.getElementById('price').value);
        formData.append('quantity', document.getElementById('quantity').value);
        formData.append('gender', document.getElementById('gender').value);
        formData.append('ageGroup', document.getElementById('ageGroup').value);
        formData.append('style', document.getElementById('styles').value);
        formData.append('season', document.getElementById('season').value);
        formData.append('category', document.getElementById('category').value);
        formData.append('subCategory', document.getElementById('subCategory').value);
        formData.append('primaryColor', selectedPrimaryColor);
        if (selectedSecondaryColor) {
            formData.append('secondaryColor', selectedSecondaryColor);
        }

        const imageFile = document.getElementById('imageFile').files[0];
        if (imageFile) {
            formData.append('imageFile', imageFile);
        }

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        fetch('/admin/items/' + itemId, {
            method: 'PUT',
            headers: {
                [csrfHeader]: csrfToken
            },
            body: formData
        })
            .then(response => {
                if (response.ok) {
                    showToast('상품이 성공적으로 수정되었습니다!', 'success');
                    setTimeout(() => {
                        window.location.href = '/admin/items';
                    }, 2000);
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            })
            .catch(error => {
                console.error('수정 오류:', error);
                showToast('상품 수정에 실패했습니다. 다시 시도해주세요.', 'error');

                submitBtn.innerHTML = originalText;
                submitBtn.classList.remove('loading');
            });
    }

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function () {
        // 색상 선택 초기화
        initializeColorSelection();

        // 기존 색상 값 로드
        loadExistingColors();

        // 현재 서브카테고리 값 저장
        const subCategorySelect = document.getElementById('subCategory');
        // subCategorySelect.dataset.currentValue = '[[${item.subCategory}]]';

        // 카테고리 변경 이벤트
        document.getElementById('category').addEventListener('change', updateSubCategories);

        // 초기 서브카테고리 로드
        if (document.getElementById('category').value) {
            updateSubCategories();
        }

        // 폼 제출 이벤트
        document.getElementById('editForm').addEventListener('submit', updateItem);

        // 기타 이벤트 리스너들...
        const inputs = document.querySelectorAll('.form-control, .form-select');
        inputs.forEach(input => {
            input.addEventListener('blur', function () {
                if (this.hasAttribute('required') && !this.value.trim()) {
                    this.style.borderColor = 'var(--error)';
                } else {
                    this.style.borderColor = 'var(--border)';
                }
            });
        });

        // 숫자 입력 필드 검증
        const numberInputs = document.querySelectorAll('input[type="number"]');
        numberInputs.forEach(input => {
            input.addEventListener('input', function () {
                if (this.value < 0) {
                    this.value = 0;
                }
            });
        });
    });
</script>
</body>
</html>