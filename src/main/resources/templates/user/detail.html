<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${item.itemName} + ' - 상품 상세'">상품 상세 | SonStarMall</title>

    <!-- Font Awesome & Google Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          crossorigin="anonymous"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/item_detail.css">

    <!-- CSRF 토큰 메타 -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

</head>

<body>
<!-- Header -->
<header class="header" role="banner">
    <div class="header-content">
        <h1 class="logo"
            onclick="window.location.href='/'"
            tabindex="0"
            role="button"
            aria-label="SonStarMall 홈으로 이동"
            onkeypress="if(event.key==='Enter') window.location.href='/'">
            SonStarMall
        </h1>

        <nav class="header-nav" aria-label="주요 메뉴">
            <a href="/" class="header-nav-link">
                <i class="fa-solid fa-box" aria-hidden="true"></i>
                <span>전체상품</span>
            </a>
            <a href="/orders/myOrder" class="header-nav-link">
                <i class="fa-solid fa-receipt" aria-hidden="true"></i>
                <span>주문내역</span>
            </a>
            <a href="/board?category=NOTICE" class="header-nav-link">
                <i class="fa-solid fa-comments" aria-hidden="true"></i>
                <span>게시판</span>
            </a>
        </nav>

        <div class="header-search">
            <form method="get" action="/search" role="search">
                <i class="fa-solid fa-search search-icon" aria-hidden="true"></i>
                <input type="text"
                       name="query"
                       class="search-input"
                       placeholder="상품을 검색하세요..."
                       aria-label="상품 검색"
                       required>
            </form>
        </div>

        <nav class="header-actions" aria-label="사용자 메뉴">
            <div th:if="${#authorization.expression('isAuthenticated()')}" class="user-info">
                <a th:href="@{/user/cart}" class="auth-button" aria-label="장바구니">
                    <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
                    <span>장바구니</span>
                </a>

                <a th:href="@{/user/wishList}" class="auth-button" aria-label="찜 목록">
                    <i class="fa-solid fa-heart" aria-hidden="true"></i>
                    <span>찜 목록</span>
                </a>

                <a th:href="@{/members/profile}" class="auth-button" aria-label="프로필 페이지 이동">
                    <i class="fa-solid fa-user" aria-hidden="true"></i>
                    <span th:text="${#authentication.name}">사용자</span>
                </a>

                <form th:action="@{/logout}" method="post" style="display:inline;">
                    <input type="hidden"
                           th:if="${_csrf != null}"
                           th:name="${_csrf.parameterName}"
                           th:value="${_csrf.token}" />
                    <button type="submit" class="auth-button logout-button" aria-label="로그아웃">
                        <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>
                        <span>로그아웃</span>
                    </button>
                </form>
            </div>

            <div th:unless="${#authorization.expression('isAuthenticated()')}" class="user-info">
                <a th:href="@{/login}" class="auth-button" aria-label="로그인">
                    <i class="fa-solid fa-right-to-bracket" aria-hidden="true"></i>
                    <span>로그인</span>
                </a>
                <a th:href="@{/signup}" class="auth-button" aria-label="회원가입">
                    <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
                    <span>회원가입</span>
                </a>
            </div>
        </nav>
    </div>
</header>

<!-- Main Content -->
<main class="main-content">
    <!-- Product Container -->
    <div class="product-container">
        <div class="product-layout">
            <!-- Product Image -->
            <div class="image-section">
                <img class="product-image" th:src="${item.imagePath}" th:alt="${item.itemName} + ' 상품 이미지'"
                     onerror="this.onerror=null;this.src='/images/default.png';"/>
                <div class="image-overlay"></div>
            </div>

            <!-- Product Info -->
            <div class="info-section">
                <h1 class="product-title" th:text="${item.itemName}">상품명</h1>
                <div class="product-price" th:text="'₩' + ${#numbers.formatInteger(item.price, 3, 'COMMA')}">₩0</div>
                <p class="product-description" th:text="${item.itemComment}">상품 설명</p>

                <div class="product-meta">
                    <div class="meta-item">
                        <div class="meta-label">카테고리</div>
                        <div class="meta-value" th:text="${item.subCategory}">카테고리</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">성별</div>
                        <div class="meta-value" th:text="${item.gender}">성별</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">재고</div>
                        <div class="meta-value" th:text="${item.quantity} + '개'">0개</div>
                    </div>
                </div>

                <div th:if="${item.quantity == 0}" class="sold-out-badge">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    품절된 상품입니다
                </div>

                <!-- Quantity Selection -->
                <div th:if="${item.quantity > 0}" class="quantity-section">
                    <span class="quantity-label">수량</span>
                    <div class="quantity-control">
                        <button type="button" class="quantity-btn" onclick="decreaseQuantity()">
                            <i class="fa-solid fa-minus"></i>
                        </button>
                        <input type="number" id="quantityInput" class="quantity-input" min="1"
                               th:max="${item.quantity}" value="1" readonly/>
                        <button type="button" class="quantity-btn" onclick="increaseQuantity()">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="product-actions">
                    <form th:action="@{/user/cart/add}" method="post" onsubmit="return confirmAddToCart()" style="flex: 1;">
                        <input type="hidden" name="itemId" th:value="${item.id}"/>
                        <input type="hidden" name="quantity" id="cartQuantity" value="1"/>
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="action-btn btn-cart" th:disabled="${item.quantity == 0}">
                            <i class="fa-solid fa-cart-plus"></i>
                            장바구니 담기
                        </button>
                    </form>

                    <form th:action="@{/wishList/add}" method="post" onsubmit="return confirmAddToWishlist()" style="flex: 1;">
                        <input type="hidden" name="itemId" th:value="${item.id}"/>
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="action-btn btn-wishlist" th:disabled="${item.quantity == 0}">
                            <i class="fa-solid fa-heart"></i>
                            찜하기
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="reviews-section">
        <h2 class="section-title">
            <i class="fa-solid fa-star"></i>
            상품 후기
        </h2>

        <!-- Rating Summary -->
        <div class="rating-summary">
            <div class="rating-stars"
                 th:text="${'★'.repeat(T(java.lang.Math).round(averageRating)) + '☆'.repeat(5 - T(java.lang.Math).round(averageRating))}">
                ★★★★☆
            </div>
            <div>
                <div class="rating-score" th:text="${#numbers.formatDecimal(averageRating, 1, 1)}">4.2</div>
                <div class="rating-text">/ 5.0 점</div>
            </div>
        </div>

        <!-- Reviews List -->
        <ul class="reviews-list" id="reviewsList">
            <li class="review-item" th:each="review : ${reviews}"
                th:attr="data-review-id=${review.id}, data-member-id=${review.member.id}">
                <div class="review-header">
                    <div class="reviewer-info">
                        <span class="reviewer-name" th:text="${review.member.nickName}">홍길동</span>
                        <span th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.member.id == review.member.id}"
                              class="my-review-badge">
                            <i class="fa-solid fa-user-check"></i>
                            내 리뷰
                        </span>
                        <div class="review-rating">
                            <span th:each="i : ${#numbers.sequence(1, 5)}"
                                  th:text="${i <= review.rating ? '★' : '☆'}"></span>
                        </div>
                    </div>
                    <span class="review-date" th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd')}">2025-01-01</span>
                </div>
                <p class="review-content" th:text="${review.content}">
                    아주 만족스러워요!
                </p>

                <div th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.member.id == review.member.id}"
                     class="review-actions">
                    <button type="button" class="review-action-btn review-edit-btn"
                            th:onclick="|openEditModal(${review.id}, '${review.content}', ${review.rating})|">
                        <i class="fa-solid fa-edit"></i>
                        수정
                    </button>
                    <button type="button" class="review-action-btn review-delete-btn"
                            th:onclick="|deleteReview(${review.id})|">
                        <i class="fa-solid fa-trash"></i>
                        삭제
                    </button>
                </div>
            </li>
        </ul>

        <!-- Empty Reviews State -->
        <div id="emptyReviewsState" th:if="${#lists.isEmpty(reviews)}"
             style="text-align: center; padding: 3rem; color: var(--text-light);">
            <i class="fa-solid fa-comment-slash" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <h3 style="margin-bottom: 0.5rem;">아직 후기가 없습니다</h3>
            <p>첫 번째 후기를 남겨보세요!</p>
        </div>

        <!-- Review Form -->
        <div class="review-form-section" th:if="${#authorization.expression('isAuthenticated()')}">
            <h3 class="form-title">
                <i class="fa-solid fa-edit"></i>
                후기 작성하기
            </h3>
            <form id="reviewForm" class="review-form">
                <input type="hidden" id="itemId" th:value="${item.id}" />
                <input type="hidden" id="memberId" th:value="${#authentication.principal.member.id}" />
                <input type="hidden" id="orderId" th:value="${orderId} ?: 0" />

                <div class="form-group">
                    <label for="orderDetailId" class="form-label">
                        <i class="fa-solid fa-box"></i>
                        주문 선택 (선택사항)
                    </label>
                    <select id="orderDetailId" class="form-select">
                        <option value="">선택 안 함</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="rating" class="form-label">
                        <i class="fa-solid fa-star"></i>
                        별점
                    </label>
                    <select id="rating" class="form-select" required>
                        <option value="5">⭐⭐⭐⭐⭐ 5점 (매우 만족)</option>
                        <option value="4">⭐⭐⭐⭐☆ 4점 (만족)</option>
                        <option value="3">⭐⭐⭐☆☆ 3점 (보통)</option>
                        <option value="2">⭐⭐☆☆☆ 2점 (불만족)</option>
                        <option value="1">⭐☆☆☆☆ 1점 (매우 불만족)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="content" class="form-label">
                        <i class="fa-solid fa-comment"></i>
                        후기 내용
                    </label>
                    <textarea id="content" class="form-textarea"
                              placeholder="구매하신 상품은 어떠셨나요? 다른 고객들에게 도움이 되는 솔직한 후기를 남겨주세요."
                              required></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="submit-btn" id="submitReviewBtn">
                        <i class="fa-solid fa-paper-plane"></i>
                        후기 등록
                    </button>
                </div>
            </form>
        </div>

        <!-- Login Required Message -->
        <div th:if="${!#authorization.expression('isAuthenticated()')}"
             style="text-align: center; padding: 2rem; background: rgba(0, 112, 243, 0.05); border-radius: var(--radius-lg); border: 1px solid rgba(0, 112, 243, 0.1);">
            <i class="fa-solid fa-lock" style="font-size: 2rem; color: var(--primary); margin-bottom: 1rem;"></i>
            <h3 style="margin-bottom: 0.5rem;">로그인이 필요합니다</h3>
            <p style="margin-bottom: 1.5rem; color: var(--text-gray);">후기를 작성하려면 로그인해주세요.</p>
            <a th:href="@{/login}" class="action-btn btn-cart" style="display: inline-flex; flex: none;">
                <i class="fa-solid fa-right-to-bracket"></i>
                로그인하기
            </a>
        </div>
    </div>
</main>

<!-- Edit Review Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fa-solid fa-edit"></i> 리뷰 수정</h2>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editReviewForm">
                <input type="hidden" id="editReviewId" />

                <div class="edit-form-group">
                    <label for="editRating">별점</label>
                    <select id="editRating" class="edit-form-control" required>
                        <option value="5">⭐⭐⭐⭐⭐ 5점 (매우 만족)</option>
                        <option value="4">⭐⭐⭐⭐☆ 4점 (만족)</option>
                        <option value="3">⭐⭐⭐☆☆ 3점 (보통)</option>
                        <option value="2">⭐⭐☆☆☆ 2점 (불만족)</option>
                        <option value="1">⭐☆☆☆☆ 1점 (매우 불만족)</option>
                    </select>
                </div>

                <div class="edit-form-group">
                    <label for="editContent">리뷰 내용</label>
                    <textarea id="editContent" class="edit-form-control" rows="5" required></textarea>
                </div>

                <div class="edit-form-actions">
                    <button type="button" class="edit-btn-secondary" onclick="closeEditModal()">
                        <i class="fa-solid fa-times"></i> 취소
                    </button>
                    <button type="submit" class="edit-btn-primary" id="updateReviewBtn">
                        <i class="fa-solid fa-check"></i> 수정 완료
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Notification -->
<div id="notification" class="notification">
    <span id="notificationText"></span>
</div>

<!-- JavaScript -->
<script th:inline="javascript">
    const currentMemberId = /*[[${#authorization.expression('isAuthenticated()') ? #authentication.principal.member.id : 0}]]*/ 0;

    function increaseQuantity() {
        const input = document.getElementById('quantityInput');
        const cartQuantity = document.getElementById('cartQuantity');
        const max = parseInt(input.getAttribute('max'));
        const current = parseInt(input.value);

        if (current < max) {
            const newValue = current + 1;
            input.value = newValue;
            cartQuantity.value = newValue;
        }
    }

    function decreaseQuantity() {
        const input = document.getElementById('quantityInput');
        const cartQuantity = document.getElementById('cartQuantity');
        const current = parseInt(input.value);

        if (current > 1) {
            const newValue = current - 1;
            input.value = newValue;
            cartQuantity.value = newValue;
        }
    }

    function getCsrfToken() {
        return document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    }

    function getCsrfHeader() {
        return document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
    }

    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');

        notificationText.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${message}`;
        notification.className = `notification ${type}`;
        notification.classList.add('show');

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    function confirmAddToCart() {
        const quantity = document.getElementById('quantityInput').value;
        showNotification(`${quantity}개의 상품을 장바구니에 담고 있습니다...`, 'success');
        return true;
    }

    function confirmAddToWishlist() {
        showNotification('찜 목록에 추가하고 있습니다...', 'success');
        return true;
    }

    function openEditModal(reviewId, content, rating) {
        document.getElementById('editReviewId').value = reviewId;
        document.getElementById('editContent').value = content;
        document.getElementById('editRating').value = rating;

        const modal = document.getElementById('editModal');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeEditModal() {
        const modal = document.getElementById('editModal');
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
    }

    async function deleteReview(reviewId) {
        if (!confirm('정말로 이 리뷰를 삭제하시겠습니까?')) {
            return;
        }

        try {
            const response = await fetch(`/api/reviews/${reviewId}?memberId=${currentMemberId}`, {
                method: 'DELETE',
                headers: {
                    [getCsrfHeader()]: getCsrfToken()
                }
            });

            if (response.ok) {
                showNotification('리뷰가 성공적으로 삭제되었습니다.', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                const errorData = await response.json().catch(() => ({}));
                showNotification('리뷰 삭제에 실패했습니다: ' + (errorData.message || '서버 오류'), 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('리뷰 삭제 중 오류가 발생했습니다.', 'error');
        }
    }

    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target === modal) {
            closeEditModal();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const reviewForm = document.getElementById('reviewForm');
        if (reviewForm) {
            reviewForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const content = document.getElementById('content').value.trim();
                const rating = document.getElementById('rating').value;
                const orderId = document.getElementById('orderId').value;
                const orderDetailId = document.getElementById('orderDetailId').value;
                const memberId = document.getElementById('memberId').value;

                if (content.length < 10) {
                    showNotification('리뷰 내용을 최소 10자 이상 작성해주세요.', 'error');
                    return;
                }

                const requestData = {
                    orderId: orderId ? parseInt(orderId) : 0,
                    orderDetailId: orderDetailId ? parseInt(orderDetailId) : null,
                    memberId: parseInt(memberId),
                    content: content,
                    rating: parseInt(rating)
                };

                const submitBtn = document.getElementById('submitReviewBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 등록 중...';

                try {
                    const response = await fetch('/api/reviews', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [getCsrfHeader()]: getCsrfToken()
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (response.ok) {
                        showNotification('리뷰가 성공적으로 등록되었습니다.', 'success');
                        reviewForm.reset();
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        showNotification('리뷰 등록에 실패했습니다: ' + (errorData.message || '서버 오류'), 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('리뷰 등록 중 오류가 발생했습니다.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });
        }

        const editForm = document.getElementById('editReviewForm');
        if (editForm) {
            editForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const reviewId = document.getElementById('editReviewId').value;
                const content = document.getElementById('editContent').value.trim();
                const rating = document.getElementById('editRating').value;

                if (content.length < 10) {
                    showNotification('리뷰 내용을 최소 10자 이상 작성해주세요.', 'error');
                    return;
                }

                const requestData = {
                    memberId: currentMemberId,
                    content: content,
                    rating: parseInt(rating)
                };

                const updateBtn = document.getElementById('updateReviewBtn');
                const originalText = updateBtn.innerHTML;
                updateBtn.disabled = true;
                updateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 수정 중...';

                try {
                    const response = await fetch(`/api/reviews/${reviewId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            [getCsrfHeader()]: getCsrfToken()
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (response.ok) {
                        showNotification('리뷰가 성공적으로 수정되었습니다.', 'success');
                        closeEditModal();
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        showNotification('리뷰 수정에 실패했습니다: ' + (errorData.message || '서버 오류'), 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('리뷰 수정 중 오류가 발생했습니다.', 'error');
                } finally {
                    updateBtn.disabled = false;
                    updateBtn.innerHTML = originalText;
                }
            });
        }
    });
</script>
</body>
</html>