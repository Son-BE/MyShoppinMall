<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${item.itemName} + ' - 상품 상세'">상품 상세 | SonStarMall</title>

    <!-- Font Awesome & Google Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          crossorigin="anonymous"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/item_detail.css">

    <!-- CSRF 토큰 메타 -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <style>
        .review-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .review-action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .review-edit-btn {
            background: linear-gradient(135deg, #0070f3, #0051cc);
            color: white;
        }

        .review-delete-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .review-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .review-action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Edit Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 2rem;
        }

        .edit-form-group {
            margin-bottom: 1.5rem;
        }

        .edit-form-group label {
            display: block;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
        }

        .edit-form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .edit-form-control:focus {
            outline: none;
            border-color: #0070f3;
            box-shadow: 0 0 0 3px rgba(0, 112, 243, 0.1);
        }

        textarea.edit-form-control {
            resize: vertical;
            min-height: 120px;
        }

        .edit-form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }

        .edit-btn-secondary {
            background: #f1f5f9;
            color: #1a1a1a;
            border: 2px solid #e2e8f0;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-btn-secondary:hover {
            background: #e2e8f0;
        }

        .edit-btn-primary {
            background: linear-gradient(135deg, #0070f3, #0051cc);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 112, 243, 0.3);
        }

        /* My Review Indicator */
        .my-review-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, rgba(0, 112, 243, 0.1), rgba(124, 58, 237, 0.1));
            color: #0070f3;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
    </style>
</head>

<body>
<!-- Header (동일하게 유지) -->
<header>
    <div class="header-container">
        <div class="top-bar">
            <h2 class="logo" th:onclick="|window.location.href='/items'|" tabindex="0" role="button" aria-label="홈으로 이동">
                SonStarMall
            </h2>

            <div class="user-info">
                <div th:if="${#authorization.expression('isAuthenticated()')}" class="user-info">
                    <span class="user-name" th:text="${#authentication.name} + '님'"></span>

                    <a th:href="@{/members/profile}" class="auth-button logout-button" aria-label="프로필 페이지 이동">
                        <i class="fa-solid fa-user"></i>
                        내 정보
                    </a>

                    <form th:action="@{/logout}" method="post" style="display:inline;">
                        <div th:if="${_csrf != null}">
                            <input type="hidden"
                                   th:name="${_csrf.parameterName}"
                                   th:value="${_csrf.token}" />
                        </div>
                        <button type="submit" class="auth-button logout-button" aria-label="로그아웃">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            로그아웃
                        </button>
                    </form>
                </div>

                <div th:if="${!#authorization.expression('isAuthenticated()')}">
                    <a th:href="@{/login}" class="auth-button login-button" aria-label="로그인">
                        <i class="fa-solid fa-right-to-bracket"></i>
                        로그인
                    </a>
                </div>
            </div>
        </div>

        <nav class="main-nav">
            <a href="/items" class="nav-link">
                <i class="fa-solid fa-house"></i>
                Home
            </a>
            <a href="/user/cart" class="nav-link">
                <i class="fa-solid fa-cart-shopping"></i>
                장바구니
            </a>
            <a href="/user/wishList" class="nav-link">
                <i class="fa-solid fa-heart"></i>
                찜 목록
            </a>
            <a href="/orders/myOrder" class="nav-link">
                <i class="fa-solid fa-book"></i>
                주문 내역
            </a>
            <a href="/board?category=NOTICE" class="nav-link">
                <i class="fa-solid fa-comments"></i>
                게시판
            </a>
        </nav>
    </div>
</header>

<!-- Main Content -->
<main class="main-content">
    <!-- Product Container (동일하게 유지) -->
    <div class="product-container">
        <div class="product-layout">
            <!-- Product Image -->
            <div class="image-section">
                <img class="product-image" th:src="${item.imagePath}" th:alt="${item.itemName} + ' 상품 이미지'"
                     onerror="this.onerror=null;this.src='/images/default.png';"/>
                <div class="image-overlay"></div>
            </div>

            <!-- Product Info -->
            <div class="info-section">
                <h1 class="product-title" th:text="${item.itemName}">상품명</h1>
                <div class="product-price" th:text="'₩' + ${#numbers.formatInteger(item.price, 3, 'COMMA')}">₩0</div>
                <p class="product-description" th:text="${item.itemComment}">상품 설명</p>

                <div class="product-meta">
                    <div class="meta-item">
                        <div class="meta-label">카테고리</div>
                        <div class="meta-value" th:text="${item.subCategory}">카테고리</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">성별</div>
                        <div class="meta-value" th:text="${item.gender}">성별</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">재고</div>
                        <div class="meta-value" th:text="${item.quantity} + '개'">0개</div>
                    </div>
                </div>

                <div th:if="${item.quantity == 0}" class="sold-out-badge">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    품절된 상품입니다
                </div>

                <!-- Quantity Selection -->
                <div th:if="${item.quantity > 0}" class="quantity-section">
                    <span class="quantity-label">수량</span>
                    <div class="quantity-control">
                        <button type="button" class="quantity-btn" onclick="decreaseQuantity()">
                            <i class="fa-solid fa-minus"></i>
                        </button>
                        <input type="number" id="quantityInput" class="quantity-input" min="1"
                               th:max="${item.quantity}" value="1" readonly/>
                        <button type="button" class="quantity-btn" onclick="increaseQuantity()">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="product-actions">
                    <!-- Add to Cart -->
                    <form th:action="@{/user/cart/add}" method="post" onsubmit="return confirmAddToCart()" style="flex: 1;">
                        <input type="hidden" name="itemId" th:value="${item.id}"/>
                        <input type="hidden" name="quantity" id="cartQuantity" value="1"/>
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="action-btn btn-cart" th:disabled="${item.quantity == 0}">
                            <i class="fa-solid fa-cart-plus"></i>
                            장바구니 담기
                        </button>
                    </form>

                    <!-- Add to Wishlist -->
                    <form th:action="@{/wishList/add}" method="post" onsubmit="return confirmAddToWishlist()" style="flex: 1;">
                        <input type="hidden" name="itemId" th:value="${item.id}"/>
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="action-btn btn-wishlist" th:disabled="${item.quantity == 0}">
                            <i class="fa-solid fa-heart"></i>
                            찜하기
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="reviews-section">
        <h2 class="section-title">
            <i class="fa-solid fa-star"></i>
            상품 후기
        </h2>

        <!-- Rating Summary -->
        <div class="rating-summary">
            <div class="rating-stars"
                 th:text="${'★'.repeat(T(java.lang.Math).round(averageRating)) + '☆'.repeat(5 - T(java.lang.Math).round(averageRating))}">
                ★★★★☆
            </div>
            <div>
                <div class="rating-score" th:text="${#numbers.formatDecimal(averageRating, 1, 1)}">4.2</div>
                <div class="rating-text">/ 5.0 점</div>
            </div>
        </div>

        <!-- Reviews List -->
        <ul class="reviews-list" id="reviewsList">
            <li class="review-item" th:each="review : ${reviews}"
                th:attr="data-review-id=${review.id}, data-member-id=${review.member.id}">
                <div class="review-header">
                    <div class="reviewer-info">
                        <span class="reviewer-name" th:text="${review.member.nickName}">홍길동</span>
                        <span th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.member.id == review.member.id}"
                              class="my-review-badge">
                            <i class="fa-solid fa-user-check"></i>
                            내 리뷰
                        </span>
                        <div class="review-rating">
                            <span th:each="i : ${#numbers.sequence(1, 5)}"
                                  th:text="${i <= review.rating ? '★' : '☆'}"></span>
                        </div>
                    </div>
                    <span class="review-date" th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd')}">2025-01-01</span>
                </div>
                <p class="review-content" th:text="${review.content}">
                    아주 만족스러워요!
                </p>

                <!-- Action Buttons (본인의 리뷰인 경우만 표시) -->
                <div th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.member.id == review.member.id}"
                     class="review-actions">
                    <button type="button" class="review-action-btn review-edit-btn"
                            th:onclick="|openEditModal(${review.id}, '${review.content}', ${review.rating})|">
                        <i class="fa-solid fa-edit"></i>
                        수정
                    </button>
                    <button type="button" class="review-action-btn review-delete-btn"
                            th:onclick="|deleteReview(${review.id})|">
                        <i class="fa-solid fa-trash"></i>
                        삭제
                    </button>
                </div>
            </li>
        </ul>

        <!-- Empty Reviews State -->
        <div id="emptyReviewsState" th:if="${#lists.isEmpty(reviews)}" style="text-align: center; padding: 3rem; color: var(--text-light);">
            <i class="fa-solid fa-comment-slash" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <h3 style="margin-bottom: 0.5rem;">아직 후기가 없습니다</h3>
            <p>첫 번째 후기를 남겨보세요!</p>
        </div>

        <!-- Review Form -->
        <div class="review-form-section" th:if="${#authorization.expression('isAuthenticated()')}">
            <h3 class="form-title">
                <i class="fa-solid fa-edit"></i>
                후기 작성하기
            </h3>
            <form id="reviewForm" class="review-form">
                <input type="hidden" id="itemId" th:value="${item.id}" />
                <input type="hidden" id="memberId" th:value="${#authentication.principal.member.id}" />
                <input type="hidden" id="orderId" th:value="${orderId} ?: 0" />

                <div class="form-group">
                    <label for="orderDetailId" class="form-label">
                        <i class="fa-solid fa-box"></i>
                        주문 선택 (선택사항)
                    </label>
                    <select id="orderDetailId" class="form-select">
                        <option value="">선택 안 함</option>
                        <!-- 주문 내역이 있다면 여기에 추가 -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="rating" class="form-label">
                        <i class="fa-solid fa-star"></i>
                        별점
                    </label>
                    <select id="rating" class="form-select" required>
                        <option value="5">⭐⭐⭐⭐⭐ 5점 (매우 만족)</option>
                        <option value="4">⭐⭐⭐⭐☆ 4점 (만족)</option>
                        <option value="3">⭐⭐⭐☆☆ 3점 (보통)</option>
                        <option value="2">⭐⭐☆☆☆ 2점 (불만족)</option>
                        <option value="1">⭐☆☆☆☆ 1점 (매우 불만족)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="content" class="form-label">
                        <i class="fa-solid fa-comment"></i>
                        후기 내용
                    </label>
                    <textarea id="content" class="form-textarea"
                              placeholder="구매하신 상품은 어떠셨나요? 다른 고객들에게 도움이 되는 솔직한 후기를 남겨주세요."
                              required></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="submit-btn" id="submitReviewBtn">
                        <i class="fa-solid fa-paper-plane"></i>
                        후기 등록
                    </button>
                </div>
            </form>
        </div>

        <!-- Login Required Message -->
        <div th:if="${!#authorization.expression('isAuthenticated()')}"
             style="text-align: center; padding: 2rem; background: rgba(0, 112, 243, 0.05); border-radius: var(--radius-lg); border: 1px solid rgba(0, 112, 243, 0.1);">
            <i class="fa-solid fa-lock" style="font-size: 2rem; color: var(--primary); margin-bottom: 1rem;"></i>
            <h3 style="margin-bottom: 0.5rem;">로그인이 필요합니다</h3>
            <p style="margin-bottom: 1.5rem; color: var(--text-gray);">후기를 작성하려면 로그인해주세요.</p>
            <a th:href="@{/login}" class="action-btn btn-cart" style="display: inline-flex; flex: none;">
                <i class="fa-solid fa-right-to-bracket"></i>
                로그인하기
            </a>
        </div>
    </div>
</main>

<!-- Edit Review Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fa-solid fa-edit"></i> 리뷰 수정</h2>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editReviewForm">
                <input type="hidden" id="editReviewId" />

                <div class="edit-form-group">
                    <label for="editRating">별점</label>
                    <select id="editRating" class="edit-form-control" required>
                        <option value="5">⭐⭐⭐⭐⭐ 5점 (매우 만족)</option>
                        <option value="4">⭐⭐⭐⭐☆ 4점 (만족)</option>
                        <option value="3">⭐⭐⭐☆☆ 3점 (보통)</option>
                        <option value="2">⭐⭐☆☆☆ 2점 (불만족)</option>
                        <option value="1">⭐☆☆☆☆ 1점 (매우 불만족)</option>
                    </select>
                </div>

                <div class="edit-form-group">
                    <label for="editContent">리뷰 내용</label>
                    <textarea id="editContent" class="edit-form-control" rows="5" required></textarea>
                </div>

                <div class="edit-form-actions">
                    <button type="button" class="edit-btn-secondary" onclick="closeEditModal()">
                        <i class="fa-solid fa-times"></i> 취소
                    </button>
                    <button type="submit" class="edit-btn-primary" id="updateReviewBtn">
                        <i class="fa-solid fa-check"></i> 수정 완료
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Notification -->
<div id="notification" class="notification">
    <span id="notificationText"></span>
</div>

<!-- JavaScript -->
<script th:inline="javascript">
    const currentMemberId = /*[[${#authorization.expression('isAuthenticated()') ? #authentication.principal.member.id : 0}]]*/ 0;

    function increaseQuantity() {
        const input = document.getElementById('quantityInput');
        const cartQuantity = document.getElementById('cartQuantity');
        const max = parseInt(input.getAttribute('max'));
        const current = parseInt(input.value);

        if (current < max) {
            const newValue = current + 1;
            input.value = newValue;
            cartQuantity.value = newValue;
        }
    }

    function decreaseQuantity() {
        const input = document.getElementById('quantityInput');
        const cartQuantity = document.getElementById('cartQuantity');
        const current = parseInt(input.value);

        if (current > 1) {
            const newValue = current - 1;
            input.value = newValue;
            cartQuantity.value = newValue;
        }
    }

    function getCsrfToken() {
        return document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    }

    function getCsrfHeader() {
        return document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
    }
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');

        notificationText.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${message}`;
        notification.className = `notification ${type}`;
        notification.classList.add('show');

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    function confirmAddToCart() {
        const quantity = document.getElementById('quantityInput').value;
        showNotification(`${quantity}개의 상품을 장바구니에 담고 있습니다...`, 'success');
        return true;
    }

    function confirmAddToWishlist() {
        showNotification('찜 목록에 추가하고 있습니다...', 'success');
        return true;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const reviewForm = document.getElementById('reviewForm');
        if (reviewForm) {
            reviewForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const content = document.getElementById('content').value.trim();
                const rating = document.getElementById('rating').value;
                const orderId = document.getElementById('orderId').value;
                const orderDetailId = document.getElementById('orderDetailId').value;
                const memberId = document.getElementById('memberId').value;

                if (content.length < 10) {
                    showNotification('리뷰 내용을 최소 10자 이상 작성해주세요.', 'error');
                    return;
                }

                const requestData = {
                    orderId: orderId ? parseInt(orderId) : 0,
                    orderDetailId: orderDetailId ? parseInt(orderDetailId) : null,
                    memberId: parseInt(memberId),
                    content: content,
                    rating: parseInt(rating)
                };

                const submitBtn = document.getElementById('submitReviewBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 등록 중...';

                try {
                    const response = await fetch('/api/reviews', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [getCsrfHeader()]: getCsrfToken()
                        },
                        body: JSON.stringify(requestData)
                    });

                    document.addEventListener('keydown', function(e) {
                        // Escape key to close modal
                        if (e.key === 'Escape') {
                            const editModal = document.getElementById('editModal');
                            if (editModal && editModal.classList.contains('show')) {
                                closeEditModal();
                            }
                        }
                    });

                    function validateReviewContent(content) {
                        if (!content || content.trim().length < 10) {
                            showNotification('리뷰 내용을 최소 10자 이상 작성해주세요.', 'error');
                            return false;
                        }
                        if (content.trim().length > 1000) {
                            showNotification('리뷰 내용은 1000자를 초과할 수 없습니다.', 'error');
                            return false;
                        }
                        return true;
                    }

                    function addCharacterCounter(textareaId, maxLength = 1000) {
                        const textarea = document.getElementById(textareaId);
                        if (!textarea) return;

                        const counter = document.createElement('div');
                        counter.style.cssText = `
            text-align: right;
            font-size: 0.875rem;
            color: #666;
            margin-top: 0.5rem;
        `;
                        textarea.parentElement.appendChild(counter);

                        function updateCounter() {
                            const length = textarea.value.length;
                            counter.textContent = `${length} / ${maxLength}자`;
                            counter.style.color = length > maxLength ? '#ef4444' : '#666';
                        }

                        textarea.addEventListener('input', updateCounter);
                        updateCounter();
                    }

                    document.addEventListener('DOMContentLoaded', function() {
                        addCharacterCounter('content', 1000);
                        addCharacterCounter('editContent', 1000);
                    });

                    if (response.ok) {
                        showNotification('리뷰가 성공적으로 등록되었습니다.', 'success');
                        reviewForm.reset();
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        showNotification('리뷰 등록에 실패했습니다: ' + (errorData.message || '서버 오류'), 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('리뷰 등록 중 오류가 발생했습니다.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });
        }
    });

    function openEditModal(reviewId, content, rating) {
        document.getElementById('editReviewId').value = reviewId;
        document.getElementById('editContent').value = content;
        document.getElementById('editRating').value = rating;

        const modal = document.getElementById('editModal');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeEditModal() {
        const modal = document.getElementById('editModal');
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
    }

    document.addEventListener('DOMContentLoaded', function() {
        const editForm = document.getElementById('editReviewForm');
        if (editForm) {
            editForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const reviewId = document.getElementById('editReviewId').value;
                const content = document.getElementById('editContent').value.trim();
                const rating = document.getElementById('editRating').value;

                if (content.length < 10) {
                    showNotification('리뷰 내용을 최소 10자 이상 작성해주세요.', 'error');
                    return;
                }

                const requestData = {
                    memberId: currentMemberId,
                    content: content,
                    rating: parseInt(rating)
                };

                const updateBtn = document.getElementById('updateReviewBtn');
                const originalText = updateBtn.innerHTML;
                updateBtn.disabled = true;
                updateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 수정 중...';

                try {
                    const response = await fetch(`/api/reviews/${reviewId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            [getCsrfHeader()]: getCsrfToken()
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (response.ok) {
                        showNotification('리뷰가 성공적으로 수정되었습니다.', 'success');
                        closeEditModal();
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        showNotification('리뷰 수정에 실패했습니다: ' + (errorData.message || '서버 오류'), 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('리뷰 수정 중 오류가 발생했습니다.', 'error');
                } finally {
                    updateBtn.disabled = false;
                    updateBtn.innerHTML = originalText;
                }
            });
        }
    });

    async function deleteReview(reviewId) {
        if (!confirm('정말로 이 리뷰를 삭제하시겠습니까?')) {
            return;
        }

        try {
            const response = await fetch(`/api/reviews/${reviewId}?memberId=${currentMemberId}`, {
                method: 'DELETE',
                headers: {
                    [getCsrfHeader()]: getCsrfToken()
                }
            });

            if (response.ok) {
                showNotification('리뷰가 성공적으로 삭제되었습니다.', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                const errorData = await response.json().catch(() => ({}));
                showNotification('리뷰 삭제에 실패했습니다: ' + (errorData.message || '서버 오류'), 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('리뷰 삭제 중 오류가 발생했습니다.', 'error');
        }
    }

    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target === modal) {
            closeEditModal();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Handle server messages
        const successMessage = /*[[${successMessage}]]*/ null;
        const errorMessage = /*[[${errorMessage}]]*/ null;

        if (successMessage) {
            showNotification(successMessage, 'success');
        }

        if (errorMessage) {
            showNotification(errorMessage, 'error');
        }

        const productContainer = document.querySelector('.product-container');
        const reviewsSection = document.querySelector('.reviews-section');

        if (productContainer) {
            productContainer.style.opacity = '0';
            productContainer.style.transform = 'translateY(30px)';
            setTimeout(() => {
                productContainer.style.transition = 'all 0.6s ease';
                productContainer.style.opacity = '1';
                productContainer.style.transform = 'translateY(0)';
            }, 100);
        }

        if (reviewsSection) {
            reviewsSection.style.opacity = '0';
            reviewsSection.style.transform = 'translateY(30px)';
            setTimeout(() => {
                reviewsSection.style.transition = 'all 0.6s ease';
                reviewsSection.style.opacity = '1';
                reviewsSection.style.transform = 'translateY(0)';
            }, 300);
        }

        const reviewItems = document.querySelectorAll('.review-item');
        reviewItems.forEach((item, index) => {
            item.style.opacity = '0';
            item.style.transform = 'translateX(-30px)';

            setTimeout(() => {
                item.style.transition = 'all 0.5s ease';
                item.style.opacity = '1';
                item.style.transform = 'translateX(0)';
            }, 500 + (index * 100));
        });
    });

    document.querySelectorAll('.action-btn, .submit-btn, .quantity-btn, .review-action-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            if (this.disabled) return;

            const ripple = document.createElement('div');
            ripple.style.cssText = `
                position: absolute;
                border-radius: 50%;
                background: rgba(255,255,255,0.6);
                transform: scale(0);
                animation: ripple 0.6s linear;
                pointer-events: none;
            `;

            const rect = this.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
            ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';

            this.appendChild(ripple);

            setTimeout(() => {
                ripple.remove();
            }, 600);
        });
    });

    const rippleStyle = document.createElement('style');
    rippleStyle.textContent = `
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(rippleStyle);

    const textarea = document.getElementById('content');
    if (textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.max(120, this.scrollHeight) + 'px';
        });
    }

    const editTextarea = document.getElementById('editContent');
    if (editTextarea) {
        editTextarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.max(120, this.scrollHeight) + 'px';
        });
    }

    const ratingSelect = document.getElementById('rating');
    if (ratingSelect) {
        ratingSelect.addEventListener('change', function() {
            this.style.color = '#ffc107';
            this.style.fontWeight = '600';
        });
    }

    const editRatingSelect = document.getElementById('editRating');
    if (editRatingSelect) {
        editRatingSelect.addEventListener('change', function() {
            this.style.color = '#ffc107';
            this.style.fontWeight = '600';
        });
    }

    const productImage = document.querySelector('.product-image');
    if (productImage) {
        productImage.addEventListener('click', function() {
            if (this.style.transform === 'scale(1.5)') {
                this.style.transform = 'scale(1)';
                this.style.cursor = 'zoom-in';
            } else {
                this.style.transform = 'scale(1.5)';
                this.style.cursor = 'zoom-out';
            }
        });

        productImage.style.cursor = 'zoom-in';
    }

    const quantityInput = document.getElementById('quantityInput');
    if (quantityInput) {
        quantityInput.addEventListener('change', function() {
            const cartQuantity = document.getElementById('cartQuantity');
            cartQuantity.value = this.value;
        });
    }

    function scrollToReviews() {
        document.querySelector('.reviews-section').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }

    let notificationTimeout;
    window.addEventListener('scroll', () => {
        const notification = document.getElementById('notification');
        if (notification && notification.classList.contains('show')) {
            clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => {
                notification.classList.remove('show');
            }, 1000);
        }
    });
</script>
</body>
</html>
