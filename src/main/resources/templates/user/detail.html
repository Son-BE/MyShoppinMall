<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="_csrf" content="${_csrf.token}"/>
    <meta name="_csrf_header" content="${_csrf.headerName}"/>
    <title th:text="${item.itemName} + ' - 상품 상세'">상품 상세</title>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          integrity="sha512-dx1+2FovCWPKixmYk3xE6WKw54bo1tDUX6sZtyDPiH65JL2+lImN0YGK5wCw8uYmL5Y8ZDU3iGn8+yS+jc5URw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <style>
        body {
            font-family: sans-serif;
            background-color: #fff8f3;
            color: #4e342e;
            margin: 0;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            background-color: #fff3e0;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(255, 138, 101, 0.2);
        }

        .image-section img {
            width: 100%;
            max-height: 500px;
            object-fit: cover;
            border-radius: 8px;
        }

        .info-section {
            margin-top: 1.5rem;
        }

        .info-section h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .info-section p.price {
            font-size: 1.5rem;
            color: #d84315;
            margin: 0.5rem 0;
        }

        .info-section p.description {
            margin-top: 1rem;
        }

        .extra-info {
            margin-top: 1rem;
            font-size: 0.95rem;
            color: #6d4c41;
        }

        .sold-out {
            color: red;
            font-weight: bold;
            margin-top: 1rem;
        }

        .actions {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
        }

        .actions form button,
        .actions a {
            background-color: #ffcc80;
            color: black;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
        }

        .actions form button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .actions .wish-btn {
            background-color: #ffcc80;
        }

        .actions .wish-btn:hover {
            background-color: #de9120;
        }
    </style>
</head>
<body>
<div th:insert="~{fragment/header :: header}"></div>

<div class="container">
    <div class="image-section">
        <img th:src="${item.imagePath[0]}" alt="상품 이미지"
             onerror="this.onerror=null;this.src='/images/default-image.png';"/>
    </div>

    <div class="info-section">
        <h1 th:text="${item.itemName}">상품명</h1>
        <p class="price" th:text="'₩' + ${#numbers.formatInteger(item.price, 3, 'COMMA')}">가격</p>
        <p class="description" th:text="${item.itemComment}">상품 설명</p>

        <div class="extra-info">
            <p>카테고리: <span th:text="${item.subCategory}">카테고리</span></p>
            <p>성별: <span th:text="${item.gender}">성별</span></p>
            <p>재고 수량: <span th:text="${item.quantity}">0</span></p>
        </div>

        <div th:if="${item.quantity == 0}" class="sold-out">품절된 상품입니다.</div>
    </div>

    <div class="actions">
        <!-- 장바구니 등록 -->
        <form id="addCartForm"
              th:action="@{/carts/add}"
              method="post"
              onsubmit="return confirmAddToCart(event)">
            <input type="hidden" name="itemId" th:value="${item.id}"/>
            <label>수량:
                <input type="number" id="quantity" name="quantity" min="1" th:attr="max=${item.quantity}" value="1"
                       style="width: 60px; padding: 0.2rem;" th:disabled="${item.quantity == 0}"/>
            </label>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" th:disabled="${item.quantity == 0}">
                <i class="fa-solid fa-cart-plus"></i> 장바구니 추가
            </button>
        </form>

        <!-- 찜 등록 -->
        <form id="addWishListForm"
              onsubmit="return confirmAddToWishList(event)">
            <input type="hidden" name="itemId" th:value="${item.id}"/>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" th:disabled="${item.quantity == 0}" class="wish-btn">
                <i id="wish-icon" class="fa-regular fa-heart"></i> 찜하기
            </button>
        </form>

    </div>
</div>

<script>
    async function confirmAddToCart(event) {
        event.preventDefault();

        if (!confirm("장바구니에 추가하시겠습니까?")) {
            return false;
        }

        const form = event.target;
        const formData = new FormData(form);

        try {
            const response = await fetch(form.action, {
                method: form.method,
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.ok) {
                window.location.href = "/mainPage?added=true";
                alert("장바구니에 상품이 추가되었습니다.")
            } else {
                alert("장바구니 추가 중 오류가 발생했습니다.");
            }
        } catch (error) {
            alert("네트워크 오류가 발생했습니다.");
        }
    }

    async function confirmAddToWishList(event) {
        event.preventDefault();

        if (!confirm("찜목록에 추가하시겠습니까?")) {
            return false;
        }

        const form = event.target;
        const formData = new FormData(form);
        const itemId = formData.get("itemId");
        const icon = document.getElementById("wish-icon");

        try {
            const response = await fetch(`/api/wishList/toggle/${itemId}`, {
                method: "POST",
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRF-TOKEN': form.querySelector('input[name="_csrf"]').value
                }
            });

            if (response.ok) {
                const result = await response.json();
                if (!result.isWished) {
                    icon.classList.remove("fa-regular");
                    icon.classList.add("fa-solid");
                    alert("찜 목록에 추가되었습니다.");
                } else {
                    icon.classList.remove("fa-solid");
                    icon.classList.add("fa-regular");
                    alert("찜 목록에서 제거 되었습니다.");
                }
            } else {
                alert("찜 처리 중 오류가 발생했습니다.");
            }
        } catch (error) {
            alert("네트워크 오류가 발생했습니다.");
        }
    }
</script>

<div th:insert="~{fragment/footer :: footer}"></div>
</body>
</html>
