<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>장바구니</title>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          integrity="sha512-dx1+2FovCWPKixmYk3xE6WKw54bo1tDUX6sZtyDPiH65JL2+lImN0YGK5wCw8uYmL5Y8ZDU3iGn8+yS+jc5URw=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: sans-serif;
            background-color: #fff8f3;
            color: #4e342e;
            margin: 0;
            padding: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }
        th, td {
            border-bottom: 1px solid #d7ccc8;
            padding: 0.8rem;
            text-align: center;
        }
        th {
            background-color: #ffe5d0;
            color: #4e342e;
        }
        td img {
            width: 150px;
            height: 190px;
            object-fit: cover;
            border-radius: 6px;
        }
        .quantity-input {
            width: 50px;
            text-align: center;
        }
        .btn {
            background-color: #ffb74d;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .btn:hover {
            background-color: #ffa726;
        }
        .btn-delete {
            background-color: #ef5350;
        }
        .btn-delete:hover {
            background-color: #e53935;
        }
        .total {
            font-weight: bold;
            font-size: 1.3rem;
            text-align: right;
            margin-bottom: 1rem;
        }
        .order-btn {
            display: block;
            width: 100%;
            max-width: 200px;
            background-color: #4caf50;
            color: white;
            padding: 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            text-align: center;
            text-decoration: none;
        }
        .order-btn:hover {
            background-color: #388e3c;
        }

        .clear-btn {
            display: block;
            width: 100%;
            max-width: 200px;
            background-color: #ef5350;
            color: white;
            padding: 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            text-align: center;
            text-decoration: none;
        }
        .clear-btn:hover {
            background-color: #e53935;
        }
        .button-container {
            display: flex;
            justify-content: flex-end;
            gap: 1px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>

<div th:insert="~{fragment/header :: header}"></div>

<h1>장바구니</h1>

<table>
    <thead>
    <tr>
        <th>상품 이미지</th>
        <th>상품명</th>
        <th>가격</th>
        <th>수량</th>
        <th>합계</th>
        <th>삭제</th>
    </tr>
    </thead>
    <tbody id="cart-body">
    </tbody>
</table>

<div class="total">
    총 합계: <span id="total-price">₩0</span>
</div>

<div class="button-container">
    <button class="order-btn" onclick="location.href='/order'">주문하기</button>
    <button class="clear-btn" onclick="clearCart()">장바구니 비우기</button>
</div>


<div th:insert="~{fragment/footer :: footer}"></div>

<script>
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    function formatPrice(num) {
        return '₩' + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    async function fetchCartItems() {
        try {
            const res = await fetch('/carts');
            if (!res.ok) throw new Error();
            const cartItems = await res.json();
            renderCartItems(cartItems);
        } catch (e) {
            alert('장바구니 정보를 불러오는데 실패했습니다.');
        }
    }

    function renderCartItems(items) {
        const tbody = document.getElementById('cart-body');
        tbody.innerHTML = '';

        let totalPrice = 0;

        items.forEach(item => {
            const subtotal = item.price * item.quantity;
            totalPrice += subtotal;

            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td><img src="${item.imagePath ? item.imagePath : '/images/default-item.png'}" alt="상품 이미지" onerror="this.onerror=null;this.src='/images/default-image.png';" /></td>
            <td>${item.itemName}</td>
            <td>${formatPrice(item.price)}</td>
            <td>
                <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="${item.quantity}"
                       onchange="onQuantityChange(${item.cartItemId}, this)" />
            </td>
            <td>${formatPrice(subtotal)}</td>
            <td>
                <button class="btn btn-delete" onclick="removeItem(${item.cartItemId})">
                    <i class="fa-solid fa-trash"></i> 삭제
                </button>
            </td>
        `;
            tbody.appendChild(tr);
        });

        document.getElementById('total-price').innerText = formatPrice(totalPrice);
    }

    function onQuantityChange(cartItemId, inputElement) {
        let value = parseInt(inputElement.value);
        const min = parseInt(inputElement.min);
        const max = parseInt(inputElement.max);

        if (isNaN(value) || value < min) {
            alert(`수량은 최소 ${min} 개 이상이어야 합니다.`);
            inputElement.value = min;
            value = min;
        } else if (value > max) {
            alert(`현재 재고 수량은 ${max}개 입니다.`);
            inputElement.value = max;
            value = max;
        }

        updateQuantity(cartItemId, value);
    }

    async function updateQuantity(cartItemId, quantity) {
        try {
            const res = await fetch(`/carts/update/${cartItemId}?quantity=${quantity}`, {
                method: 'PUT',
                headers: {
                    [csrfHeader]: csrfToken
                }
            });
            if (res.ok) {
                fetchCartItems();
            } else {
                alert('수량 변경에 실패했습니다.');
            }
        } catch (e) {
            alert('수량 변경 요청 중 오류가 발생했습니다.');
        }
    }

    async function removeItem(cartItemId) {
        if (!confirm('정말로 이 아이템을 삭제하시겠습니까?')) return;

        try {
            const res = await fetch(`/carts/remove/${cartItemId}`, {
                method: 'DELETE',
                headers: {
                    [csrfHeader]: csrfToken
                }
            });
            if (res.ok) {
                fetchCartItems();
            } else {
                alert('아이템 삭제에 실패했습니다.');
            }
        } catch (e) {
            alert('삭제 요청 중 오류가 발생했습니다.');
        }
    }

    async function clearCart() {
        if (!confirm('장바구니를 비우시겠습니까?')) return;

        try {
            const res = await fetch('/carts/clear', {
                method: 'DELETE',
                headers: {
                    [csrfHeader]: csrfToken
                }
            });
            if (res.ok) {
                fetchCartItems();
            } else {
                alert('장바구니 비우기에 실패했습니다.');
            }
        } catch (e) {
            alert('비우기 요청 중 오류가 발생했습니다.');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchCartItems();
    });
</script>

</body>
</html>
